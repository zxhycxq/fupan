# Task: 为考试记录列表添加星级列，修改期数为考试名称和索引号

## Plan
- [x] Step 1: 创建数据库迁移文件，添加 rating、exam_name 和 index_number 字段
- [x] Step 2: 应用数据库迁移，设置约束和索引
- [x] Step 3: 更新 ExamRecord 类型定义，添加新字段
- [x] Step 4: 更新 UploadFormData 和其他相关类型
- [x] Step 5: 添加 API 函数：updateExamRating、checkIndexNumberExists、updateExamIndexNumber、getNextIndexNumber
- [x] Step 6: 修改 getAllExamRecords 函数，按索引号排序
- [x] Step 7: 更新 Upload 页面，将期数改为考试名称和索引号
- [x] Step 8: 修改 ExamList 页面，添加星级列
- [x] Step 9: 修改 ExamDetail 页面，显示考试名称和索引
- [x] Step 10: 修改 Dashboard 页面，更新图表显示
- [x] Step 11: 修复 dataParser.ts 和 generateTestData.ts 的类型错误
- [x] Step 12: 运行 lint 检查
- [x] Step 13: 优化列宽和布局
  - [x] 缩小总分、平均分、击败率列宽（90px）
  - [x] 星级列移到倒数第二列
  - [x] 星级列设置最小宽度150px
  - [x] 操作列固定在右侧
  - [x] 添加横向滚动支持
- [x] Step 14: 将内联编辑改为抽屉形式
  - [x] 移除内联编辑逻辑
  - [x] 添加 Drawer 组件
  - [x] 使用 Form 组件管理表单
  - [x] 添加移动端响应式支持
  - [x] 修复焦点问题
- [x] Step 15: 在历次考试各模块详细数据表中添加用时列
  - [x] 修改 getModuleDetailedStats API，添加 time_used 字段
  - [x] 更新 Dashboard 数据类型定义
  - [x] 在表格列中添加用时显示（仅大模块）
  - [x] 在总计行中计算总用时
  - [x] 将秒转换为分钟显示
- [x] Step 16: 添加导出 Excel 功能
  - [x] 安装 xlsx 库
  - [x] 实现导出函数
  - [x] 添加导出按钮
  - [x] 包含所有数据（主模块和子模块）
  - [x] 使用考试名称作为列标题
- [x] Step 17: 修改备注功能
  - [x] 添加数据库字段 improvements 和 mistakes
  - [x] 更新类型定义
  - [x] 添加 updateExamNotes API 函数
  - [x] 修改详情页备注显示为两列布局
  - [x] 修改详情页编辑对话框为两个输入框
  - [x] 在考试记录列表添加备注列
  - [x] 添加两个图标按钮（进步和错误）
  - [x] 点击图标弹窗显示对应内容
- [x] Step 18: 添加用时超时警告功能
  - [x] 在详情页添加用时超时检测
  - [x] 显示警告提示和建议
  - [x] 添加视觉标识（红色边框）
- [x] Step 19: 添加考试日历模块
  - [x] 在Dashboard页面添加日历组件
  - [x] 按日期显示考试记录
  - [x] 不同分数段用不同颜色标识
  - [x] 鼠标悬停显示考试信息
  - [x] 点击跳转到详情页
  - [x] 添加颜色图例说明
- [x] Step 20: 优化用时编辑功能
  - [x] 将用时输入改为整数分钟
  - [x] 步进值设置为1分钟
  - [x] 添加输入验证，只允许整数
  - [x] 简化显示格式
- [x] Step 21: 排查并修复数据同步问题
  - [x] 添加上传页面数据保存日志
  - [x] 添加Dashboard数据加载日志
  - [x] 添加模块数量和列表输出
  - [x] 用户测试：上传新记录，查看日志
  - [x] 定位问题原因：使用了exam_number而不是index_number
  - [x] 修复数据查询，使用index_number
  - [x] 在表头添加考试名称和日期显示

## 已解决问题

### 数据同步问题（已修复）
**问题描述：**
首页"历次考试各模块详细数据表"的数据数量与考试记录列表不一致，且表头没有显示考试日期。

**问题原因：**
1. 考试记录列表显示的是 `index_number`（用户设置的索引号）
2. Dashboard的模块详细数据表使用的是 `exam_number`（内部编号）进行查询
3. 两个字段的值不同，导致显示的期数不一致
4. 表头只显示期数，没有显示考试名称和日期

**解决方案：**
1. 修改 `getModuleDetailedStats` 函数：
   - 使用 `index_number` 而不是 `exam_number` 进行查询和排序
   - 同时获取 `exam_name` 和 `exam_date` 字段
   - 确保返回所有考试记录的模块数据

2. 修改 Dashboard 页面：
   - 创建 `examInfoMap` 映射，存储每个期数的名称和日期
   - 表头格式改为：`考试名称 - 考试日期`
   - 如果没有日期，只显示考试名称
   - 更新类型定义，包含新增字段

**最终效果：**
- 所有8条考试记录的模块数据都正确显示
- 表头显示完整信息，例如：`第33期 - 2025-11-18`
- 数据按照 `index_number` 排序，与考试记录列表完全一致

**修改文件：**
- `/workspace/app-7q11e4xackch/src/db/api.ts` - getModuleDetailedStats函数
- `/workspace/app-7q11e4xackch/src/pages/Dashboard.tsx` - 表头显示逻辑

## Notes
- 星级功能使用 Ant Design 的 Rate 组件，支持半星，范围 0-5
- 索引号用于排序，设置唯一约束，不能重复
- 考试名称替代原来的期数概念
- 所有相关页面都已更新以使用新的字段
- 数据库迁移已成功应用
- 所有类型定义已更新
- Lint 检查通过，无错误
- 列布局已优化，星级列在倒数第二列，操作列固定
- 编辑功能已改为抽屉形式，提供更好的用户体验
- 移动端响应式已实现，抽屉在移动端全屏显示
- 用时列仅显示在大模块（6大模块）上，子模块不显示
- 用时以分钟为单位显示，保留1位小数
- Excel 导出功能包含所有模块数据，使用考试名称作为列标题
- 导出的文件名包含当前日期
- 备注功能分为两部分：有进步的地方（绿色）和出错的地方（红色）
- 详情页使用两列布局展示备注
- 列表页使用两个图标按钮，有内容时高亮显示
- 点击图标弹窗显示完整内容

## Completed
1. 数据库添加了 rating、exam_name 和 index_number 字段
2. 添加了相关的 API 函数
3. Upload 页面支持输入考试名称和索引号
4. ExamList 页面添加了星级列，可以直接点击星星评分
5. ExamList 页面将期数改为索引号和考试名称
6. ExamDetail 页面显示考试名称和索引号
7. Dashboard 页面的图表使用考试名称
8. 所有相关文件的类型定义已更新
9. Lint 检查通过
10. 列布局优化完成：
    - 总分、平均分、击败率列宽缩小到90px
    - 星级列移到倒数第二列，宽度150px
    - 操作列固定在右侧
    - 添加横向滚动支持
11. 编辑功能改为抽屉形式：
    - 移除了表格内联编辑
    - 使用 Drawer + Form 组件
    - 完善的表单验证
    - 移动端全屏显示
    - 桌面端固定宽度480px
    - 响应式布局适配
12. 历次考试各模块详细数据表添加用时列：
    - API 返回 time_used 字段（秒）
    - 表格显示用时列（分钟，保留1位小数）
    - 仅大模块显示用时，子模块不显示
    - 总计行计算所有大模块的总用时
13. Excel 导出功能：
    - 安装并集成 xlsx 库
    - 实现完整的导出逻辑
    - 导出包含所有主模块和子模块数据
    - 使用考试名称作为列标题
    - 子模块名称前添加缩进标识
    - 文件名包含当前日期
    - 添加导出按钮到表格标题栏
14. 备注功能优化：
    - 数据库添加 improvements 和 mistakes 字段
    - 添加 updateExamNotes API 函数
    - 详情页改为两列布局显示备注
    - 编辑对话框改为两个独立输入框
    - 列表页添加备注列，包含两个图标按钮
    - 有内容时图标高亮显示（绿色/红色）
    - 点击图标弹窗显示完整内容
    - 弹窗使用对应的颜色主题
