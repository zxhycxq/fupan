# 更新日志

## 2025-11-22 - 添加详细统计信息和用户设置功能

### 新增功能
- ✨ **用户设置表**: 创建user_settings表存储目标正确率
  - 支持6大模块的目标设置
  - 默认目标80%
  - 支持多用户扩展
  
- ✨ **扩展考试记录字段**:
  - 添加难度系数字段(difficulty, 0-5)
  - 添加击败百分比字段(beat_percentage, 0-100)
  
- ✨ **详情页面增强**:
  - 显示难度系数(带颜色标识)
  - 显示击败百分比(带颜色标识)
  - 显示最高分
  - 优化用时显示格式(分:秒)
  - 响应式6列布局

### API扩展
- 🔧 添加getUserSettings() - 获取用户设置
- 🔧 添加upsertUserSetting() - 更新单个设置
- 🔧 添加batchUpsertUserSettings() - 批量更新设置

### 数据解析增强
- ⚡ 提取难度系数
- ⚡ 提取击败考生百分比
- ⚡ 提取平均分
- ⚡ 提取最高分

### 类型定义完善
- 📝 添加UserSetting类型
- 📝 添加RecognitionConfirmData类型
- 📝 扩展ExamRecord类型

### 计划功能
- 🚧 识别确认功能(识别后可编辑确认)
- 🚧 全局设置页面(设置各模块目标正确率)
- 🚧 雷达图改进(显示实际与目标对比)

## 2025-11-22 - 修复React版本冲突问题

### 问题修复
- 🐛 **修复React版本冲突**: 解决"Cannot read properties of null"错误
  - 将React从18.0.0升级到18.3.1
  - 将React DOM从18.0.0升级到18.3.1
  - 将@types/react从19.2.2降级到18.3.12
  - 将@types/react-dom从19.2.2降级到18.3.1
  - 将react-router从7.9.5降级到6.28.0
  - 将react-router-dom从7.9.5降级到6.28.0
  - 确保所有React相关包版本一致

### 技术说明
- React 18.3.1是当前稳定版本
- React Router v6是与React 18兼容的稳定版本
- 类型定义必须与React版本匹配

## 2025-11-22 - 添加时间编辑功能和优化时间记录

### 新功能
- ✨ **时间编辑功能**: 用户可以手动编辑6大模块的用时
  - 在详情页面每个模块的用时旁边添加编辑按钮
  - 点击编辑按钮打开对话框,输入新的用时(秒)
  - 实时更新数据库和页面显示
  - 支持输入验证,确保时间为有效数值

### 优化改进
- ⚡ **智能时间记录**: 根据总用时自动调整记录策略
  - 总用时 ≥ 10分钟: 记录所有模块(一级、二级、三级)的时间
  - 总用时 < 10分钟: 只记录一级和二级模块时间,三级模块时间设为0
  - 减少不必要的数据记录,提高数据质量

### 技术改进
- 🔧 添加updateModuleScore API函数
- 🔧 改进数据解析逻辑,支持条件性时间记录
- 🔧 优化详情页面UI,添加编辑交互

## 2025-11-22 - 改进数据解析和调试功能

### 重要改进
- 🔧 **增强数据解析器**: 改进OCR文本解析逻辑
  - 使用更灵活的正则表达式
  - 支持多种文本格式变化
  - 自动处理时间单位转换(分钟→秒)
  - 更好地处理中文标点符号

### 调试功能
- 🐛 **添加详细日志**: 帮助诊断解析问题
  - 显示OCR识别的原始文本
  - 显示每个字段的提取过程
  - 显示每个模块的解析状态
  - 显示最终解析结果统计
  
- 📝 **创建调试指南**: 
  - 如何查看控制台日志
  - 如何解读日志信息
  - 常见问题诊断方法
  - 问题报告指南

### 解析优化
- ⚡ **更灵活的模式匹配**:
  - 支持"总题数20题"和"总题数:20"等多种格式
  - 支持"答对15道"和"答对:15"等多种格式
  - 支持"用时28秒"和"用时:28"等多种格式
  - 自动识别时间单位(秒/分)
  
- ⚡ **更智能的数据提取**:
  - 自动计算答错数(总题数-答对数)
  - 处理缺失的字段
  - 容错性更强

### 文档更新
- 📚 新增调试指南(DEBUG_GUIDE.md)
- 📚 新增测试指南(TESTING_GUIDE.md)
- 📚 新增改进总结(IMPROVEMENTS_SUMMARY.md)
- 📚 更新故障排查指南(TROUBLESHOOTING.md)
- 📚 更新README,添加文档资源链接
- 📚 添加日志查看和问题诊断说明

### 问题修复
- 🐛 修复总分识别问题: 支持"68.8/100"等无空格格式
- 🐛 修复用时识别问题: 支持"6分36秒"等紧凑格式
- 🐛 修复模块解析失败: 改进正则表达式匹配逻辑
- 🐛 提高OCR文本解析的容错性

### 用户体验改进
- ✨ 用户可以通过控制台日志自行诊断问题
- ✨ 提供详细的调试和测试指南
- ✨ 更友好的错误提示和解决建议
- ✨ 完整的文档体系支持

## 2025-11-22 - 改用文字识别API

### 重要变更
- 🔄 **移除图像内容理解插件**: 改用通用文字识别(高精度版)API
  - 移除异步轮询逻辑
  - 改为同步直接调用
  - 提高识别速度和稳定性
  - 减少等待时间

### 技术改进
- 📝 使用通用文字识别(高精度版)API
  - API endpoint: `/api/miaoda/runtime/apicenter/source/proxy/6KmAKxK9aE29irAwt32QRk`
  - Content-Type: application/x-www-form-urlencoded
  - 支持中英文混合识别
  - 直接返回识别结果,无需轮询
  
- 📝 更新类型定义
  - 添加OcrRequest和OcrResponse类型
  - 移除ImageRecognitionRequest等旧类型
  
- 📝 简化识别流程
  - 移除submitImageRecognition和pollImageRecognitionResult
  - 新增recognizeText函数,一次调用即可获取结果
  - 减少网络请求次数

### 优化改进
- ⚡ **识别速度提升**: 从异步轮询改为同步调用,大幅减少等待时间
- ⚡ **稳定性提升**: 移除轮询超时问题,识别更加稳定可靠
- ⚡ **代码简化**: 移除复杂的轮询逻辑,代码更加简洁易维护

## 2025-11-22 - Bug修复和图片处理优化

### Bug修复
- 🐛 **修复React Router错误**: 修复"Cannot read properties of null (reading 'useRef')"错误
  - 将BrowserRouter从App.tsx移到main.tsx
  - 确保Router在正确的React上下文中初始化
  - 遵循React Router最佳实践

- 🐛 **改进图片识别错误处理**: 优化"recognize error"错误提示
  - 添加详细的错误日志输出
  - 提供更友好的错误信息
  - 改进错误重试逻辑
  - 避免无意义的重试

### 新增功能
- ✅ **智能图片压缩**: 自动压缩大图片,提高识别成功率
  - 自动检测图片大小
  - 大于2MB的图片自动压缩
  - 保持图片清晰度的同时减小文件大小
  - 压缩后的图片更容易被识别
  - 显示压缩前后的大小对比

- ✅ **多图片上传**: 支持一次性上传多张考试成绩截图
  - 可以同时选择多张图片
  - 每张图片独立预览,带序号标识
  - 支持单独删除某张图片
  - 支持一键清空所有图片
  
- ✅ **上传进度显示**: 添加详细的上传进度反馈
  - 实时显示当前处理步骤
  - 显示压缩、识别等详细状态
  - 进度条显示整体完成百分比
  - 提示用户耐心等待

- ✅ **测试数据生成**: 新增数据生成功能
  - 可以快速生成模拟考试数据
  - 支持生成1-20条考试记录
  - 每条记录包含完整的模块数据
  - 方便测试和演示

### 优化改进
- 🔧 **图片处理优化**:
  - 添加智能压缩功能
  - 自动调整图片大小和质量
  - 保持文字清晰度
  - 减少识别失败率
  - 提高处理速度

- 🔧 **用户体验优化**:
  - 上传过程中禁用文件选择和删除操作
  - 添加图片序号标识,方便识别顺序
  - 优化提示文案,更加友好
  - 提供详细的错误提示和解决建议
  - 显示图片处理的详细步骤

- 🔧 **调试优化**:
  - 添加详细的控制台日志
  - 输出识别状态和错误信息
  - 显示图片压缩信息
  - 便于问题排查和调试

### 技术改进
- 📝 更新类型定义,支持多文件管理
- 📝 优化错误处理逻辑
- 📝 改进进度计算算法
- 📝 添加内存清理机制(URL.revokeObjectURL)
- 📝 修复React Router初始化问题
- 📝 增强错误日志和调试信息
- 📝 实现Canvas图片压缩功能
- 📝 优化图片处理流程

### 文档更新
- 📚 更新用户指南,说明多图片上传功能
- 📚 添加使用建议和注意事项
- 📚 添加更新日志
- 📚 创建故障排查指南
- 📚 提供常见问题解决方案
- 📚 添加图片质量要求说明
- 📚 补充图片压缩相关说明

## 初始版本

### 核心功能
- ✅ 图片上传和OCR识别
- ✅ 考试数据解析
- ✅ 数据可视化仪表板
- ✅ 考试记录管理
- ✅ 详细成绩分析
- ✅ 弱势模块识别
