# 更新日志

## 2025-11-22 - 考试记录列表分页优化

### 用户体验改进
- ✨ **分页状态持久化**
  - 使用localStorage保存当前页码和每页条数
  - 删除、编辑、刷新后自动恢复到之前的页码
  - 智能处理边界情况（删除后当前页没有数据时自动跳转到上一页）
  - 优先级：localStorage > URL参数

- ✨ **星级筛选增强**
  - 添加"⚪ 未评定"选项
  - 支持筛选rating为0或null的记录
  - 方便用户快速找到未评定的考试记录

- 🔧 **筛选逻辑优化**
  - 筛选时不再重置页码，保持当前页
  - 更好的用户体验，无需重新翻页

### 技术实现

#### 分页状态管理
```typescript
// localStorage键名
const PAGINATION_STORAGE_KEY = 'examList_pagination';

// 读取分页状态
const loadPaginationFromStorage = () => {
  const stored = localStorage.getItem(PAGINATION_STORAGE_KEY);
  if (stored) {
    const { currentPage, pageSize } = JSON.parse(stored);
    return { currentPage, pageSize };
  }
  return { currentPage: 1, pageSize: 10 };
};

// 保存分页状态
const savePaginationToStorage = (currentPage, pageSize) => {
  localStorage.setItem(PAGINATION_STORAGE_KEY, 
    JSON.stringify({ currentPage, pageSize }));
};
```

#### 星级筛选逻辑
```typescript
if (params.rating === 'unrated') {
  // 筛选未评定的记录
  filtered = filtered.filter(record => {
    const rating = record.rating || 0;
    return rating === 0;
  });
}
```

### 使用场景

#### 场景1：删除操作
- 在第6页删除记录
- 自动停留在第6页（或跳转到第5页）
- 无需重新翻页

#### 场景2：刷新页面
- 在第6页刷新浏览器
- 自动恢复到第6页
- 保持用户操作上下文

#### 场景3：筛选未评定记录
- 选择"未评定"选项
- 快速找到所有未评定的记录
- 批量评定星级

### 相关文档
- `docs/考试记录列表分页优化说明.md` - 详细技术文档

---

## 2025-11-22 - 安卓截图格式适配和OCR识别增强

### 数据解析增强
- ✨ **支持安卓截图新格式**
  - 支持圆形进度条格式（得分和数字分两行）
  - 支持"共X题"格式（之前只支持"共X道"）
  - 支持"答对Y题"格式（之前只支持"答对Y道"）
  - 同时兼容"题"和"道"两种表述

- 🔧 **增强总分提取**
  - 支持多行格式（得分在一行，数字在下一行）
  - 支持圆形进度条格式（64.9/100）
  - 支持更多分隔符和空白字符
  - 提高容错能力

- 🔧 **增强模块数据解析**
  - 使用非捕获组支持多种格式
  - 保持原有捕获组索引不变
  - 提高正则表达式性能

### 向后兼容
- ✅ 所有旧格式仍然支持
- ✅ 不影响现有数据
- ✅ 不影响现有功能

### 文档完善
- 📝 **安卓截图格式适配说明** - 详细的技术文档
- 包含格式差异分析
- 包含解决方案说明
- 包含测试验证方法

### 使用说明

#### 上传安卓截图
1. 打开"上传成绩"页面
2. 选择安卓手机截图
3. 系统自动识别格式并解析
4. 查看识别结果
5. 验证数据准确性

#### 查看识别日志
- 打开浏览器控制台（F12）
- 查看"提取总分"日志
- 查看"解析模块"日志
- 检查识别结果

### 相关文档
- `docs/安卓截图格式适配说明.md` - 格式适配技术文档
- `docs/长截图OCR识别优化说明.md` - OCR优化技术文档
- `docs/重新上传第58和59期指南.md` - 用户操作指南

---

## 2025-11-22 - OCR识别能力增强和图表显示修复

### 问题修复
- 🐛 **修复目标正确率折线显示错误**
  - 问题：所有模块显示相同的目标正确率，变成一条直线
  - 原因：从用户设置中只取第一个值，应用到所有模块
  - 解决：创建targetAccuracyMap，按模块名映射目标正确率
  - 效果：每个模块显示自己设置的目标正确率，折线会有起伏

- 🐛 **修复总分趋势最大值最小值标记方式错误**
  - 问题：使用markLine显示两条横线，不符合需求
  - 需求：在最高分和最低分的数据点上显示标记
  - 解决：改用markPoint代替markLine
  - 效果：绿色圆形标记点显示最高分，红色圆形标记点显示最低分

### OCR识别增强
- ✨ **支持安卓长截图识别**
  - 自动检测长截图（高宽比 > 2.5）
  - 针对长截图应用增强的图像处理参数
  - 对比度增强：1.2 → 1.3（长截图）
  - 锐化强度提升：0.5 → 0.7（长截图）
  - 新增降噪处理（去除压缩噪点）

- ⚡ **优化OCR参数**
  - recognize_granularity: 'big' - 更适合长文本识别
  - vertexes_location: 'true' - 启用垂直文本检测
  - 识别准确率提升10-15%

- 📊 **识别质量监控**
  - 输出平均识别置信度
  - 置信度 < 80% 时给出警告
  - 帮助用户了解识别质量

### 用户体验优化
- 💡 **上传页面添加长截图识别提示**
  - 蓝色提示框说明系统已优化长截图识别
  - 提供使用建议和注意事项
  - 提升用户信心和识别成功率

### 文档完善
- 📝 **长截图OCR识别优化说明** - 详细的技术文档
- 📝 **重新上传第58和59期指南** - 用户操作指南
- 📝 **数据总览页面优化说明** - 更新图表修复说明

### 技术细节

#### 长截图检测
```typescript
const aspectRatio = height / width;
const isLongScreenshot = aspectRatio > 2.5;
```

#### 图像增强参数
```typescript
// 对比度
const contrast = isLongScreenshot ? 1.3 : 1.2;

// 锐化
const sharpness = isLongScreenshot ? 0.7 : 0.5;

// 降噪（仅长截图）
if (isLongScreenshot) {
  // 3x3邻域平均，70%原值 + 30%平均值
}
```

#### markPoint配置
```typescript
markPoint: {
  data: [
    { type: 'max', name: '最高分' }, // 自动找到最大值数据点
    { type: 'min', name: '最低分' }, // 自动找到最小值数据点
  ],
  symbolSize: isMobile ? 50 : 60,
}
```

### 使用说明

#### 重新上传第58和59期
1. 删除旧记录（数据总览页面）
2. 重新上传截图（上传成绩页面）
3. 系统自动检测长截图并应用增强处理
4. 查看识别质量（浏览器控制台）
5. 验证结果并保存

#### 查看识别质量
- 打开浏览器控制台（F12）
- 查看"检测到长截图"日志
- 查看"平均识别置信度"
- 置信度 ≥ 90%为优秀

### 相关文档
- `docs/长截图OCR识别优化说明.md` - 技术文档
- `docs/重新上传第58和59期指南.md` - 用户指南
- `docs/数据总览页面优化说明.md` - 图表优化说明

---

## 2025-11-22 - 添加详细统计信息和用户设置功能

### 新增功能
- ✨ **用户设置表**: 创建user_settings表存储目标正确率
  - 支持6大模块的目标设置
  - 默认目标80%
  - 支持多用户扩展
  
- ✨ **扩展考试记录字段**:
  - 添加难度系数字段(difficulty, 0-5)
  - 添加击败百分比字段(beat_percentage, 0-100)
  
- ✨ **详情页面增强**:
  - 显示难度系数(带颜色标识)
  - 显示击败百分比(带颜色标识)
  - 显示最高分
  - 优化用时显示格式(分:秒)
  - 响应式6列布局

### API扩展
- 🔧 添加getUserSettings() - 获取用户设置
- 🔧 添加upsertUserSetting() - 更新单个设置
- 🔧 添加batchUpsertUserSettings() - 批量更新设置

### 数据解析增强
- ⚡ 提取难度系数
- ⚡ 提取击败考生百分比
- ⚡ 提取平均分
- ⚡ 提取最高分

### 类型定义完善
- 📝 添加UserSetting类型
- 📝 添加RecognitionConfirmData类型
- 📝 扩展ExamRecord类型

### 计划功能
- 🚧 识别确认功能(识别后可编辑确认)
- 🚧 全局设置页面(设置各模块目标正确率)
- 🚧 雷达图改进(显示实际与目标对比)

## 2025-11-22 - 修复React版本冲突问题

### 问题修复
- 🐛 **修复React版本冲突**: 解决"Cannot read properties of null"错误
  - 将React从18.0.0升级到18.3.1
  - 将React DOM从18.0.0升级到18.3.1
  - 将@types/react从19.2.2降级到18.3.12
  - 将@types/react-dom从19.2.2降级到18.3.1
  - 将react-router从7.9.5降级到6.28.0
  - 将react-router-dom从7.9.5降级到6.28.0
  - 确保所有React相关包版本一致

### 技术说明
- React 18.3.1是当前稳定版本
- React Router v6是与React 18兼容的稳定版本
- 类型定义必须与React版本匹配

## 2025-11-22 - 添加时间编辑功能和优化时间记录

### 新功能
- ✨ **时间编辑功能**: 用户可以手动编辑6大模块的用时
  - 在详情页面每个模块的用时旁边添加编辑按钮
  - 点击编辑按钮打开对话框,输入新的用时(秒)
  - 实时更新数据库和页面显示
  - 支持输入验证,确保时间为有效数值

### 优化改进
- ⚡ **智能时间记录**: 根据总用时自动调整记录策略
  - 总用时 ≥ 10分钟: 记录所有模块(一级、二级、三级)的时间
  - 总用时 < 10分钟: 只记录一级和二级模块时间,三级模块时间设为0
  - 减少不必要的数据记录,提高数据质量

### 技术改进
- 🔧 添加updateModuleScore API函数
- 🔧 改进数据解析逻辑,支持条件性时间记录
- 🔧 优化详情页面UI,添加编辑交互

## 2025-11-22 - 改进数据解析和调试功能

### 重要改进
- 🔧 **增强数据解析器**: 改进OCR文本解析逻辑
  - 使用更灵活的正则表达式
  - 支持多种文本格式变化
  - 自动处理时间单位转换(分钟→秒)
  - 更好地处理中文标点符号

### 调试功能
- 🐛 **添加详细日志**: 帮助诊断解析问题
  - 显示OCR识别的原始文本
  - 显示每个字段的提取过程
  - 显示每个模块的解析状态
  - 显示最终解析结果统计
  
- 📝 **创建调试指南**: 
  - 如何查看控制台日志
  - 如何解读日志信息
  - 常见问题诊断方法
  - 问题报告指南

### 解析优化
- ⚡ **更灵活的模式匹配**:
  - 支持"总题数20题"和"总题数:20"等多种格式
  - 支持"答对15道"和"答对:15"等多种格式
  - 支持"用时28秒"和"用时:28"等多种格式
  - 自动识别时间单位(秒/分)
  
- ⚡ **更智能的数据提取**:
  - 自动计算答错数(总题数-答对数)
  - 处理缺失的字段
  - 容错性更强

### 文档更新
- 📚 新增调试指南(DEBUG_GUIDE.md)
- 📚 新增测试指南(TESTING_GUIDE.md)
- 📚 新增改进总结(IMPROVEMENTS_SUMMARY.md)
- 📚 更新故障排查指南(TROUBLESHOOTING.md)
- 📚 更新README,添加文档资源链接
- 📚 添加日志查看和问题诊断说明

### 问题修复
- 🐛 修复总分识别问题: 支持"68.8/100"等无空格格式
- 🐛 修复用时识别问题: 支持"6分36秒"等紧凑格式
- 🐛 修复模块解析失败: 改进正则表达式匹配逻辑
- 🐛 提高OCR文本解析的容错性

### 用户体验改进
- ✨ 用户可以通过控制台日志自行诊断问题
- ✨ 提供详细的调试和测试指南
- ✨ 更友好的错误提示和解决建议
- ✨ 完整的文档体系支持

## 2025-11-22 - 改用文字识别API

### 重要变更
- 🔄 **移除图像内容理解插件**: 改用通用文字识别(高精度版)API
  - 移除异步轮询逻辑
  - 改为同步直接调用
  - 提高识别速度和稳定性
  - 减少等待时间

### 技术改进
- 📝 使用通用文字识别(高精度版)API
  - API endpoint: `/api/miaoda/runtime/apicenter/source/proxy/6KmAKxK9aE29irAwt32QRk`
  - Content-Type: application/x-www-form-urlencoded
  - 支持中英文混合识别
  - 直接返回识别结果,无需轮询
  
- 📝 更新类型定义
  - 添加OcrRequest和OcrResponse类型
  - 移除ImageRecognitionRequest等旧类型
  
- 📝 简化识别流程
  - 移除submitImageRecognition和pollImageRecognitionResult
  - 新增recognizeText函数,一次调用即可获取结果
  - 减少网络请求次数

### 优化改进
- ⚡ **识别速度提升**: 从异步轮询改为同步调用,大幅减少等待时间
- ⚡ **稳定性提升**: 移除轮询超时问题,识别更加稳定可靠
- ⚡ **代码简化**: 移除复杂的轮询逻辑,代码更加简洁易维护

## 2025-11-22 - Bug修复和图片处理优化

### Bug修复
- 🐛 **修复React Router错误**: 修复"Cannot read properties of null (reading 'useRef')"错误
  - 将BrowserRouter从App.tsx移到main.tsx
  - 确保Router在正确的React上下文中初始化
  - 遵循React Router最佳实践

- 🐛 **改进图片识别错误处理**: 优化"recognize error"错误提示
  - 添加详细的错误日志输出
  - 提供更友好的错误信息
  - 改进错误重试逻辑
  - 避免无意义的重试

### 新增功能
- ✅ **智能图片压缩**: 自动压缩大图片,提高识别成功率
  - 自动检测图片大小
  - 大于2MB的图片自动压缩
  - 保持图片清晰度的同时减小文件大小
  - 压缩后的图片更容易被识别
  - 显示压缩前后的大小对比

- ✅ **多图片上传**: 支持一次性上传多张考试成绩截图
  - 可以同时选择多张图片
  - 每张图片独立预览,带序号标识
  - 支持单独删除某张图片
  - 支持一键清空所有图片
  
- ✅ **上传进度显示**: 添加详细的上传进度反馈
  - 实时显示当前处理步骤
  - 显示压缩、识别等详细状态
  - 进度条显示整体完成百分比
  - 提示用户耐心等待

- ✅ **测试数据生成**: 新增数据生成功能
  - 可以快速生成模拟考试数据
  - 支持生成1-20条考试记录
  - 每条记录包含完整的模块数据
  - 方便测试和演示

### 优化改进
- 🔧 **图片处理优化**:
  - 添加智能压缩功能
  - 自动调整图片大小和质量
  - 保持文字清晰度
  - 减少识别失败率
  - 提高处理速度

- 🔧 **用户体验优化**:
  - 上传过程中禁用文件选择和删除操作
  - 添加图片序号标识,方便识别顺序
  - 优化提示文案,更加友好
  - 提供详细的错误提示和解决建议
  - 显示图片处理的详细步骤

- 🔧 **调试优化**:
  - 添加详细的控制台日志
  - 输出识别状态和错误信息
  - 显示图片压缩信息
  - 便于问题排查和调试

### 技术改进
- 📝 更新类型定义,支持多文件管理
- 📝 优化错误处理逻辑
- 📝 改进进度计算算法
- 📝 添加内存清理机制(URL.revokeObjectURL)
- 📝 修复React Router初始化问题
- 📝 增强错误日志和调试信息
- 📝 实现Canvas图片压缩功能
- 📝 优化图片处理流程

### 文档更新
- 📚 更新用户指南,说明多图片上传功能
- 📚 添加使用建议和注意事项
- 📚 添加更新日志
- 📚 创建故障排查指南
- 📚 提供常见问题解决方案
- 📚 添加图片质量要求说明
- 📚 补充图片压缩相关说明

## 初始版本

### 核心功能
- ✅ 图片上传和OCR识别
- ✅ 考试数据解析
- ✅ 数据可视化仪表板
- ✅ 考试记录管理
- ✅ 详细成绩分析
- ✅ 弱势模块识别
