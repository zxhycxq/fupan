# 持久化计时器测试指南

## 快速测试步骤

### 1. 查看示例
1. 打开应用，进入"小工具"页面
2. 点击"持久化计时器示例"标签
3. 查看功能说明和技术实现

### 2. 测试后台运行（最重要）

#### 测试场景1：切换标签页
```
1. 点击"开始计时"
2. 记录当前时间（如 00:00:10）
3. 切换到其他标签页（如打开新标签页浏览网页）
4. 等待 2 分钟
5. 切回计时器标签页
6. 验证：时间应该显示约 00:02:10（误差不超过1秒）
```

**预期结果**：✅ 时间准确，说明不受浏览器节流影响

#### 测试场景2：最小化浏览器
```
1. 点击"开始计时"
2. 记录当前时间
3. 最小化浏览器窗口
4. 等待 5 分钟
5. 恢复浏览器窗口
6. 验证：时间应该准确增加了 5 分钟
```

**预期结果**：✅ 时间准确，说明后台运行正常

### 3. 测试页面关闭恢复

#### 测试场景3：刷新页面
```
1. 点击"开始计时"
2. 等待 30 秒
3. 按 F5 刷新页面
4. 查看操作日志
5. 验证：应该显示"恢复计时状态，已用时间：00:00:30"
```

**预期结果**：✅ 自动恢复，时间准确

#### 测试场景4：关闭标签页
```
1. 点击"开始计时"
2. 等待 1 分钟
3. 关闭标签页
4. 等待 2 分钟
5. 重新打开应用，进入"持久化计时器示例"
6. 验证：应该显示约 00:03:00（1分钟运行 + 2分钟关闭）
```

**预期结果**：✅ 自动恢复并补偿关闭期间的时间

### 4. 测试暂停功能

#### 测试场景5：暂停后关闭
```
1. 点击"开始计时"
2. 等待 30 秒
3. 点击"暂停"
4. 关闭标签页
5. 等待 1 分钟
6. 重新打开应用
7. 验证：时间应该保持在 00:00:30（暂停时的值）
```

**预期结果**：✅ 暂停状态正确保存和恢复

#### 测试场景6：暂停后切换标签页
```
1. 点击"开始计时"
2. 等待 20 秒
3. 点击"暂停"
4. 切换到其他标签页
5. 等待 2 分钟
6. 切回来
7. 验证：时间应该保持在 00:00:20
```

**预期结果**：✅ 暂停期间不计时

### 5. 测试长时间后台

#### 测试场景7：锁屏测试（最严格）
```
1. 点击"开始计时"
2. 记录当前时间
3. 锁定电脑屏幕（Windows: Win+L, Mac: Cmd+Ctrl+Q）
4. 等待 10 分钟以上
5. 解锁电脑
6. 验证：时间应该准确增加了 10+ 分钟
```

**预期结果**：✅ 即使系统休眠，时间仍然准确

### 6. 查看操作日志

每次操作都会在"操作日志"卡片中记录：
- 开始/暂停/继续/停止操作
- 页面隐藏/恢复事件
- 状态恢复信息

**示例日志**：
```
[14:30:45] 页面恢复可见，同步实际经过的时间
[14:28:30] 页面隐藏，计时器继续在后台运行
[14:28:00] 开始计时
```

## 对比测试（可选）

### 对比原有计时器

1. 打开"模考计时"标签（原有实现）
2. 点击"开始考试"
3. 切换到其他标签页 2 分钟
4. 切回来观察时间

**可能的问题**：
- ❌ 时间可能不准确（受浏览器节流影响）
- ❌ 关闭后恢复可能有偏差

### 对比持久化计时器

1. 打开"持久化计时器示例"标签
2. 执行相同的测试
3. 对比结果

**预期优势**：
- ✅ 时间始终准确
- ✅ 关闭后完美恢复
- ✅ 自动补偿时间差

## 常见问题排查

### Q1: 刷新后没有恢复提示？

**可能原因**：
1. 计时器没有运行就刷新了
2. localStorage被清除了
3. 使用了隐私模式

**解决方法**：
1. 确保点击"开始计时"后再刷新
2. 检查浏览器是否允许localStorage
3. 不要使用隐私/无痕模式

### Q2: 时间不准确？

**可能原因**：
1. 系统时间被修改
2. 浏览器版本太旧

**解决方法**：
1. 检查系统时间是否正确
2. 更新浏览器到最新版本

### Q3: 页面隐藏事件没有触发？

**可能原因**：
1. 浏览器不支持Page Visibility API
2. 没有真正切换标签页（只是切换窗口）

**解决方法**：
1. 使用现代浏览器（Chrome/Firefox/Edge）
2. 确保切换到其他标签页，而不是其他窗口

## 技术验证

### 验证时间戳计时

打开浏览器控制台，查看日志：
```
页面恢复可见，同步计时器状态
```

这说明Page Visibility API正常工作。

### 验证localStorage

打开浏览器开发者工具 → Application → Local Storage：
- 查找键名：`example_persistent_timer`
- 查看值：应该包含`startTimestamp`、`accumulatedTime`等字段

### 验证时间计算

在控制台执行：
```javascript
const saved = JSON.parse(localStorage.getItem('example_persistent_timer'));
const now = Date.now();
const elapsed = (now - saved.startTimestamp + saved.accumulatedTime) / 1000;
console.log('实际经过时间（秒）:', Math.floor(elapsed));
```

## 性能测试

### 内存占用

1. 打开Chrome任务管理器（Shift+Esc）
2. 开始计时
3. 观察内存占用
4. 运行 1 小时后再次观察

**预期结果**：✅ 内存占用稳定，无内存泄漏

### CPU占用

1. 打开Chrome任务管理器
2. 开始计时
3. 观察CPU占用

**预期结果**：✅ CPU占用极低（< 1%）

## 总结

### 核心测试点
1. ✅ 切换标签页时间准确
2. ✅ 关闭页面后可恢复
3. ✅ 长时间后台运行准确
4. ✅ 暂停功能正常
5. ✅ 页面可见性检测正常

### 通过标准
- 时间误差 < 1秒
- 恢复成功率 100%
- 无内存泄漏
- CPU占用 < 1%

### 下一步
如果所有测试通过，可以：
1. 将ExamTimer迁移到使用usePersistentTimer
2. 添加更多功能（倒计时、多计时器等）
3. 优化UI和用户体验
