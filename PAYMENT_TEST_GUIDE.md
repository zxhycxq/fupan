# 支付功能测试指南

## 功能概述
已成功为考试成绩分析系统添加完整的微信支付功能，包括：
- 会员套餐选择（免费版 vs 基础版）
- 订单确认页面
- 微信支付二维码生成
- 订单状态实时轮询
- 支付成功后会员状态更新

## 测试步骤

### 1. 访问支付入口
1. 登录系统后，进入"个人中心"页面
2. 点击"开通会员"按钮
3. 会弹出支付弹窗，显示两个套餐：
   - **免费版**：¥0.00/永久（基础功能）
   - **基础版**：¥19.90/月（完整功能）

### 2. 选择套餐
1. 点击任一套餐的"立即购买"按钮
2. 系统会跳转到订单确认页面（`/order-confirm?plan=free` 或 `/order-confirm?plan=basic`）

### 3. 填写订单信息
在订单确认页面，需要填写：
- **收货人姓名**：必填
- **手机号**：必填，格式验证
- **详细地址**：必填

页面右侧会显示：
- 商品信息（套餐名称、价格、数量）
- 金额明细（小计、优惠、运费、实付款）

### 4. 提交订单
1. 点击"提交订单"按钮
2. 系统会调用后端 Edge Function 创建订单
3. 成功后跳转到订单详情页面（`/order-detail/:orderNo`）

### 5. 扫码支付
在订单详情页面：
1. 显示微信支付二维码
2. 显示订单信息（订单号、商品、金额、收货人信息）
3. 系统每2秒自动轮询订单状态
4. 使用微信扫描二维码完成支付

### 6. 支付成功
1. 支付成功后，页面会自动检测到状态变化
2. 显示支付成功提示
3. 用户会员状态自动更新
4. 可以点击"返回首页"或"查看订单"

## 重要配置

### 微信支付密钥配置
⚠️ **必须配置微信支付密钥才能正常使用支付功能**

请通过插件中心配置以下密钥：
- `WECHAT_MCHID`：微信商户号
- `WECHAT_SERIAL_NO`：证书序列号
- `WECHAT_APIV3_KEY`：APIv3密钥
- `WECHAT_PRIVATE_KEY`：商户私钥

配置方法：
1. 访问 Supabase 控制台
2. 进入项目设置 → Edge Functions → Secrets
3. 添加上述密钥

### 数据库表结构
系统已自动创建以下表：
- `sku`：商品表（存储套餐信息）
- `orders`：订单表（存储订单主信息）
- `order_items`：订单明细表（存储订单商品明细）

### Edge Functions
已部署以下 Edge Functions：
- `create_payment_order`：创建订单并生成微信支付二维码
- `wechat_payment_webhook`：处理微信支付回调

## 测试注意事项

1. **免费版测试**：
   - 免费版价格为 ¥0.00
   - 仍需填写收货人信息
   - 会生成订单但无需实际支付
   - 可用于测试订单流程

2. **基础版测试**：
   - 需要配置真实的微信支付密钥
   - 需要使用真实的微信扫码支付
   - 支付成功后会更新用户会员状态

3. **订单状态轮询**：
   - 系统每2秒自动查询一次订单状态
   - 最多轮询60次（2分钟）
   - 超时后会提示用户手动刷新

4. **错误处理**：
   - 订单创建失败会显示错误提示
   - 支付超时会提示用户
   - 网络错误会自动重试

## 技术实现细节

### 前端组件
- `PaymentModal.tsx`：支付弹窗，显示套餐选择
- `OrderConfirm.tsx`：订单确认页面，收集用户信息
- `OrderDetail.tsx`：订单详情页面，显示支付二维码和状态

### API 接口
- `createPaymentOrder()`：创建支付订单
- `getOrderDetail()`：查询订单详情
- `getUserOrders()`：查询用户订单列表

### 支付流程
1. 用户选择套餐 → 跳转订单确认页
2. 填写信息提交 → 调用 `create_payment_order` Edge Function
3. 生成订单和支付二维码 → 跳转订单详情页
4. 显示二维码 → 用户扫码支付
5. 微信回调 → `wechat_payment_webhook` 更新订单状态
6. 前端轮询检测 → 显示支付成功

## 常见问题

### Q: 支付二维码无法生成？
A: 请检查微信支付密钥是否正确配置，查看 Edge Function 日志排查错误。

### Q: 订单状态一直显示"待支付"？
A: 可能是微信支付回调未正确配置，或者网络延迟，请手动刷新页面。

### Q: 支付成功但会员状态未更新？
A: 请检查数据库 RLS 策略是否正确，确保用户有权限更新自己的会员状态。

### Q: 如何查看订单列表？
A: 目前订单详情页面可以查看单个订单，后续可以在个人中心添加"我的订单"功能。

## 下一步优化建议

1. **订单列表页面**：在个人中心添加"我的订单"入口
2. **支付方式扩展**：支持支付宝、银行卡等其他支付方式
3. **优惠券系统**：添加优惠券、折扣码功能
4. **订单管理**：支持订单取消、退款等操作
5. **支付通知**：支付成功后发送短信或邮件通知
6. **数据统计**：添加订单统计、收入分析等功能

## 联系支持

如有问题，请通过以下方式联系：
- 功能反馈：设置页面 → 功能反馈&建议
- 技术支持：查看 Supabase 日志和错误信息
