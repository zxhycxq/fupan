# 表单输入功能测试指南

## 最新更新 (2025-12-05)

### 新增功能

1. **考试类型选择**
   - 位置：表单录入页面顶部
   - 选项：省考、国考
   - 默认值：省考

2. **大模块总计输入**
   - 位置：每个大模块展开后的顶部
   - 样式：蓝色背景高亮显示
   - 字段：题目数量、答对数量、用时(分钟)

3. **用时单位改为分钟**
   - 修改前：用时(秒)
   - 修改后：用时(分钟)
   - 数据库仍以秒为单位存储

4. **界面优化**
   - 缩短各项目间距
   - 页面更紧凑
   - 减少滚动操作

## 问题修复说明

已修复表单输入数据无法保存的问题。

### 修复内容

1. **移除了表单字段的 initialValue={0}**
   - 之前所有字段默认值为0，导致数据收集逻辑混乱
   - 现在未填写的字段值为 undefined，只收集用户真正填写的数据

2. **修改了 getFieldsValue() 调用**
   - 添加了 true 参数：`form.getFieldsValue(true)`
   - 确保获取所有嵌套字段的值

3. **添加了详细的调试日志**
   - 在浏览器控制台可以看到完整的数据流转过程
   - 方便排查问题

## 测试步骤

### 1. 打开上传页面
- 访问系统的上传页面
- 切换到"表单录入"标签页

### 2. 填写考试信息
- 考试名称：第40期（或其他名称）
- 索引号：21（或其他数字）
- 考试类型：选择"省考"或"国考"

### 3. 填写模块数据

#### 方式一：只填写大模块总计
展开"政治理论"模块，在蓝色背景的"总计"区域填写：
- 题目数量：20
- 答对数量：15
- 用时(分钟)：20

#### 方式二：填写子模块数据
展开"政治理论"模块，填写子模块：

**马克思主义**
- 题目数量：5
- 答对数量：4
- 用时(分钟)：3

**理论与政策**
- 题目数量：8
- 答对数量：6
- 用时(分钟)：4

**时政热点**
- 题目数量：7
- 答对数量：5
- 用时(分钟)：3

#### 方式三：同时填写大模块总计和子模块
- 可以同时填写大模块总计和子模块数据
- 系统会分别保存两种数据
- 大模块总计的parent_module为null
- 子模块的parent_module为大模块名称

### 4. 查看控制台日志
打开浏览器开发者工具（F12），切换到 Console 标签页。

点击"保存成绩"按钮后，应该看到类似以下日志：

```
=== 表单提交 ===
考试名称: 第40期
索引号: 21
考试类型: 省考
表单值: {政治理论_总计: {total_questions: 20, correct_answers: 15, time_used: 20}, ...}
添加大模块得分: {module_name: "政治理论", parent_module: null, time_used: 1200, ...}
检查模块 政治理论_马克思主义: {total_questions: 5, correct_answers: 4, time_used: 3}
添加模块得分: {module_name: "马克思主义", parent_module: "政治理论", time_used: 180, ...}
总共收集到 4 个模块
总分: 30
总用时(秒): 2400
```

### 5. 验证详情页
保存成功后会自动跳转到详情页，检查：

- ✅ 考试名称显示正确
- ✅ 索引号显示正确
- ✅ 总分显示正确（所有模块答对数量之和）
- ✅ 总用时显示正确（所有模块用时之和，以分钟显示）
- ✅ 模块得分列表显示完整
- ✅ 大模块总计和子模块都正确显示
- ✅ 每个模块的题目数、答对数、正确率、用时都正确

## 常见问题

### Q1: 点击保存后提示"请至少填写一个模块的数据"
**原因**：没有填写任何模块的题目数量，或者题目数量为0

**解决**：至少填写一个模块（大模块总计或子模块）的"题目数量"字段，且值必须大于0

### Q2: 详情页显示的数据不完整
**原因**：可能是浏览器缓存问题

**解决**：
1. 刷新页面（F5）
2. 清除浏览器缓存后重试
3. 查看控制台是否有错误信息

### Q3: 控制台没有看到日志
**原因**：浏览器开发者工具未打开，或者日志被过滤

**解决**：
1. 按 F12 打开开发者工具
2. 切换到 Console 标签页
3. 确保日志级别设置为"All"或"Verbose"

### Q4: 用时显示不正确
**原因**：输入的是分钟，但期望看到秒

**说明**：
- 前端输入单位：分钟
- 数据库存储单位：秒
- 详情页显示单位：分钟
- 转换公式：秒 = 分钟 × 60

## 数据验证规则

1. **考试名称**：不能为空
2. **索引号**：必须大于0
3. **考试类型**：省考或国考
4. **题目数量**：必须大于0才会保存该模块
5. **答对数量**：可以为0，但不能大于题目数量
6. **用时**：可以为0，单位为分钟

## 技术说明

### 数据收集逻辑

#### 大模块总计
```typescript
// 字段key格式
const parentKey = `${parentModule.name}_总计`;

// 数据结构
{
  module_name: '政治理论',
  parent_module: null,  // 大模块没有父模块
  total_questions: 20,
  correct_answers: 15,
  wrong_answers: 5,
  unanswered: 0,
  accuracy_rate: 75.00,
  time_used: 1200  // 秒（20分钟 × 60）
}
```

#### 子模块
```typescript
// 字段key格式
const key = `${parentModule.name}_${subModule}`;

// 数据结构
{
  module_name: '马克思主义',
  parent_module: '政治理论',  // 子模块有父模块
  total_questions: 5,
  correct_answers: 4,
  wrong_answers: 1,
  unanswered: 0,
  accuracy_rate: 80.00,
  time_used: 180  // 秒（3分钟 × 60）
}
```

### 用时转换
```typescript
// 前端输入（分钟）
const timeUsedMinutes = data.time_used || 0;

// 转换为秒存储
const timeUsedSeconds = timeUsedMinutes * 60;

// 详情页显示时再转换回分钟
const displayMinutes = timeUsedSeconds / 60;
```

### 总分和总用时计算
- **总分** = 所有模块（大模块总计 + 子模块）的答对数量之和
- **总用时** = 所有模块的用时之和（秒）

## 界面说明

### 大模块总计样式
- 背景色：蓝色（bg-blue-50）
- 边框：蓝色加粗（border-b-2 border-blue-200）
- 标题颜色：深蓝色（text-blue-700）
- 位置：每个大模块展开后的顶部

### 子模块样式
- 背景色：白色
- 边框：灰色细线
- 标题颜色：深灰色（text-gray-700）
- 位置：大模块总计下方

### 间距优化
- 大模块之间：16px
- 模块内部：12px
- 子模块之间：12px
- 表单项之间：0px（使用mb-0移除默认边距）
- 输入框间距：12px（gutter={12}）

## 后续优化建议

1. 添加表单验证
   - 答对数量不能大于题目数量
   - 用时不能为负数
   - 自动计算答错数量

2. 改进用户体验
   - 添加保存前确认对话框
   - 显示保存进度
   - 支持草稿保存
   - 添加"一键清空"功能

3. 数据导入导出
   - 支持从Excel导入数据
   - 支持导出为Excel格式
   - 批量录入功能

4. 智能填充
   - 根据大模块总计自动分配子模块数据
   - 根据历史数据智能推荐
   - 支持模板保存和加载

5. 考试类型扩展
   - 添加更多考试类型
   - 支持自定义考试类型
   - 不同类型使用不同的模块配置

