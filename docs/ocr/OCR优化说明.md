# OCR识别优化说明

## 概述

本次优化大幅提升了系统对手机截图的OCR识别精准度，特别是针对模考报告中各模块数据的提取准确性。

## 优化内容

### 1. 图片预处理增强

#### 对比度增强
- **算法**：使用线性对比度拉伸算法
- **参数**：对比度系数 1.2
- **公式**：`factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255))`
- **效果**：使文字与背景的对比更明显，提高OCR识别率

#### 锐化处理
- **算法**：使用简单的锐化滤波器
- **参数**：锐化强度 0.5
- **公式**：`sharpened = center * (1 + 4 * sharpness) - (top + bottom + left + right) * sharpness`
- **效果**：增强文字边缘，使字符更清晰

#### 图片质量优化
- **最大宽度**：从1920px提升至2400px
- **JPEG质量**：从0.9提升至0.95
- **目的**：保留更多细节，特别是小字体文字

### 2. OCR参数优化

#### 启用的参数
```typescript
{
  language_type: 'CHN_ENG',      // 中英文混合识别
  detect_direction: true,         // 方向检测
  probability: true,              // 返回置信度
  paragraph: true                 // 保持段落结构
}
```

#### 效果
- **方向检测**：自动识别并纠正图片方向
- **置信度统计**：可以评估识别质量
- **段落保持**：保留文本结构，提高解析准确度

### 3. 文本预处理

#### 标点符号统一
```typescript
'，' → ','  // 中文逗号转英文
'：' → ':'  // 中文冒号转英文
'（' → '('  // 中文括号转英文
'）' → ')'
'％' → '%'  // 全角百分号转半角
```

#### 空白字符清理
- 多个空格/制表符合并为一个空格
- 删除行首行尾空格
- 多个换行合并为两个

#### OCR错误修复
```typescript
// 在数字上下文中修复常见混淆
'o', 'O' → '0'
'l', 'I' → '1'

// 规范化数据格式
'共 20 道' → '共20道'
'答对 15 道' → '答对15道'
'正确率 75 %' → '正确率75%'
'用时 30 秒' → '用时30秒'
```

### 4. 正则表达式优化

#### 更宽松的匹配规则

**原来的模式**：
```typescript
`共\\s*(\\d+)\\s*道[，,\\s]+`
```

**优化后的模式**：
```typescript
`共[\\s，,]*?(\\d+)[\\s]*?道[\\s，,]+?`
```

#### 改进点
1. **搜索范围扩大**：从200字符增加到300字符
2. **允许更多变体**：支持各种空格和逗号组合
3. **非贪婪匹配**：使用`*?`和`+?`提高精确度

#### 支持的格式示例
```
共20道，答对15道，正确率75%，用时30秒
共 20 道，答对 15 道，正确率 75%，用时 30 秒
共20道, 答对15道, 正确率75%, 用时30秒
共 20 道 ， 答对 15 道 ， 正确率 75% ， 用时 30 秒
```

### 5. 模块结构扩展

#### 新增数量关系子模块
- 多位数问题
- 平均数问题
- 溶液问题
- 计数模型问题
- 年龄问题
- 不定方程问题

#### 完整的数量关系子模块列表
```typescript
[
  '数学运算',
  '多位数问题',
  '平均数问题',
  '工程问题',
  '溶液问题',
  '最值问题',
  '计数模型问题',
  '年龄问题',
  '和差倍比问题',
  '牛吃草问题',
  '周期问题',
  '数列问题',
  '行程问题',
  '几何问题',
  '容斥原理问题',
  '排列组合问题',
  '概率问题',
  '经济利润问题',
  '函数最值问题',
  '钟表问题',
  '不定方程问题',
]
```

## 使用建议

### 手机截图最佳实践

1. **拍摄要求**
   - 保持手机稳定，避免模糊
   - 确保光线充足，文字清晰
   - 尽量垂直拍摄，避免倾斜
   - 包含完整的模块数据

2. **图片要求**
   - 格式：PNG或JPEG
   - 分辨率：建议1080p以上
   - 文件大小：建议小于5MB

3. **上传建议**
   - 如果识别不准确，可以尝试重新拍摄
   - 确保截图包含完整的模块名称和数据
   - 避免截图中有遮挡或水印

### 调试信息

系统会在控制台输出详细的识别和解析日志：

```
=== OCR识别完成 ===
识别到 45 行文字
平均识别置信度: 98.5%

=== OCR文本预处理 ===
原始文本长度: 1234
处理后文本长度: 1180
处理后前300字符: ...

--- 解析模块: 判断推理 ---
找到模块数据: 判断推理 共30道，答对26道，正确率87%，用时50秒
解析结果: 总题数=30, 答对=26, 正确率=87%, 用时=50秒
```

## 技术细节

### 图像处理流程

```
原始图片
  ↓
缩放（如果超过2400px）
  ↓
对比度增强
  ↓
锐化处理
  ↓
JPEG压缩（质量0.95）
  ↓
Base64编码
  ↓
OCR识别
```

### 文本处理流程

```
OCR原始文本
  ↓
标点符号统一
  ↓
空白字符清理
  ↓
OCR错误修复
  ↓
格式规范化
  ↓
正则表达式匹配
  ↓
数据提取
```

## 性能影响

### 图片处理时间
- 小图片（<1MB）：约100-200ms
- 中等图片（1-3MB）：约200-500ms
- 大图片（3-5MB）：约500-1000ms

### OCR识别时间
- 取决于API响应速度
- 通常在2-5秒之间

### 总体影响
- 图片预处理增加约200-500ms
- 文本预处理增加约10-50ms
- 总体用户体验影响很小

## 常见问题

### Q: 为什么有些模块识别不到？
A: 可能原因：
1. 截图不完整，缺少模块数据
2. 文字模糊或光线不足
3. 模块名称与系统预设不匹配

解决方法：
1. 重新拍摄清晰的截图
2. 确保包含完整的模块信息
3. 查看控制台日志，了解具体原因

### Q: 识别的数据不准确怎么办？
A: 可能原因：
1. OCR识别错误（如0识别成O）
2. 格式不符合预期
3. 数据被遮挡或不完整

解决方法：
1. 系统已自动修复常见错误
2. 如果仍有问题，可以手动编辑数据
3. 提供更清晰的截图

### Q: 手机截图和PC截图有什么区别？
A: 主要区别：
1. **格式**：手机端使用"共X道"，PC端使用"总题数X题"
2. **布局**：手机端垂直列表，PC端可能是表格
3. **分辨率**：手机截图通常分辨率更高

系统已针对两种格式进行优化，都能正确识别。

## 未来优化方向

1. **AI模型优化**
   - 使用更先进的OCR模型
   - 训练专门的模考报告识别模型

2. **自适应处理**
   - 根据图片质量自动调整处理参数
   - 智能识别图片类型（手机/PC）

3. **用户反馈**
   - 收集识别错误案例
   - 持续优化正则表达式
   - 扩展支持的模块类型

4. **性能优化**
   - 使用Web Worker处理图片
   - 缓存处理结果
   - 批量处理多张图片

## 总结

本次优化通过多层次的改进，显著提升了OCR识别的准确度和鲁棒性：

1. **图片层面**：增强对比度和清晰度
2. **OCR层面**：优化参数配置
3. **文本层面**：预处理和错误修复
4. **解析层面**：更宽松的匹配规则

这些改进特别针对手机截图的特点，能够有效处理各种格式变体和OCR错误，大幅提高了数据提取的准确性。
