# 时间编辑功能说明

## 功能概述

系统现在支持用户手动编辑考试模块的用时数据,并根据总用时智能调整时间记录策略。

## 主要功能

### 1. 手动编辑时间

#### 使用方法

1. **进入详情页面**
   - 在考试列表中点击某条考试记录
   - 进入该考试的详情页面

2. **编辑模块时间**
   - 在"模块详细数据"卡片中,找到要编辑的模块
   - 点击模块用时旁边的编辑图标(铅笔图标)
   - 在弹出的对话框中输入新的用时(单位:秒)
   - 点击"保存"按钮

3. **查看更新结果**
   - 保存成功后,页面会自动更新显示新的时间
   - 图表也会相应更新

#### 支持编辑的模块

- ✅ 政治理论
- ✅ 常识判断
- ✅ 言语理解与表达
- ✅ 数量关系
- ✅ 判断推理
- ✅ 资料分析

#### 注意事项

- 只能编辑6大模块的时间
- 子模块的时间不支持手动编辑
- 输入的时间必须是非负整数
- 时间单位为秒

### 2. 智能时间记录

系统会根据考试的总用时自动调整时间记录策略:

#### 总用时 ≥ 10分钟 (600秒)

**记录策略**: 记录所有模块的时间

**包括**:
- 一级模块(6大模块)
- 二级模块(各大模块的子模块)
- 三级模块(更细分的模块)

**示例**:
```
考试总用时: 14分36秒 (876秒)

政治理论: 28秒
  ├─ 马克思主义: 10秒
  ├─ 理论与政策: 8秒
  └─ 时政热点: 10秒

常识判断: 21秒
  ├─ 经济常识: 5秒
  ├─ 科技常识: 4秒
  ├─ 人文常识: 4秒
  ├─ 地理国情: 4秒
  └─ 法律常识: 4秒

... (其他模块)
```

#### 总用时 < 10分钟 (600秒)

**记录策略**: 只记录一级和二级模块时间

**包括**:
- 一级模块(6大模块) ✅
- 二级模块(各大模块的子模块) ✅
- 三级模块(更细分的模块) ❌ (设为0)

**示例**:
```
考试总用时: 6分36秒 (396秒)

政治理论: 28秒
  ├─ 马克思主义: 0秒
  ├─ 理论与政策: 0秒
  └─ 时政热点: 0秒

常识判断: 21秒
  ├─ 经济常识: 0秒
  ├─ 科技常识: 0秒
  ├─ 人文常识: 0秒
  ├─ 地理国情: 0秒
  └─ 法律常识: 0秒

... (其他模块)
```

#### 设计原因

1. **数据质量**: 总用时较短时,细分模块的时间数据可能不够准确
2. **用户体验**: 避免显示过多的0秒或不准确的时间数据
3. **存储优化**: 减少不必要的数据记录

## 技术实现

### 数据解析

在`dataParser.ts`中:

```typescript
// 判断是否记录细分模块时间(总用时小于10分钟=600秒)
const shouldRecordSubModuleTime = timeUsed >= 600;

// 如果总用时小于10分钟,子模块时间设为0
if (!shouldRecordSubModuleTime) {
  timeUsedSec = 0;
}
```

### 时间编辑

在`ExamDetail.tsx`中:

```typescript
// 打开编辑对话框
const handleEditTime = (module: ModuleScore) => {
  setEditingModule(module);
  setEditTime(module.time_used?.toString() || '0');
};

// 保存时间修改
const handleSaveTime = async () => {
  await updateModuleScore(editingModule.id, { time_used: newTime });
  // 更新本地状态
  setExamDetail({
    ...examDetail,
    module_scores: examDetail.module_scores.map(m =>
      m.id === editingModule.id ? { ...m, time_used: newTime } : m
    ),
  });
};
```

### 数据库更新

在`api.ts`中:

```typescript
export async function updateModuleScore(
  id: string,
  updates: Partial<Omit<ModuleScore, 'id' | 'exam_record_id' | 'created_at'>>
): Promise<void> {
  const { error } = await supabase
    .from('module_scores')
    .update(updates)
    .eq('id', id);
}
```

## 使用场景

### 场景1: 修正识别错误

**问题**: OCR识别的时间不准确

**解决方案**:
1. 查看原始截图,确认实际用时
2. 点击编辑按钮
3. 输入正确的时间
4. 保存

### 场景2: 补充缺失数据

**问题**: 某些模块的时间没有被识别

**解决方案**:
1. 根据截图或记忆补充时间
2. 点击编辑按钮
3. 输入时间
4. 保存

### 场景3: 调整时间分配

**问题**: 需要重新分配各模块的时间

**解决方案**:
1. 逐个编辑各模块的时间
2. 确保总时间合理
3. 保存所有修改

## 常见问题

### Q1: 为什么子模块的时间是0?

**A**: 如果考试总用时小于10分钟,系统会自动将三级子模块的时间设为0,以保证数据质量。

### Q2: 可以编辑子模块的时间吗?

**A**: 目前只支持编辑6大模块的时间,子模块时间不支持手动编辑。

### Q3: 编辑时间后图表会更新吗?

**A**: 会的。保存时间后,页面会自动刷新,所有相关的图表都会更新。

### Q4: 时间单位是什么?

**A**: 时间单位统一为秒。如果要输入分钟,需要先转换为秒(例如:5分钟 = 300秒)。

### Q5: 可以输入小数吗?

**A**: 不可以。时间必须是整数秒。

### Q6: 修改后可以撤销吗?

**A**: 目前不支持撤销功能。如果输入错误,需要重新编辑并输入正确的值。

## 最佳实践

### 1. 数据准确性

- ✅ 参考原始截图确认时间
- ✅ 确保输入的时间合理
- ✅ 检查总时间是否与各模块时间匹配
- ❌ 不要随意修改时间

### 2. 时间分配

- ✅ 各模块时间之和应接近总用时
- ✅ 考虑题目数量和难度
- ✅ 参考历史数据
- ❌ 不要让某个模块时间过长或过短

### 3. 数据维护

- ✅ 定期检查数据准确性
- ✅ 及时修正识别错误
- ✅ 保持数据一致性
- ❌ 不要频繁修改已确认的数据

## 未来改进

### 短期计划

1. **批量编辑**: 支持一次编辑多个模块的时间
2. **时间验证**: 添加更智能的时间验证规则
3. **修改历史**: 记录时间修改历史

### 中期计划

1. **自动分配**: 根据题目数量自动分配时间
2. **时间建议**: 基于历史数据提供时间建议
3. **异常检测**: 自动检测异常的时间数据

### 长期计划

1. **智能学习**: 基于用户习惯优化时间记录
2. **时间分析**: 提供更详细的时间分析报告
3. **时间预测**: 预测未来考试的时间分配

## 总结

时间编辑功能让用户能够:
- ✅ 修正OCR识别错误
- ✅ 补充缺失的时间数据
- ✅ 调整时间分配
- ✅ 提高数据准确性

智能时间记录策略:
- ✅ 根据总用时自动调整
- ✅ 保证数据质量
- ✅ 优化存储空间
- ✅ 改善用户体验

通过这些功能,系统能够提供更准确、更有价值的考试分析数据。
