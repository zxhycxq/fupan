# ğŸ“¦ æ•°æ®åº“è¿ç§»æŒ‡å—

## ğŸ¯ è¿ç§»åœºæ™¯

æœ¬æŒ‡å—é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
1. ä»å¼€å‘ç¯å¢ƒè¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒ
2. ä»æ—§çš„ Supabase é¡¹ç›®è¿ç§»åˆ°æ–°é¡¹ç›®
3. æ•°æ®å¤‡ä»½å’Œæ¢å¤
4. è·¨æœåŠ¡å™¨æ•°æ®åŒæ­¥

---

## ğŸ“‹ ç›®å½•

- [æ–¹æ¡ˆä¸€ï¼šSupabase å®˜æ–¹è¿ç§»æ–¹æ¡ˆ](#æ–¹æ¡ˆä¸€supabase-å®˜æ–¹è¿ç§»æ–¹æ¡ˆ)
- [æ–¹æ¡ˆäºŒï¼šè…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆ](#æ–¹æ¡ˆäºŒè…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆ)
- [æ–¹æ¡ˆä¸‰ï¼šæ‰‹åŠ¨å¯¼å‡ºå¯¼å…¥æ–¹æ¡ˆ](#æ–¹æ¡ˆä¸‰æ‰‹åŠ¨å¯¼å‡ºå¯¼å…¥æ–¹æ¡ˆ)

---

## æ–¹æ¡ˆä¸€ï¼šSupabase å®˜æ–¹è¿ç§»æ–¹æ¡ˆ

### é€‚ç”¨åœºæ™¯
- Supabase é¡¹ç›®ä¹‹é—´çš„è¿ç§»
- å®˜æ–¹æ¨èçš„æ ‡å‡†è¿ç§»æ–¹å¼
- é€‚åˆå¤§é‡æ•°æ®è¿ç§»

### æ­¥éª¤ 1ï¼šå‡†å¤‡å·¥ä½œ

#### 1.1 å®‰è£… Supabase CLI

```bash
# Windows (ä½¿ç”¨ Scoop)
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase

# Linux
brew install supabase/tap/supabase
```

#### 1.2 ç™»å½• Supabase

```bash
supabase login
```

### æ­¥éª¤ 2ï¼šä»æºé¡¹ç›®å¯¼å‡ºæ•°æ®

#### 2.1 é“¾æ¥åˆ°æºé¡¹ç›®

```bash
# åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ
cd /path/to/your/project

# é“¾æ¥åˆ°æºé¡¹ç›®
supabase link --project-ref <SOURCE_PROJECT_REF>
```

**è·å– PROJECT_REF**:
- ç™»å½• Supabase Dashboard
- è¿›å…¥é¡¹ç›®è®¾ç½® (Settings)
- åœ¨ General æ ‡ç­¾é¡µæ‰¾åˆ° Reference ID

#### 2.2 å¯¼å‡ºæ•°æ®åº“ç»“æ„

```bash
# å¯¼å‡ºå®Œæ•´çš„æ•°æ®åº“ç»“æ„ï¼ˆåŒ…å«è¡¨ã€ç´¢å¼•ã€è§¦å‘å™¨ã€RLS ç­–ç•¥ç­‰ï¼‰
supabase db dump --file=schema.sql

# æˆ–è€…ä½¿ç”¨è¿œç¨‹å¯¼å‡º
supabase db dump --db-url "postgresql://postgres:[PASSWORD]@db.[PROJECT_REF].supabase.co:5432/postgres" --file=schema.sql
```

#### 2.3 å¯¼å‡ºæ•°æ®

```bash
# å¯¼å‡ºæ‰€æœ‰è¡¨çš„æ•°æ®
supabase db dump --data-only --file=data.sql

# æˆ–è€…å¯¼å‡ºç‰¹å®šè¡¨çš„æ•°æ®
supabase db dump --data-only --table=profiles --file=profiles_data.sql
supabase db dump --data-only --table=exam_records --file=exam_records_data.sql
supabase db dump --data-only --table=module_scores --file=module_scores_data.sql
supabase db dump --data-only --table=user_settings --file=user_settings_data.sql
supabase db dump --data-only --table=vip_applications --file=vip_applications_data.sql
```

### æ­¥éª¤ 3ï¼šå¯¼å…¥åˆ°ç›®æ ‡é¡¹ç›®

#### 3.1 é“¾æ¥åˆ°ç›®æ ‡é¡¹ç›®

```bash
# å–æ¶ˆé“¾æ¥æºé¡¹ç›®
supabase unlink

# é“¾æ¥åˆ°ç›®æ ‡é¡¹ç›®
supabase link --project-ref <TARGET_PROJECT_REF>
```

#### 3.2 å¯¼å…¥æ•°æ®åº“ç»“æ„

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ Supabase CLI
supabase db push

# æ–¹å¼äºŒï¼šä½¿ç”¨ SQL æ–‡ä»¶
supabase db execute --file=schema.sql

# æ–¹å¼ä¸‰ï¼šåœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œ
# 1. æ‰“å¼€ Supabase Dashboard
# 2. è¿›å…¥ SQL Editor
# 3. ç²˜è´´ schema.sql çš„å†…å®¹
# 4. ç‚¹å‡» Run
```

#### 3.3 å¯¼å…¥æ•°æ®

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ Supabase CLI
supabase db execute --file=data.sql

# æ–¹å¼äºŒï¼šåˆ†è¡¨å¯¼å…¥
supabase db execute --file=profiles_data.sql
supabase db execute --file=exam_records_data.sql
supabase db execute --file=module_scores_data.sql
supabase db execute --file=user_settings_data.sql
supabase db execute --file=vip_applications_data.sql
```

### æ­¥éª¤ 4ï¼šéªŒè¯è¿ç§»

#### 4.1 æ£€æŸ¥è¡¨ç»“æ„

```sql
-- åœ¨ç›®æ ‡é¡¹ç›®çš„ SQL Editor ä¸­æ‰§è¡Œ
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

#### 4.2 æ£€æŸ¥æ•°æ®é‡

```sql
-- æ£€æŸ¥å„è¡¨çš„æ•°æ®é‡
SELECT 
  'profiles' AS table_name, 
  COUNT(*) AS row_count 
FROM profiles
UNION ALL
SELECT 
  'exam_records', 
  COUNT(*) 
FROM exam_records
UNION ALL
SELECT 
  'module_scores', 
  COUNT(*) 
FROM module_scores
UNION ALL
SELECT 
  'user_settings', 
  COUNT(*) 
FROM user_settings
UNION ALL
SELECT 
  'vip_applications', 
  COUNT(*) 
FROM vip_applications;
```

#### 4.3 æ£€æŸ¥ RLS ç­–ç•¥

```sql
-- æ£€æŸ¥ RLS ç­–ç•¥
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

---

## æ–¹æ¡ˆäºŒï¼šè…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆ

### é€‚ç”¨åœºæ™¯
- éœ€è¦è‡ªå»º PostgreSQL æ•°æ®åº“
- éœ€è¦å®Œå…¨æ§åˆ¶æ•°æ®åº“æœåŠ¡å™¨
- éœ€è¦ä¸å…¶ä»–æœåŠ¡é›†æˆ

### æ­¥éª¤ 1ï¼šå‡†å¤‡è…¾è®¯äº‘æœåŠ¡å™¨

#### 1.1 è´­ä¹°äº‘æœåŠ¡å™¨

- ç™»å½• [è…¾è®¯äº‘æ§åˆ¶å°](https://console.cloud.tencent.com/)
- è´­ä¹°äº‘æœåŠ¡å™¨ CVMï¼ˆæ¨èé…ç½®ï¼š2æ ¸4Gï¼ŒUbuntu 20.04ï¼‰
- é…ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ç«¯å£ï¼š
    - 22 (SSH)
    - 5432 (PostgreSQL)
    - 80/443 (HTTP/HTTPSï¼Œå¦‚éœ€ Web è®¿é—®)

#### 1.2 è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@<YOUR_SERVER_IP>
```

### æ­¥éª¤ 2ï¼šå®‰è£… PostgreSQL

#### 2.1 å®‰è£… PostgreSQL 14

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… PostgreSQL
sudo apt install postgresql postgresql-contrib -y

# å¯åŠ¨ PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status postgresql
```

#### 2.2 é…ç½® PostgreSQL

```bash
# åˆ‡æ¢åˆ° postgres ç”¨æˆ·
sudo -i -u postgres

# è¿›å…¥ PostgreSQL å‘½ä»¤è¡Œ
psql

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE exam_analysis;

# åˆ›å»ºç”¨æˆ·
CREATE USER exam_user WITH PASSWORD 'your_secure_password';

# æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE exam_analysis TO exam_user;

# é€€å‡º
\q
exit
```

#### 2.3 é…ç½®è¿œç¨‹è®¿é—®

```bash
# ç¼–è¾‘ postgresql.conf
sudo nano /etc/postgresql/14/main/postgresql.conf

# ä¿®æ”¹ä»¥ä¸‹è¡Œï¼ˆå–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹ï¼‰
listen_addresses = '*'

# ç¼–è¾‘ pg_hba.conf
sudo nano /etc/postgresql/14/main/pg_hba.conf

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆå…è®¸æ‰€æœ‰ IP è®¿é—®ï¼Œç”Ÿäº§ç¯å¢ƒè¯·é™åˆ¶ IP èŒƒå›´ï¼‰
host    all             all             0.0.0.0/0               md5

# é‡å¯ PostgreSQL
sudo systemctl restart postgresql
```

### æ­¥éª¤ 3ï¼šå¯¼å…¥æ•°æ®

#### 3.1 ä» Supabase å¯¼å‡ºæ•°æ®

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œ
supabase db dump --file=complete_backup.sql
```

#### 3.2 ä¸Šä¼ åˆ°è…¾è®¯äº‘æœåŠ¡å™¨

```bash
# ä½¿ç”¨ scp ä¸Šä¼ 
scp complete_backup.sql root@<YOUR_SERVER_IP>:/tmp/

# æˆ–è€…ä½¿ç”¨ rsync
rsync -avz complete_backup.sql root@<YOUR_SERVER_IP>:/tmp/
```

#### 3.3 å¯¼å…¥æ•°æ®

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
sudo -i -u postgres
psql -d exam_analysis -f /tmp/complete_backup.sql
```

### æ­¥éª¤ 4ï¼šé…ç½®åº”ç”¨è¿æ¥

#### 4.1 æ›´æ–°ç¯å¢ƒå˜é‡

```env
# .env.local
VITE_SUPABASE_URL=http://<YOUR_SERVER_IP>:5432
VITE_SUPABASE_ANON_KEY=your_anon_key

# æˆ–è€…ä½¿ç”¨ PostgreSQL è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL=postgresql://exam_user:your_secure_password@<YOUR_SERVER_IP>:5432/exam_analysis
```

#### 4.2 å®‰è£… PostgRESTï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ REST API è®¿é—®ï¼š

```bash
# ä¸‹è½½ PostgREST
wget https://github.com/PostgREST/postgrest/releases/download/v10.0.0/postgrest-v10.0.0-linux-static-x64.tar.xz

# è§£å‹
tar -xf postgrest-v10.0.0-linux-static-x64.tar.xz

# ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
sudo mv postgrest /usr/local/bin/

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/postgrest.conf

# æ·»åŠ é…ç½®
db-uri = "postgres://exam_user:your_secure_password@localhost:5432/exam_analysis"
db-schema = "public"
db-anon-role = "exam_user"
server-port = 3000

# å¯åŠ¨ PostgREST
postgrest /etc/postgrest.conf
```

### æ­¥éª¤ 5ï¼šé…ç½® Nginx åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£… Nginx
sudo apt install nginx -y

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/exam_analysis

# æ·»åŠ é…ç½®
server {
    listen 80;
    server_name your_domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/exam_analysis /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## æ–¹æ¡ˆä¸‰ï¼šæ‰‹åŠ¨å¯¼å‡ºå¯¼å…¥æ–¹æ¡ˆ

### é€‚ç”¨åœºæ™¯
- å°é‡æ•°æ®è¿ç§»
- éœ€è¦é€‰æ‹©æ€§è¿ç§»éƒ¨åˆ†æ•°æ®
- æ— æ³•ä½¿ç”¨ CLI å·¥å…·

### æ­¥éª¤ 1ï¼šä½¿ç”¨ Supabase Dashboard å¯¼å‡º

#### 1.1 å¯¼å‡ºè¡¨ç»“æ„

1. ç™»å½• Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. æ‰§è¡Œä»¥ä¸‹ SQL è·å–å»ºè¡¨è¯­å¥ï¼š

```sql
-- è·å–æ‰€æœ‰è¡¨çš„å»ºè¡¨è¯­å¥
SELECT 
  'CREATE TABLE ' || table_name || ' (' || 
  string_agg(
    column_name || ' ' || data_type || 
    CASE WHEN character_maximum_length IS NOT NULL 
      THEN '(' || character_maximum_length || ')' 
      ELSE '' 
    END,
    ', '
  ) || ');'
FROM information_schema.columns
WHERE table_schema = 'public'
GROUP BY table_name;
```

#### 1.2 å¯¼å‡ºæ•°æ®

```sql
-- å¯¼å‡º profiles è¡¨æ•°æ®
COPY (SELECT * FROM profiles) TO STDOUT WITH CSV HEADER;

-- å¯¼å‡º exam_records è¡¨æ•°æ®
COPY (SELECT * FROM exam_records) TO STDOUT WITH CSV HEADER;

-- å¯¼å‡º module_scores è¡¨æ•°æ®
COPY (SELECT * FROM module_scores) TO STDOUT WITH CSV HEADER;

-- å¯¼å‡º user_settings è¡¨æ•°æ®
COPY (SELECT * FROM user_settings) TO STDOUT WITH CSV HEADER;

-- å¯¼å‡º vip_applications è¡¨æ•°æ®
COPY (SELECT * FROM vip_applications) TO STDOUT WITH CSV HEADER;
```

### æ­¥éª¤ 2ï¼šä½¿ç”¨ Supabase Dashboard å¯¼å…¥

#### 2.1 å¯¼å…¥è¡¨ç»“æ„

1. åœ¨ç›®æ ‡é¡¹ç›®çš„ SQL Editor ä¸­æ‰§è¡Œå»ºè¡¨è¯­å¥
2. æˆ–è€…ä½¿ç”¨ `COMPLETE_DATABASE_SETUP.sql` æ–‡ä»¶

#### 2.2 å¯¼å…¥æ•°æ®

```sql
-- å¯¼å…¥ profiles è¡¨æ•°æ®
COPY profiles FROM STDIN WITH CSV HEADER;
-- ç²˜è´´ CSV æ•°æ®
\.

-- å¯¼å…¥ exam_records è¡¨æ•°æ®
COPY exam_records FROM STDIN WITH CSV HEADER;
-- ç²˜è´´ CSV æ•°æ®
\.

-- å¯¼å…¥ module_scores è¡¨æ•°æ®
COPY module_scores FROM STDIN WITH CSV HEADER;
-- ç²˜è´´ CSV æ•°æ®
\.

-- å¯¼å…¥ user_settings è¡¨æ•°æ®
COPY user_settings FROM STDIN WITH CSV HEADER;
-- ç²˜è´´ CSV æ•°æ®
\.

-- å¯¼å…¥ vip_applications è¡¨æ•°æ®
COPY vip_applications FROM STDIN WITH CSV HEADER;
-- ç²˜è´´ CSV æ•°æ®
\.
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¯¼å‡ºæ—¶æç¤ºæƒé™ä¸è¶³ï¼Ÿ

**A**: ç¡®ä¿ä½¿ç”¨çš„æ˜¯ `postgres` ç”¨æˆ·æˆ–å…·æœ‰è¶³å¤Ÿæƒé™çš„ç”¨æˆ·ã€‚

```bash
# ä½¿ç”¨ postgres ç”¨æˆ·
sudo -i -u postgres
psql -d your_database
```

### Q2: å¯¼å…¥æ—¶æç¤ºå¤–é”®çº¦æŸé”™è¯¯ï¼Ÿ

**A**: æŒ‰ç…§ä¾èµ–é¡ºåºå¯¼å…¥è¡¨ï¼Œæˆ–è€…ä¸´æ—¶ç¦ç”¨å¤–é”®çº¦æŸã€‚

```sql
-- ç¦ç”¨å¤–é”®çº¦æŸ
SET session_replication_role = 'replica';

-- å¯¼å…¥æ•°æ®
-- ...

-- å¯ç”¨å¤–é”®çº¦æŸ
SET session_replication_role = 'origin';
```

### Q3: å¦‚ä½•åªè¿ç§»ç‰¹å®šç”¨æˆ·çš„æ•°æ®ï¼Ÿ

**A**: ä½¿ç”¨ WHERE æ¡ä»¶è¿‡æ»¤æ•°æ®ã€‚

```sql
-- å¯¼å‡ºç‰¹å®šç”¨æˆ·çš„æ•°æ®
COPY (
  SELECT * FROM exam_records 
  WHERE user_id = 'specific-user-id'
) TO STDOUT WITH CSV HEADER;
```

### Q4: è¿ç§»å RLS ç­–ç•¥ä¸ç”Ÿæ•ˆï¼Ÿ

**A**: æ£€æŸ¥ RLS æ˜¯å¦å¯ç”¨ï¼Œå¹¶é‡æ–°åˆ›å»ºç­–ç•¥ã€‚

```sql
-- å¯ç”¨ RLS
ALTER TABLE your_table ENABLE ROW LEVEL SECURITY;

-- æ£€æŸ¥ç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'your_table';
```

### Q5: å¦‚ä½•éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Ÿ

**A**: å¯¹æ¯”æºå’Œç›®æ ‡æ•°æ®åº“çš„æ•°æ®é‡å’Œæ ¡éªŒå’Œã€‚

```sql
-- æ£€æŸ¥æ•°æ®é‡
SELECT COUNT(*) FROM profiles;

-- æ£€æŸ¥æ•°æ®æ ¡éªŒå’Œï¼ˆPostgreSQL 14+ï¼‰
SELECT md5(string_agg(id::text, '' ORDER BY id)) 
FROM profiles;
```

---

## ğŸ“Š è¿ç§»æ£€æŸ¥æ¸…å•

### è¿ç§»å‰
- [ ] å¤‡ä»½æºæ•°æ®åº“
- [ ] ç¡®è®¤ç›®æ ‡æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### è¿ç§»ä¸­
- [ ] å¯¼å‡ºæ•°æ®åº“ç»“æ„
- [ ] å¯¼å‡ºæ•°æ®
- [ ] éªŒè¯å¯¼å‡ºæ–‡ä»¶å®Œæ•´æ€§
- [ ] å¯¼å…¥æ•°æ®åº“ç»“æ„
- [ ] å¯¼å…¥æ•°æ®
- [ ] éªŒè¯å¯¼å…¥ç»“æœ

### è¿ç§»å
- [ ] æ£€æŸ¥è¡¨ç»“æ„
- [ ] æ£€æŸ¥æ•°æ®é‡
- [ ] æ£€æŸ¥ç´¢å¼•
- [ ] æ£€æŸ¥è§¦å‘å™¨
- [ ] æ£€æŸ¥ RLS ç­–ç•¥
- [ ] æµ‹è¯•åº”ç”¨åŠŸèƒ½
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡
- [ ] æ›´æ–°æ–‡æ¡£

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. åˆ†æ‰¹è¿ç§»
- å¯¹äºå¤§é‡æ•°æ®ï¼Œå»ºè®®åˆ†æ‰¹è¿ç§»
- æ¯æ‰¹è¿ç§»åéªŒè¯æ•°æ®å®Œæ•´æ€§

### 2. ä½¿ç”¨äº‹åŠ¡
```sql
BEGIN;
-- å¯¼å…¥æ•°æ®
COMMIT;
-- æˆ–è€…å›æ»š
ROLLBACK;
```

### 3. ç›‘æ§è¿ç§»è¿›åº¦
```bash
# ä½¿ç”¨ pv ç›‘æ§è¿›åº¦
pv data.sql | psql -d target_database
```

### 4. ä¿ç•™è¿ç§»æ—¥å¿—
```bash
# è®°å½•è¿ç§»æ—¥å¿—
psql -d target_database -f data.sql > migration.log 2>&1
```

### 5. å®šæœŸå¤‡ä»½
```bash
# è®¾ç½®å®šæ—¶å¤‡ä»½
crontab -e

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * pg_dump exam_analysis > /backup/exam_analysis_$(date +\%Y\%m\%d).sql
```
