# Migration æ–‡ä»¶ç®¡ç†æŒ‡å—

## ğŸ“‹ å½“å‰çŠ¶æ€

é¡¹ç›®ä¸­æœ‰ **28 ä¸ª migration æ–‡ä»¶**ï¼Œè¿™æ˜¯æ­£å¸¸çš„å¼€å‘è¿‡ç¨‹äº§ç‰©ã€‚æ¯ä¸ªæ–‡ä»¶è®°å½•äº†ä¸€æ¬¡æ•°æ®åº“ç»“æ„çš„å˜æ›´ã€‚

## ğŸ¤” ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šæ–‡ä»¶ï¼Ÿ

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡å¯¹æ•°æ®åº“ç»“æ„çš„ä¿®æ”¹éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ migration æ–‡ä»¶ï¼š

```
å¼€å‘æµç¨‹ï¼š
éœ€æ±‚å˜æ›´ â†’ ä¿®æ”¹æ•°æ®åº“ â†’ ç”Ÿæˆ migration æ–‡ä»¶ â†’ æµ‹è¯• â†’ æäº¤

ç¤ºä¾‹ï¼š
1. åˆ›å»ºè€ƒè¯•è®°å½•è¡¨ â†’ 00001_create_exam_tables.sql
2. æ·»åŠ è€ƒè¯•åç§°å­—æ®µ â†’ 00003_add_exam_details.sql
3. æ·»åŠ æ˜Ÿçº§è¯„åˆ†å­—æ®µ â†’ 00007_add_rating_and_exam_name.sql
4. æ·»åŠ è½¯åˆ é™¤åŠŸèƒ½ â†’ 00023_add_soft_delete.sql
...
```

è¿™æ ·åšçš„å¥½å¤„ï¼š
- âœ… **å¯è¿½æº¯**ï¼šå¯ä»¥çœ‹åˆ°æ•°æ®åº“çš„æ¼”å˜å†å²
- âœ… **å¯å›æ»š**ï¼šå¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›é€€åˆ°ä¹‹å‰çš„ç‰ˆæœ¬
- âœ… **å›¢é˜Ÿåä½œ**ï¼šå…¶ä»–å¼€å‘è€…å¯ä»¥åŒæ­¥æ•°æ®åº“å˜æ›´

## ğŸš€ éƒ¨ç½²æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ

### æ–¹å¼ä¸€ï¼šä½¿ç”¨å®Œæ•´ SQL è„šæœ¬ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šé¦–æ¬¡éƒ¨ç½²ã€æ›´æ¢ Supabase é¡¹ç›®

**æ“ä½œæ­¥éª¤**ï¼š
1. æ‰§è¡Œ `supabase/COMPLETE_DATABASE_SETUP.sql`
2. å®Œæˆï¼

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•å¿«é€Ÿ
- âœ… ä¸éœ€è¦é€ä¸ªæ‰§è¡Œ migration æ–‡ä»¶
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**è¯´æ˜**ï¼š
`COMPLETE_DATABASE_SETUP.sql` æ˜¯ä¸€ä¸ªåˆå¹¶åçš„å®Œæ•´è„šæœ¬ï¼ŒåŒ…å«äº†æ‰€æœ‰ migration æ–‡ä»¶çš„æœ€ç»ˆç»“æœã€‚

---

## ğŸ—‚ï¸ Migration æ–‡ä»¶åˆ†ç±»

### å¿…éœ€æ–‡ä»¶ï¼ˆâœ…ï¼‰

è¿™äº›æ–‡ä»¶åŒ…å«æ ¸å¿ƒè¡¨ç»“æ„å’ŒåŠŸèƒ½ï¼Œå¿…é¡»æ‰§è¡Œï¼š

| æ–‡ä»¶å | è¯´æ˜ |
|--------|------|
| `00001_create_exam_tables.sql` | åˆ›å»ºè€ƒè¯•è®°å½•è¡¨å’Œæ¨¡å—æˆç»©è¡¨ |
| `00002_create_settings_table.sql` | åˆ›å»ºç”¨æˆ·è®¾ç½®è¡¨ |
| `00017_add_user_authentication.sql` | æ·»åŠ ç”¨æˆ·è®¤è¯åŠŸèƒ½ |
| `00018_create_public_uid_function.sql` | åˆ›å»ºå…¬å¼€ç”¨æˆ· ID å‡½æ•° |
| `00019_add_username_constraints_and_check_function.sql` | æ·»åŠ ç”¨æˆ·åçº¦æŸ |
| `00022_extend_session_duration.sql` | å»¶é•¿ä¼šè¯æ—¶é—´ |
| `00023_add_soft_delete.sql` | æ·»åŠ è½¯åˆ é™¤åŠŸèƒ½ |
| `00025_create_payment_tables.sql` | åˆ›å»ºæ”¯ä»˜ç›¸å…³è¡¨ |
| `00026_create_vip_tables.sql` | åˆ›å»º VIP ç›¸å…³è¡¨ |

### å¢é‡æ›´æ–°æ–‡ä»¶ï¼ˆâœ…ï¼‰

è¿™äº›æ–‡ä»¶æ·»åŠ äº†æ–°å­—æ®µæˆ–åŠŸèƒ½ï¼š

| æ–‡ä»¶å | è¯´æ˜ |
|--------|------|
| `00003_add_exam_details.sql` | æ·»åŠ è€ƒè¯•è¯¦æƒ…å­—æ®µ |
| `00004_add_exam_countdown.sql` | æ·»åŠ å€’è®¡æ—¶å­—æ®µ |
| `00005_add_notes_and_exam_date.sql` | æ·»åŠ ç¬”è®°å’Œè€ƒè¯•æ—¥æœŸ |
| `00006_add_sort_order.sql` | æ·»åŠ æ’åºå­—æ®µ |
| `00007_add_rating_and_exam_name.sql` | æ·»åŠ æ˜Ÿçº§è¯„åˆ†å’Œè€ƒè¯•åç§° |
| `00008_add_notes_fields.sql` | æ·»åŠ ç¬”è®°è¯¦ç»†å­—æ®µ |
| `00016_add_include_in_stats_to_exam_records.sql` | æ·»åŠ åŒ…å«åœ¨ç»Ÿè®¡ä¸­å­—æ®µ |
| `20251207_sort_by_exam_date.sql` | æŒ‰è€ƒè¯•æ—¥æœŸæ’åº |
| `20251209_add_exam_type.sql` | æ·»åŠ è€ƒè¯•ç±»å‹ |
| `20251210_add_grade_label_theme.sql` | æ·»åŠ æˆç»©æ ‡ç­¾ä¸»é¢˜ |
| `20251222_add_learning_journey_fields.sql` | æ·»åŠ å­¦ä¹ å†ç¨‹å­—æ®µ |

### å¼€å‘ç¯å¢ƒæ–‡ä»¶ï¼ˆâš ï¸ï¼‰

è¿™äº›æ–‡ä»¶ç”¨äºå¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦ä¿®æ”¹ï¼š

| æ–‡ä»¶å | è¯´æ˜ | ç”Ÿäº§ç¯å¢ƒå¤„ç† |
|--------|------|-------------|
| `00014_disable_rls_user_settings.sql` | ç¦ç”¨ç”¨æˆ·è®¾ç½®è¡¨ RLS | å¯ç”¨ RLS |
| `00015_disable_rls_exam_config.sql` | ç¦ç”¨è€ƒè¯•é…ç½®è¡¨ RLS | å¯ç”¨ RLS |
| `20251219_disable_rls_for_v301.sql` | ç¦ç”¨ v3.0.1 RLS | å¯ç”¨ RLS |

### ä¿®å¤æ–‡ä»¶ï¼ˆâœ…ï¼‰

è¿™äº›æ–‡ä»¶ä¿®å¤äº†ä¹‹å‰çš„é—®é¢˜ï¼š

| æ–‡ä»¶å | è¯´æ˜ |
|--------|------|
| `00020_fix_exam_records_rls_policy.sql` | ä¿®å¤è€ƒè¯•è®°å½• RLS ç­–ç•¥ |
| `00021_cleanup_duplicate_user_settings_policy.sql` | æ¸…ç†é‡å¤çš„ç”¨æˆ·è®¾ç½®ç­–ç•¥ |
| `00024_add_soft_delete_fixed.sql` | ä¿®å¤è½¯åˆ é™¤åŠŸèƒ½ |
| `20251220_fix_v301_compatibility.sql` | ä¿®å¤ v3.0.1 å…¼å®¹æ€§ |

### VIP åŠŸèƒ½æ–‡ä»¶ï¼ˆâœ…ï¼‰

è¿™äº›æ–‡ä»¶æ·»åŠ äº† VIP ä¼šå‘˜åŠŸèƒ½ï¼š

| æ–‡ä»¶å | è¯´æ˜ |
|--------|------|
| `00027_create_admin_activate_vip_rpc.sql` | åˆ›å»ºç®¡ç†å‘˜æ¿€æ´» VIP çš„ RPC |
| `00028_add_vip_type_field.sql` | æ·»åŠ  VIP ç±»å‹å­—æ®µ |

---

## ğŸ§¹ å¦‚ä½•æ¸…ç† Migration æ–‡ä»¶ï¼Ÿ

### âš ï¸ è­¦å‘Š

**ä¸è¦ç›´æ¥åˆ é™¤å·²ç»æ‰§è¡Œè¿‡çš„ migration æ–‡ä»¶ï¼**

å¦‚æœåˆ é™¤äº†å·²æ‰§è¡Œçš„ migration æ–‡ä»¶ï¼Œä¼šå¯¼è‡´ï¼š
- âŒ æ•°æ®åº“ç‰ˆæœ¬è®°å½•ä¸ä¸€è‡´
- âŒ å›¢é˜Ÿæˆå‘˜æ— æ³•åŒæ­¥æ•°æ®åº“
- âŒ æ— æ³•å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬

### æ¨èåšæ³•

#### æ–¹æ¡ˆä¸€ï¼šä¿ç•™æ‰€æœ‰æ–‡ä»¶ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘ç¯å¢ƒã€å›¢é˜Ÿåä½œ

**è¯´æ˜**ï¼š
- ä¿ç•™æ‰€æœ‰ migration æ–‡ä»¶
- ä½¿ç”¨ Git ç®¡ç†ç‰ˆæœ¬
- æ–°éƒ¨ç½²æ—¶ä½¿ç”¨ `COMPLETE_DATABASE_SETUP.sql`

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œæ•´çš„å˜æ›´å†å²
- âœ… å¯ä»¥å›æ»šåˆ°ä»»æ„ç‰ˆæœ¬
- âœ… å›¢é˜Ÿæˆå‘˜å¯ä»¥åŒæ­¥

---

#### æ–¹æ¡ˆäºŒï¼šå½’æ¡£æ—§æ–‡ä»¶

**é€‚ç”¨åœºæ™¯**ï¼šæ–‡ä»¶è¿‡å¤šï¼Œéœ€è¦æ•´ç†

**æ“ä½œæ­¥éª¤**ï¼š

1. **åˆ›å»ºå½’æ¡£ç›®å½•**
   ```bash
   mkdir -p supabase/migrations/archive
   ```

2. **ç§»åŠ¨æ—§æ–‡ä»¶**
   ```bash
   # ç§»åŠ¨å¼€å‘ç¯å¢ƒä¸“ç”¨æ–‡ä»¶
   mv supabase/migrations/00014_disable_rls_*.sql supabase/migrations/archive/
   mv supabase/migrations/00015_disable_rls_*.sql supabase/migrations/archive/
   
   # ç§»åŠ¨å·²è¢«ä¿®å¤çš„æ–‡ä»¶
   mv supabase/migrations/00023_add_soft_delete.sql supabase/migrations/archive/
   # (ä¿ç•™ 00024_add_soft_delete_fixed.sql)
   ```

3. **æ›´æ–°æ–‡æ¡£**
   - åœ¨ `archive/README.md` ä¸­è¯´æ˜å½’æ¡£åŸå› 
   - æ›´æ–° `SUPABASE_DATABASE_GUIDE.md`

**æ³¨æ„**ï¼š
- âš ï¸ ä»…å½’æ¡£ï¼Œä¸è¦åˆ é™¤
- âš ï¸ ç¡®ä¿ `COMPLETE_DATABASE_SETUP.sql` åŒ…å«æœ€æ–°ç»“æ„
- âš ï¸ é€šçŸ¥å›¢é˜Ÿæˆå‘˜

---

#### æ–¹æ¡ˆä¸‰ï¼šé‡ç½® Migration å†å²ï¼ˆé«˜çº§ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šé¡¹ç›®é‡æ„ã€æ¸…ç†å†å²

**âš ï¸ è­¦å‘Š**ï¼šæ­¤æ“ä½œä¸å¯é€†ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨ï¼š
- é¡¹ç›®è¿˜æœªä¸Šçº¿
- æ²¡æœ‰å…¶ä»–å¼€å‘è€…ä¾èµ–ç°æœ‰ migration
- å·²å¤‡ä»½æ‰€æœ‰æ•°æ®

**æ“ä½œæ­¥éª¤**ï¼š

1. **å¤‡ä»½å½“å‰æ•°æ®åº“ç»“æ„**
   ```bash
   # ä½¿ç”¨ Supabase CLI
   supabase db dump --schema-only > backup_schema.sql
   ```

2. **åˆ›å»ºæ–°çš„åˆå§‹ migration**
   ```bash
   # åˆ é™¤æ‰€æœ‰æ—§ migrationï¼ˆå·²å¤‡ä»½ï¼‰
   rm supabase/migrations/*.sql
   
   # åˆ›å»ºæ–°çš„åˆå§‹ migration
   cp supabase/COMPLETE_DATABASE_SETUP.sql supabase/migrations/00001_initial_setup.sql
   ```

3. **é‡ç½®æ•°æ®åº“**
   ```bash
   supabase db reset
   supabase db push
   ```

4. **éªŒè¯**
   - æ£€æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»º
   - æ£€æŸ¥æ‰€æœ‰ç´¢å¼•å’Œè§¦å‘å™¨
   - æµ‹è¯•åº”ç”¨åŠŸèƒ½

---

## ğŸ“Š Migration æ–‡ä»¶ç»Ÿè®¡

### å½“å‰çŠ¶æ€

```
æ€»æ–‡ä»¶æ•°ï¼š28 ä¸ª
â”œâ”€â”€ æ ¸å¿ƒè¡¨ç»“æ„ï¼š9 ä¸ª
â”œâ”€â”€ å¢é‡æ›´æ–°ï¼š11 ä¸ª
â”œâ”€â”€ å¼€å‘ç¯å¢ƒï¼š3 ä¸ª
â”œâ”€â”€ ä¿®å¤æ–‡ä»¶ï¼š4 ä¸ª
â””â”€â”€ VIP åŠŸèƒ½ï¼š2 ä¸ª
```

### åˆå¹¶å

ä½¿ç”¨ `COMPLETE_DATABASE_SETUP.sql` åï¼š

```
æ€»æ–‡ä»¶æ•°ï¼š1 ä¸ª
â””â”€â”€ å®Œæ•´æ•°æ®åº“è®¾ç½®è„šæœ¬
```

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹ Migration æ‰§è¡ŒçŠ¶æ€ï¼Ÿ

### åœ¨ Supabase Dashboard ä¸­æŸ¥çœ‹

1. è¿›å…¥é¡¹ç›®çš„ **SQL Editor**
2. æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼š

```sql
-- æŸ¥çœ‹å·²æ‰§è¡Œçš„ migrations
SELECT * FROM supabase_migrations.schema_migrations
ORDER BY version DESC;
```

### ä½¿ç”¨ Supabase CLI æŸ¥çœ‹

```bash
# æŸ¥çœ‹ migration çŠ¶æ€
supabase migration list

# æŸ¥çœ‹æœªæ‰§è¡Œçš„ migrations
supabase db diff
```

---

## ğŸ“ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ

1. **ä½¿ç”¨ Migration æ–‡ä»¶**
   - æ¯æ¬¡æ•°æ®åº“å˜æ›´åˆ›å»ºæ–°çš„ migration
   - ä½¿ç”¨ `supabase db push` åŒæ­¥

2. **å‘½åè§„èŒƒ**
   ```
   [åºå·]_[æ“ä½œç±»å‹]_[æè¿°].sql
   
   ç¤ºä¾‹ï¼š
   00029_add_user_avatar.sql
   00030_create_comments_table.sql
   ```

3. **æäº¤åˆ° Git**
   - æ¯ä¸ª migration æ–‡ä»¶å•ç‹¬æäº¤
   - æäº¤ä¿¡æ¯åŒ…å«å˜æ›´è¯´æ˜

### ç”Ÿäº§ç¯å¢ƒ

1. **ä½¿ç”¨å®Œæ•´ SQL è„šæœ¬**
   - é¦–æ¬¡éƒ¨ç½²ä½¿ç”¨ `COMPLETE_DATABASE_SETUP.sql`
   - åç»­æ›´æ–°ä½¿ç”¨å¢é‡ migration

2. **å¤‡ä»½æ•°æ®**
   - éƒ¨ç½²å‰å¤‡ä»½æ•°æ®åº“
   - æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

3. **å¯ç”¨ RLS**
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ RLS ç­–ç•¥
   - å‚è€ƒ `SUPABASE_DATABASE_GUIDE.md`

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: å¯ä»¥åˆ é™¤ migration æ–‡ä»¶å—ï¼Ÿ

**A**: ä¸å»ºè®®åˆ é™¤å·²æ‰§è¡Œçš„ migration æ–‡ä»¶ã€‚å¦‚æœéœ€è¦æ¸…ç†ï¼Œè¯·ä½¿ç”¨å½’æ¡£æ–¹å¼ã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„è¡¨æˆ–å­—æ®µï¼Ÿ

**A**: 

**å¼€å‘ç¯å¢ƒ**ï¼š
```bash
# åˆ›å»ºæ–°çš„ migration
supabase migration new add_new_field

# ç¼–è¾‘ç”Ÿæˆçš„æ–‡ä»¶
# supabase/migrations/[timestamp]_add_new_field.sql

# æ¨é€åˆ°æ•°æ®åº“
supabase db push
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```sql
-- ç›´æ¥åœ¨ SQL Editor ä¸­æ‰§è¡Œ
ALTER TABLE exam_records
ADD COLUMN new_field TEXT;
```

### Q: Migration æ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: 

1. **æŸ¥çœ‹é”™è¯¯ä¿¡æ¯**
   - Supabase Dashboard â†’ **Logs**
   - æˆ– `supabase db push` çš„è¾“å‡º

2. **å¸¸è§é”™è¯¯**
   - è¡¨å·²å­˜åœ¨ï¼šä½¿ç”¨ `IF NOT EXISTS`
   - å­—æ®µå·²å­˜åœ¨ï¼šä½¿ç”¨ `IF NOT EXISTS` æˆ–å…ˆæ£€æŸ¥
   - å¤–é”®çº¦æŸï¼šç¡®ä¿å¼•ç”¨çš„è¡¨å­˜åœ¨

3. **å›æ»š**
   ```bash
   # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
   supabase db reset
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [SUPABASE_DATABASE_GUIDE.md](./SUPABASE_DATABASE_GUIDE.md) - å®Œæ•´æ•°æ®åº“æŒ‡å—
- [QUICK_DEPLOY_GUIDE.md](./QUICK_DEPLOY_GUIDE.md) - å¿«é€Ÿéƒ¨ç½²æŒ‡å—
- [supabase/COMPLETE_DATABASE_SETUP.sql](./supabase/COMPLETE_DATABASE_SETUP.sql) - å®Œæ•´æ•°æ®åº“è„šæœ¬

---
