# ğŸš€ ç™¾åº¦äº‘éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æ¶æ„å˜æ›´è¯´æ˜](#2-æ¶æ„å˜æ›´è¯´æ˜)
- [3. ç™¾åº¦äº‘æœåŠ¡å‡†å¤‡](#3-ç™¾åº¦äº‘æœåŠ¡å‡†å¤‡)
- [4. æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ](#4-æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ)
- [5. è®¤è¯ç³»ç»Ÿæ”¹é€ ](#5-è®¤è¯ç³»ç»Ÿæ”¹é€ )
- [6. API æ¥å£æ¢³ç†](#6-api-æ¥å£æ¢³ç†)
- [7. éƒ¨ç½²æ­¥éª¤](#7-éƒ¨ç½²æ­¥éª¤)
- [8. æµ‹è¯•éªŒè¯](#8-æµ‹è¯•éªŒè¯)
- [9. å¸¸è§é—®é¢˜](#9-å¸¸è§é—®é¢˜)

---

## 1. æ¦‚è¿°

### 1.1 éƒ¨ç½²ç›®æ ‡

å°†è€ƒè¯•æˆç»©åˆ†æç³»ç»Ÿä» Supabase è¿ç§»åˆ°ç™¾åº¦äº‘ï¼Œä½¿ç”¨ç™¾åº¦äº‘çš„çŸ­ä¿¡éªŒè¯ç æœåŠ¡æ›¿ä»£ Supabase Authã€‚

### 1.2 æ ¸å¿ƒå˜æ›´

| åŠŸèƒ½æ¨¡å— | åŸæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|---------|--------|--------|
| ç”¨æˆ·è®¤è¯ | Supabase Auth | ç™¾åº¦äº‘çŸ­ä¿¡éªŒè¯ç  + JWT |
| æ•°æ®åº“ | Supabase PostgreSQL | ç™¾åº¦äº‘ RDS PostgreSQL |
| æ–‡ä»¶å­˜å‚¨ | Supabase Storage | ç™¾åº¦äº‘ BOS |
| API æœåŠ¡ | Supabase Edge Functions | ç™¾åº¦äº‘å‡½æ•°è®¡ç®— CFC |
| å‰ç«¯æ‰˜ç®¡ | Vercel/Netlify | ç™¾åº¦äº‘ CDN + BOS |

### 1.3 æŠ€æœ¯æ ˆ

- **å‰ç«¯**: React + TypeScript + Vite + Ant Design
- **åç«¯**: Node.js + Expressï¼ˆæˆ–ç™¾åº¦äº‘å‡½æ•°è®¡ç®—ï¼‰
- **æ•°æ®åº“**: PostgreSQL 14+
- **è®¤è¯**: JWT + ç™¾åº¦äº‘çŸ­ä¿¡éªŒè¯ç 
- **å­˜å‚¨**: ç™¾åº¦äº‘ BOSï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰

---

## 2. æ¶æ„å˜æ›´è¯´æ˜

### 2.1 åŸæ¶æ„ï¼ˆSupabaseï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨   â”‚
â”‚  (React)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase    â”‚   â”‚ Supabase    â”‚
â”‚ Auth        â”‚   â”‚ PostgreSQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  Supabase   â”‚
         â”‚  Storage    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–°æ¶æ„ï¼ˆç™¾åº¦äº‘ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨   â”‚
â”‚  (React)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                 â”‚                 â”‚
       â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç™¾åº¦äº‘çŸ­ä¿¡   â”‚   â”‚ ç™¾åº¦äº‘ RDS  â”‚   â”‚ ç™¾åº¦äº‘ BOS  â”‚
â”‚ éªŒè¯ç æœåŠ¡   â”‚   â”‚ PostgreSQL  â”‚   â”‚ å¯¹è±¡å­˜å‚¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  ç™¾åº¦äº‘ CFC  â”‚   â”‚  ç™¾åº¦äº‘ CDN â”‚
         â”‚  å‡½æ•°è®¡ç®—    â”‚   â”‚  å†…å®¹åˆ†å‘   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç™¾åº¦äº‘æœåŠ¡å‡†å¤‡

### 3.2 å¼€é€šæ‰€éœ€æœåŠ¡

#### 3.2.1 äº‘æœåŠ¡å™¨ BCCï¼ˆBaidu Cloud Computeï¼‰

**æ¨èé…ç½®**:
- **CPU**: 2æ ¸
- **å†…å­˜**: 4GB
- **ç¡¬ç›˜**: 40GB SSD
- **å¸¦å®½**: 5Mbps
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS

**è´­ä¹°æ­¥éª¤**:
1. ç™»å½•ç™¾åº¦äº‘æ§åˆ¶å°
2. è¿›å…¥"äº‘æœåŠ¡å™¨ BCC"
3. ç‚¹å‡»"è´­ä¹°å®ä¾‹"
4. é€‰æ‹©é…ç½®å¹¶å®Œæˆè´­ä¹°
5. é…ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ç«¯å£ï¼š
   - 22 (SSH)
   - 80 (HTTP)
   - 443 (HTTPS)
   - 5432 (PostgreSQLï¼Œä»…å†…ç½‘è®¿é—®)
   - 3000 (API æœåŠ¡ï¼Œå¯é€‰)

#### 3.2.2 äº‘æ•°æ®åº“ RDS PostgreSQL

**æ¨èé…ç½®**:
- **ç‰ˆæœ¬**: PostgreSQL 14
- **è§„æ ¼**: 1æ ¸2GBï¼ˆå…¥é—¨ç‰ˆï¼‰
- **å­˜å‚¨**: 20GB SSD
- **ç½‘ç»œ**: VPC ç§æœ‰ç½‘ç»œ

**è´­ä¹°æ­¥éª¤**:
1. è¿›å…¥"äº‘æ•°æ®åº“ RDS"
2. é€‰æ‹© PostgreSQL å¼•æ“
3. é€‰æ‹©é…ç½®å¹¶å®Œæˆè´­ä¹°
4. è®°å½•æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š
   - å†…ç½‘åœ°å€
   - ç«¯å£ï¼ˆé»˜è®¤ 5432ï¼‰
   - æ•°æ®åº“å
   - ç”¨æˆ·å
   - å¯†ç 

#### 3.2.3 å¯¹è±¡å­˜å‚¨ BOSï¼ˆBaidu Object Storageï¼‰

**è´­ä¹°æ­¥éª¤**:
1. è¿›å…¥"å¯¹è±¡å­˜å‚¨ BOS"
2. åˆ›å»º Bucket
   - Bucket åç§°ï¼š`exam-analysis-storage`
   - åœ°åŸŸï¼šé€‰æ‹©ä¸ BCC ç›¸åŒåœ°åŸŸ
   - è®¿é—®æƒé™ï¼šç§æœ‰
3. åˆ›å»ºè®¿é—®å¯†é’¥ï¼ˆAccess Keyï¼‰
   - è¿›å…¥"å®‰å…¨è®¤è¯"
   - åˆ›å»º Access Key ID å’Œ Secret Access Key
   - **é‡è¦**: å¦¥å–„ä¿ç®¡å¯†é’¥

#### 3.2.4 çŸ­ä¿¡æœåŠ¡

**å¼€é€šæ­¥éª¤**:
1. è¿›å…¥"çŸ­ä¿¡æœåŠ¡"
2. å¼€é€šæœåŠ¡å¹¶å®Œæˆè®¤è¯
3. åˆ›å»ºçŸ­ä¿¡ç­¾å
   - ç­¾åå†…å®¹ï¼š`ã€è€ƒè¯•åˆ†æã€‘`
   - ç­¾åç±»å‹ï¼šç½‘ç«™/åº”ç”¨
4. åˆ›å»ºçŸ­ä¿¡æ¨¡æ¿
   - æ¨¡æ¿å†…å®¹ï¼š`æ‚¨çš„éªŒè¯ç æ˜¯{1}ï¼Œ{2}åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¯·å‹¿æ³„éœ²ã€‚`
   - æ¨¡æ¿ç±»å‹ï¼šéªŒè¯ç 
5. è·å– API å‡­è¯
   - Access Key ID
   - Secret Access Key

**æ³¨æ„**: æ ¹æ®æ‚¨æä¾›çš„ API ä¿¡æ¯ï¼Œæ‚¨å·²ç»æœ‰çŸ­ä¿¡éªŒè¯ç æœåŠ¡çš„æ¥å£ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

#### 3.2.5 å‡½æ•°è®¡ç®— CFCï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨ Serverless æ¶æ„ï¼š

1. è¿›å…¥"å‡½æ•°è®¡ç®— CFC"
2. åˆ›å»ºå‡½æ•°
3. é…ç½®è§¦å‘å™¨ï¼ˆHTTP è§¦å‘å™¨ï¼‰

---

## 4. æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ

### 4.1 æ•°æ®åº“è¡¨ç»“æ„è°ƒæ•´

#### 4.1.1 åŸè¡¨ç»“æ„ï¼ˆSupabaseï¼‰

åŸç³»ç»Ÿä½¿ç”¨ Supabase Authï¼Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ `auth.users` è¡¨ä¸­ï¼Œä¸šåŠ¡è¡¨é€šè¿‡å¤–é”®å…³è”ã€‚

#### 4.1.2 æ–°è¡¨ç»“æ„ï¼ˆç™¾åº¦äº‘ï¼‰

éœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ `users` è¡¨æ¥æ›¿ä»£ Supabase Authã€‚

**æ–°å¢ users è¡¨**:

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) UNIQUE NOT NULL,
  nickname VARCHAR(50),
  avatar_url TEXT,
  role VARCHAR(20) NOT NULL DEFAULT 'user',
  is_vip BOOLEAN NOT NULL DEFAULT FALSE,
  vip_expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,
  
  CONSTRAINT users_role_check 
    CHECK (role IN ('user', 'admin'))
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_vip ON users(is_vip);

-- åˆ›å»ºè§¦å‘å™¨ï¼ˆè‡ªåŠ¨æ›´æ–° updated_atï¼‰
CREATE OR REPLACE FUNCTION update_users_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_users_updated_at();

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨';
COMMENT ON COLUMN users.id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN users.phone IS 'æ‰‹æœºå·';
COMMENT ON COLUMN users.nickname IS 'æ˜µç§°';
COMMENT ON COLUMN users.avatar_url IS 'å¤´åƒURL';
COMMENT ON COLUMN users.role IS 'è§’è‰²ï¼šuser-æ™®é€šç”¨æˆ·, admin-ç®¡ç†å‘˜';
COMMENT ON COLUMN users.is_vip IS 'æ˜¯å¦VIP';
COMMENT ON COLUMN users.vip_expires_at IS 'VIPè¿‡æœŸæ—¶é—´';
COMMENT ON COLUMN users.created_at IS 'åˆ›å»ºæ—¶é—´';
COMMENT ON COLUMN users.updated_at IS 'æ›´æ–°æ—¶é—´';
COMMENT ON COLUMN users.last_login_at IS 'æœ€åç™»å½•æ—¶é—´';
```

**æ–°å¢ user_sessions è¡¨ï¼ˆç”¨äºç®¡ç†ç™»å½•ä¼šè¯ï¼‰**:

```sql
-- ç”¨æˆ·ä¼šè¯è¡¨
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token TEXT NOT NULL UNIQUE,
  refresh_token TEXT UNIQUE,
  expires_at TIMESTAMPTZ NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_token ON user_sessions(token);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_update_user_sessions_updated_at
  BEFORE UPDATE ON user_sessions
  FOR EACH ROW
  EXECUTE FUNCTION update_users_updated_at();

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE user_sessions IS 'ç”¨æˆ·ä¼šè¯è¡¨';
COMMENT ON COLUMN user_sessions.id IS 'ä¼šè¯ID';
COMMENT ON COLUMN user_sessions.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN user_sessions.token IS 'è®¿é—®ä»¤ç‰Œï¼ˆJWTï¼‰';
COMMENT ON COLUMN user_sessions.refresh_token IS 'åˆ·æ–°ä»¤ç‰Œ';
COMMENT ON COLUMN user_sessions.expires_at IS 'è¿‡æœŸæ—¶é—´';
COMMENT ON COLUMN user_sessions.ip_address IS 'IPåœ°å€';
COMMENT ON COLUMN user_sessions.user_agent IS 'ç”¨æˆ·ä»£ç†';
```

**æ–°å¢ sms_verification_codes è¡¨ï¼ˆç”¨äºç®¡ç†çŸ­ä¿¡éªŒè¯ç ï¼‰**:

```sql
-- çŸ­ä¿¡éªŒè¯ç è¡¨
CREATE TABLE sms_verification_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(6) NOT NULL,
  session_id UUID NOT NULL,
  purpose VARCHAR(20) NOT NULL,
  is_used BOOLEAN NOT NULL DEFAULT FALSE,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT sms_verification_codes_purpose_check 
    CHECK (purpose IN ('login', 'register', 'reset_password'))
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_sms_codes_phone ON sms_verification_codes(phone);
CREATE INDEX idx_sms_codes_session_id ON sms_verification_codes(session_id);
CREATE INDEX idx_sms_codes_expires_at ON sms_verification_codes(expires_at);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE sms_verification_codes IS 'çŸ­ä¿¡éªŒè¯ç è¡¨';
COMMENT ON COLUMN sms_verification_codes.id IS 'éªŒè¯ç ID';
COMMENT ON COLUMN sms_verification_codes.phone IS 'æ‰‹æœºå·';
COMMENT ON COLUMN sms_verification_codes.code IS 'éªŒè¯ç ';
COMMENT ON COLUMN sms_verification_codes.session_id IS 'ä¼šè¯ID';
COMMENT ON COLUMN sms_verification_codes.purpose IS 'ç”¨é€”ï¼šlogin-ç™»å½•, register-æ³¨å†Œ, reset_password-é‡ç½®å¯†ç ';
COMMENT ON COLUMN sms_verification_codes.is_used IS 'æ˜¯å¦å·²ä½¿ç”¨';
COMMENT ON COLUMN sms_verification_codes.expires_at IS 'è¿‡æœŸæ—¶é—´';
```

#### 4.1.3 ä¿®æ”¹ç°æœ‰è¡¨ç»“æ„

**ä¿®æ”¹ profiles è¡¨**:

```sql
-- åˆ é™¤åŸæœ‰çš„ profiles è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP TABLE IF EXISTS profiles CASCADE;

-- æ³¨æ„ï¼šprofiles è¡¨çš„åŠŸèƒ½å·²åˆå¹¶åˆ° users è¡¨ä¸­
-- å¦‚æœéœ€è¦ä¿ç•™é¢å¤–çš„ç”¨æˆ·èµ„æ–™å­—æ®µï¼Œå¯ä»¥åˆ›å»º user_profiles è¡¨

CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  bio TEXT,
  location VARCHAR(100),
  website VARCHAR(200),
  birthday DATE,
  gender VARCHAR(10),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT user_profiles_gender_check 
    CHECK (gender IN ('male', 'female', 'other'))
);

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_users_updated_at();
```

**ä¿®æ”¹ exam_records è¡¨**:

```sql
-- ä¿®æ”¹å¤–é”®å¼•ç”¨ï¼ˆä» auth.users æ”¹ä¸º usersï¼‰
ALTER TABLE exam_records 
  DROP CONSTRAINT IF EXISTS exam_records_user_id_fkey;

ALTER TABLE exam_records 
  ADD CONSTRAINT exam_records_user_id_fkey 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

**ä¿®æ”¹ user_settings è¡¨**:

```sql
-- ä¿®æ”¹å¤–é”®å¼•ç”¨
ALTER TABLE user_settings 
  DROP CONSTRAINT IF EXISTS user_settings_user_id_fkey;

ALTER TABLE user_settings 
  ADD CONSTRAINT user_settings_user_id_fkey 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

**ä¿®æ”¹ vip_applications è¡¨**:

```sql
-- ä¿®æ”¹å¤–é”®å¼•ç”¨
ALTER TABLE vip_applications 
  DROP CONSTRAINT IF EXISTS vip_applications_user_id_fkey;

ALTER TABLE vip_applications 
  ADD CONSTRAINT vip_applications_user_id_fkey 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE vip_applications 
  DROP CONSTRAINT IF EXISTS vip_applications_reviewed_by_fkey;

ALTER TABLE vip_applications 
  ADD CONSTRAINT vip_applications_reviewed_by_fkey 
  FOREIGN KEY (reviewed_by) REFERENCES users(id);
```

### 4.2 æ•°æ®è¿ç§»æ­¥éª¤

#### 4.2.1 ä» Supabase å¯¼å‡ºæ•°æ®

```bash
# 1. å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆä» auth.users å’Œ profilesï¼‰
supabase db dump --data-only --table=auth.users --file=supabase_users.sql

# 2. å¯¼å‡ºä¸šåŠ¡æ•°æ®
supabase db dump --data-only --table=exam_records --file=exam_records.sql
supabase db dump --data-only --table=module_scores --file=module_scores.sql
supabase db dump --data-only --table=user_settings --file=user_settings.sql
supabase db dump --data-only --table=vip_applications --file=vip_applications.sql
```

#### 4.2.2 æ•°æ®è½¬æ¢è„šæœ¬

åˆ›å»ºæ•°æ®è½¬æ¢è„šæœ¬ `migrate_users.sql`:

```sql
-- ä» Supabase auth.users è¿ç§»åˆ°æ–°çš„ users è¡¨
-- æ³¨æ„ï¼šéœ€è¦æ‰‹åŠ¨è°ƒæ•´å­—æ®µæ˜ å°„

INSERT INTO users (id, phone, nickname, avatar_url, role, created_at, updated_at)
SELECT 
  id,
  phone,  -- å¦‚æœ Supabase ä¸­å­˜å‚¨äº†æ‰‹æœºå·
  raw_user_meta_data->>'nickname' AS nickname,  -- ä»å…ƒæ•°æ®ä¸­æå–
  raw_user_meta_data->>'avatar_url' AS avatar_url,
  CASE 
    WHEN raw_user_meta_data->>'role' = 'admin' THEN 'admin'
    ELSE 'user'
  END AS role,
  created_at,
  updated_at
FROM supabase_auth_users_backup;  -- ä¸´æ—¶è¡¨ï¼Œä»å¯¼å‡ºçš„æ•°æ®åˆ›å»º
```

#### 4.2.3 å¯¼å…¥åˆ°ç™¾åº¦äº‘ RDS

```bash
# 1. è¿æ¥åˆ°ç™¾åº¦äº‘ RDS
psql -h <RDS_HOST> -U <USERNAME> -d <DATABASE_NAME>

# 2. åˆ›å»ºæ–°è¡¨ç»“æ„
\i create_new_tables.sql

# 3. å¯¼å…¥è½¬æ¢åçš„ç”¨æˆ·æ•°æ®
\i migrate_users.sql

# 4. å¯¼å…¥ä¸šåŠ¡æ•°æ®
\i exam_records.sql
\i module_scores.sql
\i user_settings.sql
\i vip_applications.sql

# 5. éªŒè¯æ•°æ®
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM exam_records;
SELECT COUNT(*) FROM module_scores;
SELECT COUNT(*) FROM user_settings;
SELECT COUNT(*) FROM vip_applications;
```

### 4.3 å®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

åˆ›å»º `baidu_cloud_database_setup.sql`:

```sql
-- ============================================================================
-- ç™¾åº¦äº‘æ•°æ®åº“å®Œæ•´åˆå§‹åŒ–è„šæœ¬
-- ============================================================================

-- ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºç”¨æˆ·ç›¸å…³è¡¨

-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) UNIQUE NOT NULL,
  nickname VARCHAR(50),
  avatar_url TEXT,
  role VARCHAR(20) NOT NULL DEFAULT 'user',
  is_vip BOOLEAN NOT NULL DEFAULT FALSE,
  vip_expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,
  
  CONSTRAINT users_role_check 
    CHECK (role IN ('user', 'admin'))
);

-- ç”¨æˆ·ä¼šè¯è¡¨
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token TEXT NOT NULL UNIQUE,
  refresh_token TEXT UNIQUE,
  expires_at TIMESTAMPTZ NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- çŸ­ä¿¡éªŒè¯ç è¡¨
CREATE TABLE sms_verification_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(6) NOT NULL,
  session_id UUID NOT NULL,
  purpose VARCHAR(20) NOT NULL,
  is_used BOOLEAN NOT NULL DEFAULT FALSE,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT sms_verification_codes_purpose_check 
    CHECK (purpose IN ('login', 'register', 'reset_password'))
);

-- ç”¨æˆ·èµ„æ–™è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE user_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  bio TEXT,
  location VARCHAR(100),
  website VARCHAR(200),
  birthday DATE,
  gender VARCHAR(10),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT user_profiles_gender_check 
    CHECK (gender IN ('male', 'female', 'other'))
);

-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ›å»ºä¸šåŠ¡è¡¨

-- è€ƒè¯•è®°å½•è¡¨
CREATE TABLE exam_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  exam_number INTEGER NOT NULL,
  total_score DECIMAL(5,2) NOT NULL,
  total_time INTEGER NOT NULL,
  exam_date DATE NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- æ¨¡å—å¾—åˆ†è¡¨
CREATE TABLE module_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  exam_record_id UUID NOT NULL REFERENCES exam_records(id) ON DELETE CASCADE,
  module_name VARCHAR(50) NOT NULL,
  parent_module VARCHAR(50),
  score DECIMAL(5,2) NOT NULL,
  total_questions INTEGER,
  correct_questions INTEGER,
  time_spent INTEGER,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ç”¨æˆ·è®¾ç½®è¡¨
CREATE TABLE user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  setting_key VARCHAR(50) NOT NULL,
  setting_value TEXT NOT NULL,
  setting_type VARCHAR(20) NOT NULL DEFAULT 'string',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(user_id, setting_key),
  CONSTRAINT user_settings_setting_type_check 
    CHECK (setting_type IN ('string', 'number', 'boolean', 'json'))
);

-- VIPç”³è¯·è®°å½•è¡¨
CREATE TABLE vip_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  user_phone VARCHAR(20) NOT NULL,
  payment_screenshot_url TEXT NOT NULL,
  transaction_number VARCHAR(100),
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  admin_note TEXT,
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT vip_applications_status_check 
    CHECK (status IN ('pending', 'approved', 'rejected'))
);

-- ç¬¬å››éƒ¨åˆ†ï¼šåˆ›å»ºç´¢å¼•

-- users è¡¨ç´¢å¼•
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_vip ON users(is_vip);

-- user_sessions è¡¨ç´¢å¼•
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_token ON user_sessions(token);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);

-- sms_verification_codes è¡¨ç´¢å¼•
CREATE INDEX idx_sms_codes_phone ON sms_verification_codes(phone);
CREATE INDEX idx_sms_codes_session_id ON sms_verification_codes(session_id);
CREATE INDEX idx_sms_codes_expires_at ON sms_verification_codes(expires_at);

-- exam_records è¡¨ç´¢å¼•
CREATE INDEX idx_exam_records_user_id ON exam_records(user_id);
CREATE INDEX idx_exam_records_exam_date ON exam_records(exam_date);
CREATE INDEX idx_exam_records_created_at ON exam_records(created_at);

-- module_scores è¡¨ç´¢å¼•
CREATE INDEX idx_module_scores_exam_record_id ON module_scores(exam_record_id);
CREATE INDEX idx_module_scores_module_name ON module_scores(module_name);

-- user_settings è¡¨ç´¢å¼•
CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);

-- vip_applications è¡¨ç´¢å¼•
CREATE INDEX idx_vip_applications_user_id ON vip_applications(user_id);
CREATE INDEX idx_vip_applications_phone ON vip_applications(user_phone);
CREATE INDEX idx_vip_applications_status ON vip_applications(status);
CREATE INDEX idx_vip_applications_created_at ON vip_applications(created_at);

-- ç¬¬äº”éƒ¨åˆ†ï¼šåˆ›å»ºè§¦å‘å™¨

-- é€šç”¨çš„ updated_at æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ä¸ºå„è¡¨åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_user_sessions_updated_at
  BEFORE UPDATE ON user_sessions
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_exam_records_updated_at
  BEFORE UPDATE ON exam_records
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_module_scores_updated_at
  BEFORE UPDATE ON module_scores
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_user_settings_updated_at
  BEFORE UPDATE ON user_settings
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_update_vip_applications_updated_at
  BEFORE UPDATE ON vip_applications
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ç¬¬å…­éƒ¨åˆ†ï¼šæ·»åŠ æ³¨é‡Š

-- users è¡¨æ³¨é‡Š
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨';
COMMENT ON COLUMN users.id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN users.phone IS 'æ‰‹æœºå·';
COMMENT ON COLUMN users.nickname IS 'æ˜µç§°';
COMMENT ON COLUMN users.avatar_url IS 'å¤´åƒURL';
COMMENT ON COLUMN users.role IS 'è§’è‰²ï¼šuser-æ™®é€šç”¨æˆ·, admin-ç®¡ç†å‘˜';
COMMENT ON COLUMN users.is_vip IS 'æ˜¯å¦VIP';
COMMENT ON COLUMN users.vip_expires_at IS 'VIPè¿‡æœŸæ—¶é—´';
COMMENT ON COLUMN users.created_at IS 'åˆ›å»ºæ—¶é—´';
COMMENT ON COLUMN users.updated_at IS 'æ›´æ–°æ—¶é—´';
COMMENT ON COLUMN users.last_login_at IS 'æœ€åç™»å½•æ—¶é—´';

-- user_sessions è¡¨æ³¨é‡Š
COMMENT ON TABLE user_sessions IS 'ç”¨æˆ·ä¼šè¯è¡¨';
COMMENT ON COLUMN user_sessions.id IS 'ä¼šè¯ID';
COMMENT ON COLUMN user_sessions.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN user_sessions.token IS 'è®¿é—®ä»¤ç‰Œï¼ˆJWTï¼‰';
COMMENT ON COLUMN user_sessions.refresh_token IS 'åˆ·æ–°ä»¤ç‰Œ';
COMMENT ON COLUMN user_sessions.expires_at IS 'è¿‡æœŸæ—¶é—´';
COMMENT ON COLUMN user_sessions.ip_address IS 'IPåœ°å€';
COMMENT ON COLUMN user_sessions.user_agent IS 'ç”¨æˆ·ä»£ç†';

-- sms_verification_codes è¡¨æ³¨é‡Š
COMMENT ON TABLE sms_verification_codes IS 'çŸ­ä¿¡éªŒè¯ç è¡¨';
COMMENT ON COLUMN sms_verification_codes.id IS 'éªŒè¯ç ID';
COMMENT ON COLUMN sms_verification_codes.phone IS 'æ‰‹æœºå·';
COMMENT ON COLUMN sms_verification_codes.code IS 'éªŒè¯ç ';
COMMENT ON COLUMN sms_verification_codes.session_id IS 'ä¼šè¯ID';
COMMENT ON COLUMN sms_verification_codes.purpose IS 'ç”¨é€”ï¼šlogin-ç™»å½•, register-æ³¨å†Œ, reset_password-é‡ç½®å¯†ç ';
COMMENT ON COLUMN sms_verification_codes.is_used IS 'æ˜¯å¦å·²ä½¿ç”¨';
COMMENT ON COLUMN sms_verification_codes.expires_at IS 'è¿‡æœŸæ—¶é—´';

-- exam_records è¡¨æ³¨é‡Š
COMMENT ON TABLE exam_records IS 'è€ƒè¯•è®°å½•è¡¨';
COMMENT ON COLUMN exam_records.id IS 'è€ƒè¯•è®°å½•ID';
COMMENT ON COLUMN exam_records.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN exam_records.exam_number IS 'è€ƒè¯•æœŸæ•°';
COMMENT ON COLUMN exam_records.total_score IS 'æ€»åˆ†';
COMMENT ON COLUMN exam_records.total_time IS 'æ€»ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰';
COMMENT ON COLUMN exam_records.exam_date IS 'è€ƒè¯•æ—¥æœŸ';

-- module_scores è¡¨æ³¨é‡Š
COMMENT ON TABLE module_scores IS 'æ¨¡å—å¾—åˆ†è¡¨';
COMMENT ON COLUMN module_scores.id IS 'æ¨¡å—å¾—åˆ†ID';
COMMENT ON COLUMN module_scores.exam_record_id IS 'è€ƒè¯•è®°å½•ID';
COMMENT ON COLUMN module_scores.module_name IS 'æ¨¡å—åç§°';
COMMENT ON COLUMN module_scores.parent_module IS 'çˆ¶æ¨¡å—åç§°';
COMMENT ON COLUMN module_scores.score IS 'å¾—åˆ†';
COMMENT ON COLUMN module_scores.total_questions IS 'æ€»é¢˜æ•°';
COMMENT ON COLUMN module_scores.correct_questions IS 'æ­£ç¡®é¢˜æ•°';
COMMENT ON COLUMN module_scores.time_spent IS 'ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰';

-- user_settings è¡¨æ³¨é‡Š
COMMENT ON TABLE user_settings IS 'ç”¨æˆ·è®¾ç½®è¡¨';
COMMENT ON COLUMN user_settings.id IS 'è®¾ç½®ID';
COMMENT ON COLUMN user_settings.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN user_settings.setting_key IS 'è®¾ç½®é”®';
COMMENT ON COLUMN user_settings.setting_value IS 'è®¾ç½®å€¼';
COMMENT ON COLUMN user_settings.setting_type IS 'è®¾ç½®ç±»å‹';

-- vip_applications è¡¨æ³¨é‡Š
COMMENT ON TABLE vip_applications IS 'VIPç”³è¯·è®°å½•è¡¨';
COMMENT ON COLUMN vip_applications.id IS 'ç”³è¯·ID';
COMMENT ON COLUMN vip_applications.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN vip_applications.user_phone IS 'ç”¨æˆ·æ‰‹æœºå·';
COMMENT ON COLUMN vip_applications.payment_screenshot_url IS 'æ”¯ä»˜æˆªå›¾URL';
COMMENT ON COLUMN vip_applications.transaction_number IS 'æµæ°´å·';
COMMENT ON COLUMN vip_applications.status IS 'ç”³è¯·çŠ¶æ€';
COMMENT ON COLUMN vip_applications.admin_note IS 'ç®¡ç†å‘˜å¤‡æ³¨';
COMMENT ON COLUMN vip_applications.reviewed_by IS 'å®¡æ ¸äººID';
COMMENT ON COLUMN vip_applications.reviewed_at IS 'å®¡æ ¸æ—¶é—´';

-- ç¬¬ä¸ƒéƒ¨åˆ†ï¼šåˆ›å»ºåˆå§‹ç®¡ç†å‘˜è´¦å·ï¼ˆå¯é€‰ï¼‰

-- æ’å…¥é»˜è®¤ç®¡ç†å‘˜ï¼ˆæ‰‹æœºå·ï¼š13800138000ï¼‰
INSERT INTO users (phone, nickname, role, is_vip, created_at, updated_at)
VALUES ('13800138000', 'ç³»ç»Ÿç®¡ç†å‘˜', 'admin', TRUE, NOW(), NOW())
ON CONFLICT (phone) DO NOTHING;
```

---

## 5. è®¤è¯ç³»ç»Ÿæ”¹é€ 

### 5.1 è®¤è¯æµç¨‹è®¾è®¡

#### 5.1.1 ç™»å½•/æ³¨å†Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
    â†“
å‘é€çŸ­ä¿¡éªŒè¯ç 
    â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    â†“
éªŒè¯éªŒè¯ç 
    â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    â”œâ”€ å­˜åœ¨ â†’ ç™»å½•
    â””â”€ ä¸å­˜åœ¨ â†’ æ³¨å†Œæ–°ç”¨æˆ·
    â†“
ç”Ÿæˆ JWT Token
    â†“
è¿”å› Token ç»™å‰ç«¯
    â†“
å‰ç«¯å­˜å‚¨ Token
```

#### 5.1.2 Token åˆ·æ–°æµç¨‹

```
Token å³å°†è¿‡æœŸ
    â†“
ä½¿ç”¨ Refresh Token è¯·æ±‚æ–° Token
    â†“
éªŒè¯ Refresh Token
    â†“
ç”Ÿæˆæ–°çš„ Access Token
    â†“
è¿”å›æ–° Token
```

### 5.2 åç«¯ API å®ç°

#### 5.2.1 é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.js          # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ jwt.js               # JWT é…ç½®
â”‚   â”‚   â””â”€â”€ sms.js               # çŸ­ä¿¡æœåŠ¡é…ç½®
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ auth.controller.js   # è®¤è¯æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ user.controller.js   # ç”¨æˆ·æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ exam.controller.js   # è€ƒè¯•æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ vip.controller.js    # VIP æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ middlewares/
â”‚   â”‚   â”œâ”€â”€ auth.middleware.js   # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ error.middleware.js  # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ validate.middleware.js # éªŒè¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.model.js        # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ session.model.js     # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ exam.model.js        # è€ƒè¯•æ¨¡å‹
â”‚   â”‚   â””â”€â”€ vip.model.js         # VIP æ¨¡å‹
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.routes.js       # è®¤è¯è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ user.routes.js       # ç”¨æˆ·è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ exam.routes.js       # è€ƒè¯•è·¯ç”±
â”‚   â”‚   â””â”€â”€ vip.routes.js        # VIP è·¯ç”±
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth.service.js      # è®¤è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ sms.service.js       # çŸ­ä¿¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ jwt.service.js       # JWT æœåŠ¡
â”‚   â”‚   â””â”€â”€ user.service.js      # ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.js            # æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ response.js          # å“åº”å·¥å…·
â”‚   â”‚   â””â”€â”€ validator.js         # éªŒè¯å·¥å…·
â”‚   â””â”€â”€ app.js                   # åº”ç”¨å…¥å£
â”œâ”€â”€ package.json
â””â”€â”€ .env
```

#### 5.2.2 æ ¸å¿ƒä»£ç å®ç°

**1. æ•°æ®åº“é…ç½® (src/config/database.js)**

```javascript
const { Pool } = require('pg');

const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT || 5432,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

module.exports = pool;
```

**2. JWT æœåŠ¡ (src/services/jwt.service.js)**

```javascript
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET;
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d';
const REFRESH_TOKEN_EXPIRES_IN = process.env.REFRESH_TOKEN_EXPIRES_IN || '30d';

class JWTService {
  // ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
  generateAccessToken(userId, role) {
    return jwt.sign(
      { userId, role },
      JWT_SECRET,
      { expiresIn: JWT_EXPIRES_IN }
    );
  }

  // ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ
  generateRefreshToken(userId) {
    return jwt.sign(
      { userId, type: 'refresh' },
      JWT_SECRET,
      { expiresIn: REFRESH_TOKEN_EXPIRES_IN }
    );
  }

  // éªŒè¯ä»¤ç‰Œ
  verifyToken(token) {
    try {
      return jwt.verify(token, JWT_SECRET);
    } catch (error) {
      throw new Error('Invalid token');
    }
  }

  // è§£ç ä»¤ç‰Œï¼ˆä¸éªŒè¯ï¼‰
  decodeToken(token) {
    return jwt.decode(token);
  }
}

module.exports = new JWTService();
```

**3. çŸ­ä¿¡æœåŠ¡ (src/services/sms.service.js)**

```javascript
const axios = require('axios');
const { v4: uuidv4 } = require('uuid');
const pool = require('../config/database');

const SMS_API_BASE_URL = process.env.SMS_API_BASE_URL;
const SMS_API_KEY = process.env.SMS_API_KEY;

class SMSService {
  // å‘é€çŸ­ä¿¡éªŒè¯ç 
  async sendVerificationCode(phone, purpose = 'login') {
    // ç”Ÿæˆ6ä½éªŒè¯ç 
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    const sessionId = uuidv4();
    const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5åˆ†é’Ÿåè¿‡æœŸ

    // ä¿å­˜éªŒè¯ç åˆ°æ•°æ®åº“
    await pool.query(
      `INSERT INTO sms_verification_codes 
       (phone, code, session_id, purpose, expires_at) 
       VALUES ($1, $2, $3, $4, $5)`,
      [phone, code, sessionId, purpose, expiresAt]
    );

    // è°ƒç”¨ç™¾åº¦äº‘çŸ­ä¿¡APIï¼ˆæ ¹æ®æ‚¨æä¾›çš„APIï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨æ‚¨æä¾›çš„éªŒè¯ç API
    // å®é™…å‘é€é€»è¾‘å¯èƒ½éœ€è¦è°ƒç”¨å‘é€æ¥å£ï¼ˆæœªåœ¨æä¾›çš„APIä¸­ï¼‰

    return { sessionId, expiresAt };
  }

  // éªŒè¯çŸ­ä¿¡éªŒè¯ç 
  async verifyCode(phone, code, sessionId) {
    // è°ƒç”¨ç™¾åº¦äº‘éªŒè¯æ¥å£
    try {
      const response = await axios.post(
        `${SMS_API_BASE_URL}/v1/code/verify_message_code`,
        {
          mobile: phone,
          code: code,
          sessionId: sessionId
        },
        {
          headers: {
            'Content-Type': 'application/json',
            'X-Gateway-Authorization': `Bearer ${SMS_API_KEY}`
          }
        }
      );

      if (response.data.status === 0) {
        // éªŒè¯æˆåŠŸï¼Œæ ‡è®°éªŒè¯ç ä¸ºå·²ä½¿ç”¨
        await pool.query(
          `UPDATE sms_verification_codes 
           SET is_used = TRUE 
           WHERE session_id = $1 AND phone = $2 AND code = $3`,
          [sessionId, phone, code]
        );
        return true;
      }

      return false;
    } catch (error) {
      console.error('éªŒè¯ç éªŒè¯å¤±è´¥:', error);
      return false;
    }
  }

  // æ¸…ç†è¿‡æœŸéªŒè¯ç 
  async cleanExpiredCodes() {
    await pool.query(
      `DELETE FROM sms_verification_codes 
       WHERE expires_at < NOW()`
    );
  }
}

module.exports = new SMSService();
```

**4. è®¤è¯æœåŠ¡ (src/services/auth.service.js)**

```javascript
const pool = require('../config/database');
const jwtService = require('./jwt.service');
const smsService = require('./sms.service');

class AuthService {
  // å‘é€éªŒè¯ç 
  async sendVerificationCode(phone) {
    // éªŒè¯æ‰‹æœºå·æ ¼å¼
    if (!/^1[3-9]\d{9}$/.test(phone)) {
      throw new Error('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
    }

    // æ£€æŸ¥å‘é€é¢‘ç‡ï¼ˆé˜²æ­¢é¢‘ç¹å‘é€ï¼‰
    const recentCode = await pool.query(
      `SELECT * FROM sms_verification_codes 
       WHERE phone = $1 AND created_at > NOW() - INTERVAL '1 minute'
       ORDER BY created_at DESC LIMIT 1`,
      [phone]
    );

    if (recentCode.rows.length > 0) {
      throw new Error('éªŒè¯ç å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
    }

    // å‘é€éªŒè¯ç 
    const result = await smsService.sendVerificationCode(phone);
    return result;
  }

  // éªŒè¯ç ç™»å½•/æ³¨å†Œ
  async loginWithCode(phone, code, sessionId, ipAddress, userAgent) {
    // éªŒè¯éªŒè¯ç 
    const isValid = await smsService.verifyCode(phone, code, sessionId);
    if (!isValid) {
      throw new Error('éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ');
    }

    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await pool.query(
      'SELECT * FROM users WHERE phone = $1',
      [phone]
    );

    if (user.rows.length === 0) {
      // åˆ›å»ºæ–°ç”¨æˆ·
      const result = await pool.query(
        `INSERT INTO users (phone, nickname, created_at, updated_at) 
         VALUES ($1, $2, NOW(), NOW()) 
         RETURNING *`,
        [phone, `ç”¨æˆ·${phone.slice(-4)}`]
      );
      user = result;
    }

    const userData = user.rows[0];

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    await pool.query(
      'UPDATE users SET last_login_at = NOW() WHERE id = $1',
      [userData.id]
    );

    // ç”Ÿæˆ Token
    const accessToken = jwtService.generateAccessToken(userData.id, userData.role);
    const refreshToken = jwtService.generateRefreshToken(userData.id);

    // ä¿å­˜ä¼šè¯
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7å¤©
    await pool.query(
      `INSERT INTO user_sessions 
       (user_id, token, refresh_token, expires_at, ip_address, user_agent) 
       VALUES ($1, $2, $3, $4, $5, $6)`,
      [userData.id, accessToken, refreshToken, expiresAt, ipAddress, userAgent]
    );

    return {
      user: {
        id: userData.id,
        phone: userData.phone,
        nickname: userData.nickname,
        avatar_url: userData.avatar_url,
        role: userData.role,
        is_vip: userData.is_vip,
        vip_expires_at: userData.vip_expires_at
      },
      accessToken,
      refreshToken,
      expiresAt
    };
  }

  // åˆ·æ–° Token
  async refreshToken(refreshToken) {
    // éªŒè¯ Refresh Token
    const decoded = jwtService.verifyToken(refreshToken);
    if (decoded.type !== 'refresh') {
      throw new Error('Invalid refresh token');
    }

    // æŸ¥æ‰¾ä¼šè¯
    const session = await pool.query(
      'SELECT * FROM user_sessions WHERE refresh_token = $1',
      [refreshToken]
    );

    if (session.rows.length === 0) {
      throw new Error('Session not found');
    }

    const sessionData = session.rows[0];

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (new Date(sessionData.expires_at) < new Date()) {
      throw new Error('Session expired');
    }

    // æŸ¥æ‰¾ç”¨æˆ·
    const user = await pool.query(
      'SELECT * FROM users WHERE id = $1',
      [decoded.userId]
    );

    if (user.rows.length === 0) {
      throw new Error('User not found');
    }

    const userData = user.rows[0];

    // ç”Ÿæˆæ–°çš„ Access Token
    const newAccessToken = jwtService.generateAccessToken(userData.id, userData.role);

    // æ›´æ–°ä¼šè¯
    await pool.query(
      'UPDATE user_sessions SET token = $1, updated_at = NOW() WHERE id = $2',
      [newAccessToken, sessionData.id]
    );

    return {
      accessToken: newAccessToken,
      refreshToken: refreshToken
    };
  }

  // ç™»å‡º
  async logout(token) {
    await pool.query(
      'DELETE FROM user_sessions WHERE token = $1',
      [token]
    );
  }

  // éªŒè¯ Token
  async verifyToken(token) {
    const decoded = jwtService.verifyToken(token);
    
    // æŸ¥æ‰¾ä¼šè¯
    const session = await pool.query(
      'SELECT * FROM user_sessions WHERE token = $1',
      [token]
    );

    if (session.rows.length === 0) {
      throw new Error('Session not found');
    }

    // æŸ¥æ‰¾ç”¨æˆ·
    const user = await pool.query(
      'SELECT * FROM users WHERE id = $1',
      [decoded.userId]
    );

    if (user.rows.length === 0) {
      throw new Error('User not found');
    }

    return user.rows[0];
  }
}

module.exports = new AuthService();
```

**5. è®¤è¯æ§åˆ¶å™¨ (src/controllers/auth.controller.js)**

```javascript
const authService = require('../services/auth.service');

class AuthController {
  // å‘é€éªŒè¯ç 
  async sendCode(req, res, next) {
    try {
      const { phone } = req.body;

      if (!phone) {
        return res.status(400).json({
          status: 1,
          msg: 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º'
        });
      }

      const result = await authService.sendVerificationCode(phone);

      res.json({
        status: 0,
        msg: 'éªŒè¯ç å‘é€æˆåŠŸ',
        data: {
          sessionId: result.sessionId,
          expiresAt: result.expiresAt
        }
      });
    } catch (error) {
      next(error);
    }
  }

  // éªŒè¯ç ç™»å½•
  async login(req, res, next) {
    try {
      const { phone, code, sessionId } = req.body;

      if (!phone || !code || !sessionId) {
        return res.status(400).json({
          status: 1,
          msg: 'å‚æ•°ä¸å®Œæ•´'
        });
      }

      const ipAddress = req.ip;
      const userAgent = req.get('User-Agent');

      const result = await authService.loginWithCode(
        phone,
        code,
        sessionId,
        ipAddress,
        userAgent
      );

      res.json({
        status: 0,
        msg: 'ç™»å½•æˆåŠŸ',
        data: result
      });
    } catch (error) {
      next(error);
    }
  }

  // åˆ·æ–° Token
  async refresh(req, res, next) {
    try {
      const { refreshToken } = req.body;

      if (!refreshToken) {
        return res.status(400).json({
          status: 1,
          msg: 'Refresh token ä¸èƒ½ä¸ºç©º'
        });
      }

      const result = await authService.refreshToken(refreshToken);

      res.json({
        status: 0,
        msg: 'Token åˆ·æ–°æˆåŠŸ',
        data: result
      });
    } catch (error) {
      next(error);
    }
  }

  // ç™»å‡º
  async logout(req, res, next) {
    try {
      const token = req.headers.authorization?.replace('Bearer ', '');

      if (!token) {
        return res.status(400).json({
          status: 1,
          msg: 'Token ä¸èƒ½ä¸ºç©º'
        });
      }

      await authService.logout(token);

      res.json({
        status: 0,
        msg: 'ç™»å‡ºæˆåŠŸ'
      });
    } catch (error) {
      next(error);
    }
  }

  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  async getCurrentUser(req, res, next) {
    try {
      res.json({
        status: 0,
        msg: 'è·å–æˆåŠŸ',
        data: req.user
      });
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new AuthController();
```

**6. è®¤è¯ä¸­é—´ä»¶ (src/middlewares/auth.middleware.js)**

```javascript
const authService = require('../services/auth.service');

async function authMiddleware(req, res, next) {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');

    if (!token) {
      return res.status(401).json({
        status: 401,
        msg: 'æœªæˆæƒï¼Œè¯·å…ˆç™»å½•'
      });
    }

    const user = await authService.verifyToken(token);
    req.user = user;
    next();
  } catch (error) {
    return res.status(401).json({
      status: 401,
      msg: 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•'
    });
  }
}

// ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶
function adminMiddleware(req, res, next) {
  if (req.user.role !== 'admin') {
    return res.status(403).json({
      status: 403,
      msg: 'æƒé™ä¸è¶³'
    });
  }
  next();
}

module.exports = {
  authMiddleware,
  adminMiddleware
};
```

**7. è®¤è¯è·¯ç”± (src/routes/auth.routes.js)**

```javascript
const express = require('express');
const router = express.Router();
const authController = require('../controllers/auth.controller');
const { authMiddleware } = require('../middlewares/auth.middleware');

// å‘é€éªŒè¯ç 
router.post('/send-code', authController.sendCode);

// éªŒè¯ç ç™»å½•
router.post('/login', authController.login);

// åˆ·æ–° Token
router.post('/refresh', authController.refresh);

// ç™»å‡º
router.post('/logout', authMiddleware, authController.logout);

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
router.get('/me', authMiddleware, authController.getCurrentUser);

module.exports = router;
```

**8. åº”ç”¨å…¥å£ (src/app.js)**

```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
require('dotenv').config();

const authRoutes = require('./routes/auth.routes');
const userRoutes = require('./routes/user.routes');
const examRoutes = require('./routes/exam.routes');
const vipRoutes = require('./routes/vip.routes');

const app = express();

// ä¸­é—´ä»¶
app.use(helmet());
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(morgan('combined'));

// è·¯ç”±
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/exams', examRoutes);
app.use('/api/vip', vipRoutes);

// é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    status: 500,
    msg: err.message || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});

module.exports = app;
```

**9. ç¯å¢ƒå˜é‡é…ç½® (.env)**

```env
# æ•°æ®åº“é…ç½®
DB_HOST=your_rds_host
DB_PORT=5432
DB_NAME=exam_analysis
DB_USER=your_db_user
DB_PASSWORD=your_db_password

# JWT é…ç½®
JWT_SECRET=your_jwt_secret_key_here_change_in_production
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# çŸ­ä¿¡æœåŠ¡é…ç½®
SMS_API_BASE_URL=https://app-7q11e4xackch-api-Xa6JZxjyqK0a-gateway.appmiaoda.com
SMS_API_KEY=your_sms_api_key

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# ç™¾åº¦äº‘ BOS é…ç½®
BOS_ACCESS_KEY_ID=your_bos_access_key_id
BOS_SECRET_ACCESS_KEY=your_bos_secret_access_key
BOS_BUCKET=exam-analysis-storage
BOS_REGION=bj
```

### 5.3 å‰ç«¯æ”¹é€ 

#### 5.3.1 åˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡ (src/contexts/AuthContext.tsx)

```typescript
import React, { createContext, useContext, useState, useEffect } from 'react';
import axios from 'axios';

interface User {
  id: string;
  phone: string;
  nickname: string;
  avatar_url?: string;
  role: 'user' | 'admin';
  is_vip: boolean;
  vip_expires_at?: string;
}

interface AuthContextType {
  user: User | null;
  loading: boolean;
  login: (phone: string, code: string, sessionId: string) => Promise<void>;
  logout: () => Promise<void>;
  sendCode: (phone: string) => Promise<{ sessionId: string; expiresAt: string }>;
  refreshToken: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // é…ç½® axios
  const api = axios.create({
    baseURL: import.meta.env.VITE_API_BASE_URL,
  });

  // è¯·æ±‚æ‹¦æˆªå™¨ï¼šæ·»åŠ  Token
  api.interceptors.request.use((config) => {
    const token = localStorage.getItem('accessToken');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  });

  // å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç† Token è¿‡æœŸ
  api.interceptors.response.use(
    (response) => response,
    async (error) => {
      const originalRequest = error.config;

      if (error.response?.status === 401 && !originalRequest._retry) {
        originalRequest._retry = true;

        try {
          await refreshToken();
          return api(originalRequest);
        } catch (refreshError) {
          // Token åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          setUser(null);
          window.location.href = '/login';
          return Promise.reject(refreshError);
        }
      }

      return Promise.reject(error);
    }
  );

  // å‘é€éªŒè¯ç 
  const sendCode = async (phone: string) => {
    const response = await api.post('/auth/send-code', { phone });
    return response.data.data;
  };

  // ç™»å½•
  const login = async (phone: string, code: string, sessionId: string) => {
    const response = await api.post('/auth/login', {
      phone,
      code,
      sessionId,
    });

    const { user, accessToken, refreshToken } = response.data.data;

    localStorage.setItem('accessToken', accessToken);
    localStorage.setItem('refreshToken', refreshToken);
    setUser(user);
  };

  // ç™»å‡º
  const logout = async () => {
    try {
      await api.post('/auth/logout');
    } catch (error) {
      console.error('Logout error:', error);
    } finally {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      setUser(null);
    }
  };

  // åˆ·æ–° Token
  const refreshToken = async () => {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) {
      throw new Error('No refresh token');
    }

    const response = await api.post('/auth/refresh', { refreshToken });
    const { accessToken } = response.data.data;

    localStorage.setItem('accessToken', accessToken);
  };

  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  const getCurrentUser = async () => {
    try {
      const response = await api.get('/auth/me');
      setUser(response.data.data);
    } catch (error) {
      console.error('Get current user error:', error);
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
    } finally {
      setLoading(false);
    }
  };

  // åˆå§‹åŒ–ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    const token = localStorage.getItem('accessToken');
    if (token) {
      getCurrentUser();
    } else {
      setLoading(false);
    }
  }, []);

  return (
    <AuthContext.Provider
      value={{
        user,
        loading,
        login,
        logout,
        sendCode,
        refreshToken,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
```

#### 5.3.2 åˆ›å»ºç™»å½•é¡µé¢ (src/pages/Login.tsx)

```typescript
import React, { useState } from 'react';
import { Form, Input, Button, message } from 'antd';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '@/contexts/AuthContext';

const Login: React.FC = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [countdown, setCountdown] = useState(0);
  const [sessionId, setSessionId] = useState('');
  const { login, sendCode } = useAuth();
  const navigate = useNavigate();

  // å‘é€éªŒè¯ç 
  const handleSendCode = async () => {
    try {
      const phone = form.getFieldValue('phone');
      if (!phone) {
        message.error('è¯·è¾“å…¥æ‰‹æœºå·');
        return;
      }

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        message.error('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
        return;
      }

      setLoading(true);
      const result = await sendCode(phone);
      setSessionId(result.sessionId);
      message.success('éªŒè¯ç å·²å‘é€');

      // å¼€å§‹å€’è®¡æ—¶
      setCountdown(60);
      const timer = setInterval(() => {
        setCountdown((prev) => {
          if (prev <= 1) {
            clearInterval(timer);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    } catch (error: any) {
      message.error(error.response?.data?.msg || 'å‘é€éªŒè¯ç å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  // ç™»å½•
  const handleLogin = async (values: { phone: string; code: string }) => {
    if (!sessionId) {
      message.error('è¯·å…ˆè·å–éªŒè¯ç ');
      return;
    }

    try {
      setLoading(true);
      await login(values.phone, values.code, sessionId);
      message.success('ç™»å½•æˆåŠŸ');
      navigate('/');
    } catch (error: any) {
      message.error(error.response?.data?.msg || 'ç™»å½•å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <h1 className="text-2xl font-bold text-center mb-6">è€ƒè¯•æˆç»©åˆ†æç³»ç»Ÿ</h1>
        <Form form={form} onFinish={handleLogin} layout="vertical">
          <Form.Item
            name="phone"
            label="æ‰‹æœºå·"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥æ‰‹æœºå·' },
              { pattern: /^1[3-9]\d{9}$/, message: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®' },
            ]}
          >
            <Input placeholder="è¯·è¾“å…¥æ‰‹æœºå·" size="large" />
          </Form.Item>

          <Form.Item
            name="code"
            label="éªŒè¯ç "
            rules={[{ required: true, message: 'è¯·è¾“å…¥éªŒè¯ç ' }]}
          >
            <div className="flex gap-2">
              <Input placeholder="è¯·è¾“å…¥éªŒè¯ç " size="large" />
              <Button
                onClick={handleSendCode}
                disabled={countdown > 0 || loading}
                size="large"
              >
                {countdown > 0 ? `${countdown}ç§’åé‡è¯•` : 'è·å–éªŒè¯ç '}
              </Button>
            </div>
          </Form.Item>

          <Form.Item>
            <Button
              type="primary"
              htmlType="submit"
              loading={loading}
              size="large"
              block
            >
              ç™»å½•/æ³¨å†Œ
            </Button>
          </Form.Item>
        </Form>

        <p className="text-center text-sm text-gray-500 mt-4">
          é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨æ³¨å†Œè´¦å·
        </p>
      </div>
    </div>
  );
};

export default Login;
```

#### 5.3.3 æ›´æ–° App.tsx

```typescript
import React from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from '@/contexts/AuthContext';
import Login from '@/pages/Login';
import Layout from '@/components/layouts/Layout';
import Dashboard from '@/pages/Dashboard';
// ... å…¶ä»–é¡µé¢å¯¼å…¥

const PrivateRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user, loading } = useAuth();

  if (loading) {
    return <div>Loading...</div>;
  }

  if (!user) {
    return <Navigate to="/login" replace />;
  }

  return <>{children}</>;
};

const App: React.FC = () => {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={<Login />} />
          <Route
            path="/*"
            element={
              <PrivateRoute>
                <Layout>
                  <Routes>
                    <Route path="/" element={<Dashboard />} />
                    {/* å…¶ä»–è·¯ç”± */}
                  </Routes>
                </Layout>
              </PrivateRoute>
            }
          />
        </Routes>
      </BrowserRouter>
    </AuthProvider>
  );
};

export default App;
```

---

## 6. API æ¥å£æ¢³ç†

### 6.1 è®¤è¯ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|------|
| å‘é€éªŒè¯ç  | POST | /api/auth/send-code | å‘é€çŸ­ä¿¡éªŒè¯ç  | å…¬å¼€ |
| ç™»å½•/æ³¨å†Œ | POST | /api/auth/login | éªŒè¯ç ç™»å½•æˆ–æ³¨å†Œ | å…¬å¼€ |
| åˆ·æ–°Token | POST | /api/auth/refresh | åˆ·æ–°è®¿é—®ä»¤ç‰Œ | å…¬å¼€ |
| ç™»å‡º | POST | /api/auth/logout | ç”¨æˆ·ç™»å‡º | éœ€è®¤è¯ |
| è·å–å½“å‰ç”¨æˆ· | GET | /api/auth/me | è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ | éœ€è®¤è¯ |

### 6.2 ç”¨æˆ·ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|------|
| è·å–ç”¨æˆ·ä¿¡æ¯ | GET | /api/users/:id | è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯ | éœ€è®¤è¯ |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | PUT | /api/users/:id | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | éœ€è®¤è¯ |
| ä¸Šä¼ å¤´åƒ | POST | /api/users/:id/avatar | ä¸Šä¼ ç”¨æˆ·å¤´åƒ | éœ€è®¤è¯ |
| è·å–ç”¨æˆ·åˆ—è¡¨ | GET | /api/users | è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | ç®¡ç†å‘˜ |

### 6.3 è€ƒè¯•ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|------|
| åˆ›å»ºè€ƒè¯•è®°å½• | POST | /api/exams | åˆ›å»ºæ–°çš„è€ƒè¯•è®°å½• | éœ€è®¤è¯ |
| è·å–è€ƒè¯•è®°å½•åˆ—è¡¨ | GET | /api/exams | è·å–ç”¨æˆ·çš„è€ƒè¯•è®°å½•åˆ—è¡¨ | éœ€è®¤è¯ |
| è·å–è€ƒè¯•è®°å½•è¯¦æƒ… | GET | /api/exams/:id | è·å–æŒ‡å®šè€ƒè¯•è®°å½•è¯¦æƒ… | éœ€è®¤è¯ |
| æ›´æ–°è€ƒè¯•è®°å½• | PUT | /api/exams/:id | æ›´æ–°è€ƒè¯•è®°å½• | éœ€è®¤è¯ |
| åˆ é™¤è€ƒè¯•è®°å½• | DELETE | /api/exams/:id | åˆ é™¤è€ƒè¯•è®°å½• | éœ€è®¤è¯ |
| è·å–ç»Ÿè®¡æ•°æ® | GET | /api/exams/stats | è·å–è€ƒè¯•ç»Ÿè®¡æ•°æ® | éœ€è®¤è¯ |

### 6.4 VIP ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|------|
| åˆ›å»ºVIPç”³è¯· | POST | /api/vip/applications | åˆ›å»ºVIPç”³è¯· | éœ€è®¤è¯ |
| è·å–VIPç”³è¯·åˆ—è¡¨ | GET | /api/vip/applications | è·å–VIPç”³è¯·åˆ—è¡¨ | ç®¡ç†å‘˜ |
| è·å–æˆ‘çš„VIPç”³è¯· | GET | /api/vip/my-applications | è·å–å½“å‰ç”¨æˆ·çš„VIPç”³è¯· | éœ€è®¤è¯ |
| å®¡æ ¸VIPç”³è¯· | PUT | /api/vip/applications/:id/review | å®¡æ ¸VIPç”³è¯· | ç®¡ç†å‘˜ |
| ä¸Šä¼ æ”¯ä»˜æˆªå›¾ | POST | /api/vip/upload-screenshot | ä¸Šä¼ æ”¯ä»˜æˆªå›¾åˆ°BOS | éœ€è®¤è¯ |

### 6.5 è®¾ç½®ç›¸å…³ API

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|------|
| è·å–ç”¨æˆ·è®¾ç½® | GET | /api/settings | è·å–ç”¨æˆ·è®¾ç½® | éœ€è®¤è¯ |
| æ›´æ–°ç”¨æˆ·è®¾ç½® | PUT | /api/settings | æ›´æ–°ç”¨æˆ·è®¾ç½® | éœ€è®¤è¯ |

---

## 7. éƒ¨ç½²æ­¥éª¤

### 7.1 å‡†å¤‡å·¥ä½œ

#### 7.1.1 æ£€æŸ¥æ¸…å•

- [ ] ç™¾åº¦äº‘è´¦å·å·²æ³¨å†Œå¹¶å®åè®¤è¯
- [ ] äº‘æœåŠ¡å™¨ BCC å·²è´­ä¹°å¹¶é…ç½®
- [ ] äº‘æ•°æ®åº“ RDS PostgreSQL å·²è´­ä¹°
- [ ] å¯¹è±¡å­˜å‚¨ BOS å·²å¼€é€š
- [ ] çŸ­ä¿¡æœåŠ¡å·²å¼€é€š
- [ ] åŸŸåå·²å¤‡æ¡ˆï¼ˆå¦‚éœ€ä½¿ç”¨åŸŸåï¼‰

#### 7.1.2 å‡†å¤‡æ–‡ä»¶

- [ ] åç«¯ä»£ç ï¼ˆNode.jsï¼‰
- [ ] å‰ç«¯ä»£ç ï¼ˆReactï¼‰
- [ ] æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
- [ ] Nginx é…ç½®æ–‡ä»¶

### 7.2 æ•°æ®åº“éƒ¨ç½²

#### 7.2.1 è¿æ¥åˆ° RDS

```bash
# ä½¿ç”¨ psql è¿æ¥
psql -h <RDS_HOST> -U <USERNAME> -d postgres

# æˆ–ä½¿ç”¨ DBeaverã€Navicat ç­‰å›¾å½¢åŒ–å·¥å…·
```

#### 7.2.2 åˆ›å»ºæ•°æ®åº“

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE exam_analysis;

-- åˆ‡æ¢åˆ°æ–°æ•°æ®åº“
\c exam_analysis
```

#### 7.2.3 æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬

```bash
# ä¸Šä¼ åˆå§‹åŒ–è„šæœ¬åˆ°æœåŠ¡å™¨
scp baidu_cloud_database_setup.sql root@<SERVER_IP>:/tmp/

# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis -f /tmp/baidu_cloud_database_setup.sql
```

#### 7.2.4 éªŒè¯æ•°æ®åº“

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
\dt

-- æ£€æŸ¥ç´¢å¼•
\di

-- æ£€æŸ¥è§¦å‘å™¨
SELECT tgname FROM pg_trigger WHERE tgrelid = 'users'::regclass;

-- æ£€æŸ¥æ•°æ®
SELECT COUNT(*) FROM users;
```

### 7.3 åç«¯éƒ¨ç½²

#### 7.3.1 è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@<SERVER_IP>
```

#### 7.3.2 å®‰è£… Node.js

```bash
# å®‰è£… Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node -v
npm -v
```

#### 7.3.3 å®‰è£… PM2

```bash
# å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰
sudo npm install -g pm2

# éªŒè¯å®‰è£…
pm2 -v
```

#### 7.3.4 éƒ¨ç½²åç«¯ä»£ç 

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /var/www/exam-analysis-api
cd /var/www/exam-analysis-api

# ä¸Šä¼ ä»£ç ï¼ˆä»æœ¬åœ°ï¼‰
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ scp
scp -r backend/* root@<SERVER_IP>:/var/www/exam-analysis-api/

# æ–¹å¼äºŒï¼šä½¿ç”¨ Git
git clone <YOUR_REPO_URL> .

# å®‰è£…ä¾èµ–
npm install --production

# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
nano .env
# ç²˜è´´ä»¥ä¸‹å†…å®¹å¹¶ä¿®æ”¹ä¸ºå®é™…å€¼ï¼š
```

```env
# æ•°æ®åº“é…ç½®
DB_HOST=<RDS_HOST>
DB_PORT=5432
DB_NAME=exam_analysis
DB_USER=<DB_USER>
DB_PASSWORD=<DB_PASSWORD>

# JWT é…ç½®
JWT_SECRET=<GENERATE_A_STRONG_SECRET>
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# çŸ­ä¿¡æœåŠ¡é…ç½®
SMS_API_BASE_URL=https://app-7q11e4xackch-api-Xa6JZxjyqK0a-gateway.appmiaoda.com
SMS_API_KEY=<YOUR_SMS_API_KEY>

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# ç™¾åº¦äº‘ BOS é…ç½®
BOS_ACCESS_KEY_ID=<YOUR_BOS_ACCESS_KEY_ID>
BOS_SECRET_ACCESS_KEY=<YOUR_BOS_SECRET_ACCESS_KEY>
BOS_BUCKET=exam-analysis-storage
BOS_REGION=bj
```

#### 7.3.5 å¯åŠ¨åç«¯æœåŠ¡

```bash
# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start src/app.js --name exam-analysis-api

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs exam-analysis-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status
```

### 7.4 å‰ç«¯éƒ¨ç½²

#### 7.4.1 æœ¬åœ°æ„å»º

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•
cd frontend

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
nano .env.production
```

```env
VITE_API_BASE_URL=http://<SERVER_IP>:3000/api
# æˆ–ä½¿ç”¨åŸŸå
# VITE_API_BASE_URL=https://api.yourdomain.com/api
```

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æ„å»ºå®Œæˆåï¼Œdist ç›®å½•åŒ…å«æ‰€æœ‰é™æ€æ–‡ä»¶
```

#### 7.4.2 ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# åˆ›å»ºå‰ç«¯ç›®å½•
ssh root@<SERVER_IP>
mkdir -p /var/www/exam-analysis-web

# ä¸Šä¼ æ„å»ºæ–‡ä»¶
scp -r dist/* root@<SERVER_IP>:/var/www/exam-analysis-web/
```

#### 7.4.3 é…ç½® Nginx

```bash
# å®‰è£… Nginx
sudo apt-get update
sudo apt-get install -y nginx

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/exam-analysis
```

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸå

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/exam-analysis-web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
```

```bash
# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/exam-analysis /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable nginx
```

#### 7.4.4 é…ç½® HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å®‰è£… Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# è·å– SSL è¯ä¹¦
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### 7.5 é…ç½®é˜²ç«å¢™

```bash
# å®‰è£… ufw
sudo apt-get install -y ufw

# å…è®¸ SSH
sudo ufw allow 22/tcp

# å…è®¸ HTTP å’Œ HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 7.6 é…ç½®å®šæ—¶ä»»åŠ¡

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡

# æ¯å°æ—¶æ¸…ç†è¿‡æœŸçš„éªŒè¯ç 
0 * * * * psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis -c "DELETE FROM sms_verification_codes WHERE expires_at < NOW();"

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ¸…ç†è¿‡æœŸçš„ä¼šè¯
0 2 * * * psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis -c "DELETE FROM user_sessions WHERE expires_at < NOW();"

# æ¯å¤©å‡Œæ™¨ 3 ç‚¹å¤‡ä»½æ•°æ®åº“
0 3 * * * pg_dump -h <RDS_HOST> -U <USERNAME> exam_analysis > /backup/exam_analysis_$(date +\%Y\%m\%d).sql
```

---

## 8. æµ‹è¯•éªŒè¯

### 8.1 åç«¯ API æµ‹è¯•

#### 8.1.1 æµ‹è¯•å‘é€éªŒè¯ç 

```bash
curl -X POST http://<SERVER_IP>:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000"}'
```

**é¢„æœŸå“åº”**:
```json
{
  "status": 0,
  "msg": "éªŒè¯ç å‘é€æˆåŠŸ",
  "data": {
    "sessionId": "uuid-here",
    "expiresAt": "2025-01-30T12:05:00.000Z"
  }
}
```

#### 8.1.2 æµ‹è¯•ç™»å½•

```bash
curl -X POST http://<SERVER_IP>:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "code": "123456",
    "sessionId": "uuid-from-previous-step"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "status": 0,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": {
      "id": "user-uuid",
      "phone": "13800138000",
      "nickname": "ç”¨æˆ·8000",
      "role": "user",
      "is_vip": false
    },
    "accessToken": "jwt-token-here",
    "refreshToken": "refresh-token-here",
    "expiresAt": "2025-02-06T12:00:00.000Z"
  }
}
```

#### 8.1.3 æµ‹è¯•è·å–å½“å‰ç”¨æˆ·

```bash
curl -X GET http://<SERVER_IP>:3000/api/auth/me \
  -H "Authorization: Bearer <ACCESS_TOKEN>"
```

**é¢„æœŸå“åº”**:
```json
{
  "status": 0,
  "msg": "è·å–æˆåŠŸ",
  "data": {
    "id": "user-uuid",
    "phone": "13800138000",
    "nickname": "ç”¨æˆ·8000",
    "role": "user",
    "is_vip": false
  }
}
```

### 8.2 å‰ç«¯åŠŸèƒ½æµ‹è¯•

#### 8.2.1 æµ‹è¯•ç™»å½•æµç¨‹

1. è®¿é—® `http://yourdomain.com/login`
2. è¾“å…¥æ‰‹æœºå·
3. ç‚¹å‡»"è·å–éªŒè¯ç "
4. è¾“å…¥éªŒè¯ç 
5. ç‚¹å‡»"ç™»å½•/æ³¨å†Œ"
6. éªŒè¯æ˜¯å¦è·³è½¬åˆ°é¦–é¡µ

#### 8.2.2 æµ‹è¯•ç”¨æˆ·ä¿¡æ¯

1. ç™»å½•åï¼ŒæŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
2. å°è¯•æ›´æ–°ç”¨æˆ·ä¿¡æ¯
3. éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ

#### 8.2.3 æµ‹è¯•è€ƒè¯•è®°å½•

1. åˆ›å»ºæ–°çš„è€ƒè¯•è®°å½•
2. æŸ¥çœ‹è€ƒè¯•è®°å½•åˆ—è¡¨
3. æŸ¥çœ‹è€ƒè¯•è®°å½•è¯¦æƒ…
4. æ›´æ–°è€ƒè¯•è®°å½•
5. åˆ é™¤è€ƒè¯•è®°å½•

#### 8.2.4 æµ‹è¯• VIP åŠŸèƒ½

1. åˆ›å»º VIP ç”³è¯·
2. ä¸Šä¼ æ”¯ä»˜æˆªå›¾
3. ç®¡ç†å‘˜å®¡æ ¸ç”³è¯·
4. éªŒè¯ VIP çŠ¶æ€æ›´æ–°

### 8.3 æ€§èƒ½æµ‹è¯•

#### 8.3.1 ä½¿ç”¨ Apache Bench æµ‹è¯•

```bash
# å®‰è£… Apache Bench
sudo apt-get install -y apache2-utils

# æµ‹è¯•ç™»å½•æ¥å£ï¼ˆ100ä¸ªè¯·æ±‚ï¼Œ10ä¸ªå¹¶å‘ï¼‰
ab -n 100 -c 10 -p login.json -T application/json http://<SERVER_IP>:3000/api/auth/login

# login.json å†…å®¹ï¼š
# {"phone": "13800138000", "code": "123456", "sessionId": "test-session-id"}
```

#### 8.3.2 ä½¿ç”¨ wrk æµ‹è¯•

```bash
# å®‰è£… wrk
sudo apt-get install -y wrk

# æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆæŒç»­ 30 ç§’ï¼Œ10 ä¸ªçº¿ç¨‹ï¼Œ100 ä¸ªè¿æ¥ï¼‰
wrk -t10 -c100 -d30s -H "Authorization: Bearer <ACCESS_TOKEN>" http://<SERVER_IP>:3000/api/auth/me
```

### 8.4 å®‰å…¨æµ‹è¯•

#### 8.4.1 æµ‹è¯• SQL æ³¨å…¥

```bash
# å°è¯• SQL æ³¨å…¥
curl -X POST http://<SERVER_IP>:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone": "13800138000 OR 1=1", "code": "123456", "sessionId": "test"}'

# é¢„æœŸï¼šåº”è¯¥è¿”å›é”™è¯¯ï¼Œä¸åº”è¯¥æˆåŠŸç™»å½•
```

#### 8.4.2 æµ‹è¯• XSS

```bash
# å°è¯• XSS æ”»å‡»
curl -X PUT http://<SERVER_IP>:3000/api/users/<USER_ID> \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"nickname": "<script>alert(\"XSS\")</script>"}'

# é¢„æœŸï¼šåº”è¯¥è¢«è½¬ä¹‰æˆ–è¿‡æ»¤
```

#### 8.4.3 æµ‹è¯•æœªæˆæƒè®¿é—®

```bash
# å°è¯•ä¸å¸¦ Token è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£
curl -X GET http://<SERVER_IP>:3000/api/auth/me

# é¢„æœŸï¼šè¿”å› 401 Unauthorized
```

---

## 9. å¸¸è§é—®é¢˜

### 9.1 æ•°æ®åº“ç›¸å…³

**Q1: è¿æ¥æ•°æ®åº“å¤±è´¥ï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. RDS çš„ç™½åå•æ˜¯å¦åŒ…å«æœåŠ¡å™¨ IP
2. æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
3. æ•°æ®åº“åç§°æ˜¯å¦æ­£ç¡®
4. ç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤ 5432ï¼‰

```bash
# æµ‹è¯•è¿æ¥
psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis
```

**Q2: è¡¨åˆ›å»ºå¤±è´¥ï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™
2. æ˜¯å¦å·²ç»å­˜åœ¨åŒåè¡¨
3. SQL è¯­æ³•æ˜¯å¦æ­£ç¡®

```sql
-- æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
\errverbose
```

**Q3: æ•°æ®è¿ç§»å¤±è´¥ï¼Ÿ**

A: 
1. æ£€æŸ¥å¤–é”®çº¦æŸ
2. æŒ‰ç…§ä¾èµ–é¡ºåºå¯¼å…¥è¡¨
3. ä¸´æ—¶ç¦ç”¨å¤–é”®çº¦æŸ

```sql
-- ç¦ç”¨å¤–é”®çº¦æŸ
SET session_replication_role = 'replica';

-- å¯¼å…¥æ•°æ®
-- ...

-- å¯ç”¨å¤–é”®çº¦æŸ
SET session_replication_role = 'origin';
```

### 9.2 è®¤è¯ç›¸å…³

**Q1: éªŒè¯ç å‘é€å¤±è´¥ï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. çŸ­ä¿¡æœåŠ¡æ˜¯å¦å¼€é€š
2. API å¯†é’¥æ˜¯å¦æ­£ç¡®
3. æ‰‹æœºå·æ ¼å¼æ˜¯å¦æ­£ç¡®
4. æ˜¯å¦è¶…è¿‡å‘é€é¢‘ç‡é™åˆ¶

**Q2: Token éªŒè¯å¤±è´¥ï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. Token æ˜¯å¦è¿‡æœŸ
2. JWT_SECRET æ˜¯å¦ä¸€è‡´
3. Token æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆBearer <token>ï¼‰

**Q3: ç™»å½•åç«‹å³é€€å‡ºï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. Token æ˜¯å¦æ­£ç¡®ä¿å­˜åˆ° localStorage
2. å‰ç«¯æ˜¯å¦æ­£ç¡®è®¾ç½® Authorization å¤´
3. åç«¯æ˜¯å¦æ­£ç¡®éªŒè¯ Token

### 9.3 éƒ¨ç½²ç›¸å…³

**Q1: Nginx 502 Bad Gatewayï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆ`pm2 status`ï¼‰
2. ç«¯å£æ˜¯å¦æ­£ç¡®
3. é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†ç«¯å£

```bash
# æŸ¥çœ‹åç«¯æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs exam-analysis-api

# é‡å¯æœåŠ¡
pm2 restart exam-analysis-api
```

**Q2: å‰ç«¯é¡µé¢ç©ºç™½ï¼Ÿ**

A: æ£€æŸ¥ï¼š
1. æ„å»ºæ˜¯å¦æˆåŠŸ
2. Nginx é…ç½®æ˜¯å¦æ­£ç¡®
3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. API åœ°å€æ˜¯å¦æ­£ç¡®

**Q3: CORS é”™è¯¯ï¼Ÿ**

A: åœ¨åç«¯æ·»åŠ  CORS é…ç½®ï¼š

```javascript
// src/app.js
const cors = require('cors');

app.use(cors({
  origin: ['http://yourdomain.com', 'https://yourdomain.com'],
  credentials: true
}));
```

### 9.4 æ€§èƒ½ç›¸å…³

**Q1: å“åº”é€Ÿåº¦æ…¢ï¼Ÿ**

A: ä¼˜åŒ–å»ºè®®ï¼š
1. æ·»åŠ æ•°æ®åº“ç´¢å¼•
2. ä½¿ç”¨ Redis ç¼“å­˜
3. å¯ç”¨ Gzip å‹ç¼©
4. ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº

**Q2: æ•°æ®åº“è¿æ¥æ± è€—å°½ï¼Ÿ**

A: è°ƒæ•´è¿æ¥æ± é…ç½®ï¼š

```javascript
// src/config/database.js
const pool = new Pool({
  // ...
  max: 50,  // å¢åŠ æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
});
```

---

## 10. é™„å½•

### 10.1 å®Œæ•´çš„ç¯å¢ƒå˜é‡æ¸…å•

**åç«¯ (.env)**:
```env
# æ•°æ®åº“é…ç½®
DB_HOST=your_rds_host
DB_PORT=5432
DB_NAME=exam_analysis
DB_USER=your_db_user
DB_PASSWORD=your_db_password

# JWT é…ç½®
JWT_SECRET=your_jwt_secret_key_here_change_in_production
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# çŸ­ä¿¡æœåŠ¡é…ç½®
SMS_API_BASE_URL=https://app-7q11e4xackch-api-Xa6JZxjyqK0a-gateway.appmiaoda.com
SMS_API_KEY=your_sms_api_key

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# ç™¾åº¦äº‘ BOS é…ç½®
BOS_ACCESS_KEY_ID=your_bos_access_key_id
BOS_SECRET_ACCESS_KEY=your_bos_secret_access_key
BOS_BUCKET=exam-analysis-storage
BOS_REGION=bj
```

**å‰ç«¯ (.env.production)**:
```env
VITE_API_BASE_URL=https://api.yourdomain.com/api
```

### 10.2 æ•°æ®åº“è¡¨å…³ç³»å›¾

```
users (ç”¨æˆ·è¡¨)
  â”œâ”€â”€ user_sessions (ç”¨æˆ·ä¼šè¯è¡¨)
  â”œâ”€â”€ user_profiles (ç”¨æˆ·èµ„æ–™è¡¨)
  â”œâ”€â”€ exam_records (è€ƒè¯•è®°å½•è¡¨)
  â”‚   â””â”€â”€ module_scores (æ¨¡å—å¾—åˆ†è¡¨)
  â”œâ”€â”€ user_settings (ç”¨æˆ·è®¾ç½®è¡¨)
  â””â”€â”€ vip_applications (VIPç”³è¯·è®°å½•è¡¨)

sms_verification_codes (çŸ­ä¿¡éªŒè¯ç è¡¨) - ç‹¬ç«‹è¡¨
```

### 10.3 API å“åº”æ ¼å¼è§„èŒƒ

**æˆåŠŸå“åº”**:
```json
{
  "status": 0,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    // æ•°æ®å†…å®¹
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "status": 1,  // æˆ–å…¶ä»–é”™è¯¯ç 
  "msg": "é”™è¯¯ä¿¡æ¯"
}
```

### 10.4 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

**æ•°æ®åº“**:
```bash
# è¿æ¥æ•°æ®åº“
psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis

# å¤‡ä»½æ•°æ®åº“
pg_dump -h <RDS_HOST> -U <USERNAME> exam_analysis > backup.sql

# æ¢å¤æ•°æ®åº“
psql -h <RDS_HOST> -U <USERNAME> -d exam_analysis < backup.sql

# æŸ¥çœ‹è¡¨ç»“æ„
\d table_name

# æŸ¥çœ‹æ‰€æœ‰è¡¨
\dt
```

**PM2**:
```bash
# å¯åŠ¨åº”ç”¨
pm2 start app.js --name exam-analysis-api

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs exam-analysis-api

# é‡å¯åº”ç”¨
pm2 restart exam-analysis-api

# åœæ­¢åº”ç”¨
pm2 stop exam-analysis-api

# åˆ é™¤åº”ç”¨
pm2 delete exam-analysis-api

# ä¿å­˜é…ç½®
pm2 save

# å¼€æœºè‡ªå¯
pm2 startup
```

**Nginx**:
```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„"å¸¸è§é—®é¢˜"éƒ¨åˆ†
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š`pm2 logs exam-analysis-api`
3. æŸ¥çœ‹ Nginx æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`
4. æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
5. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---
