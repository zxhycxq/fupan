# è·¯ç”±å®‰å…¨æŒ‡å—

## æ–‡æ¡£ç‰ˆæœ¬
- **åˆ›å»ºæ—¶é—´**: 2026-01-25 14:30
- **æœ€åæ›´æ–°**: 2026-01-25 14:30
- **ç‰ˆæœ¬å·**: v1.0.0

## ç›®å½•
1. [è·¯ç”±æ¶æ„æ¦‚è§ˆ](#è·¯ç”±æ¶æ„æ¦‚è§ˆ)
2. [è·¯ç”±åˆ†ç±»](#è·¯ç”±åˆ†ç±»)
3. [è·¯ç”±å®ˆå«æœºåˆ¶](#è·¯ç”±å®ˆå«æœºåˆ¶)
4. [è·¯ç”±é…ç½®è¯¦è§£](#è·¯ç”±é…ç½®è¯¦è§£)
5. [å®‰å…¨ç­–ç•¥](#å®‰å…¨ç­–ç•¥)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## è·¯ç”±æ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶

```
App.tsx
â”œâ”€â”€ AuthProvider (è®¤è¯ä¸Šä¸‹æ–‡)
â”‚   â””â”€â”€ RouteGuard (è·¯ç”±å®ˆå«)
â”‚       â”œâ”€â”€ Sidebar (ä¾§è¾¹æ å¯¼èˆª)
â”‚       â””â”€â”€ Routes (è·¯ç”±é…ç½®)
â”‚           â”œâ”€â”€ å…¬å¼€è·¯ç”± (æ— éœ€ç™»å½•)
â”‚           â”œâ”€â”€ å—ä¿æŠ¤è·¯ç”± (éœ€è¦ç™»å½•)
â”‚           â””â”€â”€ SmartRedirect (æ™ºèƒ½é‡å®šå‘)
```

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ App.tsx                           # åº”ç”¨å…¥å£ï¼Œé…ç½®è·¯ç”±
â”œâ”€â”€ routes.tsx                        # è·¯ç”±é…ç½®æ–‡ä»¶
â”œâ”€â”€ components/
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ RouteGuard.tsx           # è·¯ç”±å®ˆå«ç»„ä»¶
â”‚       â”œâ”€â”€ SmartRedirect.tsx        # æ™ºèƒ½é‡å®šå‘ç»„ä»¶
â”‚       â””â”€â”€ Sidebar.tsx              # ä¾§è¾¹æ å¯¼èˆªï¼ˆå«ç‚¹å‡»æ‹¦æˆªï¼‰
â””â”€â”€ contexts/
    â””â”€â”€ AuthContext.tsx              # è®¤è¯ä¸Šä¸‹æ–‡
```

---

## è·¯ç”±åˆ†ç±»

### 1. å…¬å¼€è·¯ç”±ï¼ˆPUBLIC_ROUTESï¼‰

**å®šä¹‰**: ä¸éœ€è¦ç™»å½•å³å¯è®¿é—®çš„è·¯ç”±

**åˆ—è¡¨**:
```typescript
const PUBLIC_ROUTES = [
  '/login',      // ç™»å½•é¡µé¢
  '/register',   // æ³¨å†Œé¡µé¢
  '/tools',      // å°å·¥å…·é¡µé¢
];
```

**ç‰¹ç‚¹**:
- âœ… æœªç™»å½•ç”¨æˆ·å¯ä»¥ç›´æ¥è®¿é—®
- âœ… å·²ç™»å½•ç”¨æˆ·ä¹Ÿå¯ä»¥è®¿é—®ï¼ˆé™¤äº†è®¤è¯è·¯ç”±ï¼‰
- âœ… ä¸ä¼šè§¦å‘ç™»å½•é‡å®šå‘
- âœ… ä¸éœ€è¦ token éªŒè¯

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- å…¬å¼€çš„å·¥å…·å’Œèµ„æº
- è¥é”€é¡µé¢å’Œè½åœ°é¡µ

### 2. è®¤è¯è·¯ç”±ï¼ˆAUTH_ROUTESï¼‰

**å®šä¹‰**: å·²ç™»å½•ç”¨æˆ·ä¸åº”è®¿é—®çš„è·¯ç”±ï¼ˆç™»å½•/æ³¨å†Œé¡µé¢ï¼‰

**åˆ—è¡¨**:
```typescript
const AUTH_ROUTES = [
  '/login',      // ç™»å½•é¡µé¢
  '/register',   // æ³¨å†Œé¡µé¢
];
```

**ç‰¹ç‚¹**:
- âœ… æœªç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®
- âŒ å·²ç™»å½•ç”¨æˆ·è®¿é—®æ—¶ä¼šè¢«é‡å®šå‘åˆ° `/dashboard`
- ğŸ”„ é˜²æ­¢å·²ç™»å½•ç”¨æˆ·é‡å¤ç™»å½•

**ä½¿ç”¨åœºæ™¯**:
- ç™»å½•é¡µé¢
- æ³¨å†Œé¡µé¢

### 3. å—ä¿æŠ¤è·¯ç”±ï¼ˆProtected Routesï¼‰

**å®šä¹‰**: éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è·¯ç”±ï¼ˆä¸åœ¨å…¬å¼€è·¯ç”±åˆ—è¡¨ä¸­çš„æ‰€æœ‰è·¯ç”±ï¼‰

**åˆ—è¡¨**:
```typescript
// æ‰€æœ‰ä¸åœ¨ PUBLIC_ROUTES ä¸­çš„è·¯ç”±éƒ½æ˜¯å—ä¿æŠ¤è·¯ç”±
const PROTECTED_ROUTES = [
  '/dashboard',         // æ•°æ®æ€»è§ˆ
  '/module-analysis',   // å„æ¨¡å—åˆ†æ
  '/upload',            // ä¸Šä¼ æˆç»©
  '/exams',             // è€ƒè¯•è®°å½•
  '/exam/:id',          // è€ƒè¯•è¯¦æƒ…
  '/settings',          // è®¾ç½®
  '/profile',           // ä¸ªäººä¸­å¿ƒ
  '/order-confirm',     // è®¢å•ç¡®è®¤
  '/order-detail/:orderNo', // è®¢å•è¯¦æƒ…
  '/debug',             // æ•°æ®è°ƒè¯•
  // ... å…¶ä»–éœ€è¦ç™»å½•çš„è·¯ç”±
];
```

**ç‰¹ç‚¹**:
- âŒ æœªç™»å½•ç”¨æˆ·è®¿é—®æ—¶ä¼šè¢«é‡å®šå‘åˆ° `/login`
- âœ… å·²ç™»å½•ç”¨æˆ·å¯ä»¥ç›´æ¥è®¿é—®
- ğŸ”’ éœ€è¦ token éªŒè¯
- ğŸ“ ä¼šè®°å½•åŸå§‹ç›®æ ‡è·¯å¾„ï¼Œç™»å½•åè‡ªåŠ¨è·³è½¬

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·ä¸ªäººæ•°æ®é¡µé¢
- éœ€è¦æƒé™çš„åŠŸèƒ½é¡µé¢
- æ•æ„Ÿæ“ä½œé¡µé¢

### 4. éšè—è·¯ç”±ï¼ˆHidden Routesï¼‰

**å®šä¹‰**: ä¸åœ¨ä¾§è¾¹æ å¯¼èˆªä¸­æ˜¾ç¤ºçš„è·¯ç”±

**é…ç½®**:
```typescript
{
  name: 'è€ƒè¯•è¯¦æƒ…',
  path: '/exam/:id',
  element: <ExamDetail />,
  visible: false,  // ä¸åœ¨ä¾§è¾¹æ æ˜¾ç¤º
}
```

**ç‰¹ç‚¹**:
- ğŸš« ä¸åœ¨ä¾§è¾¹æ å¯¼èˆªä¸­æ˜¾ç¤º
- âœ… å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—® URL æˆ–ç¼–ç¨‹å¼å¯¼èˆªè®¿é—®
- ğŸ”’ ä»ç„¶å—è·¯ç”±å®ˆå«ä¿æŠ¤

**ä½¿ç”¨åœºæ™¯**:
- è¯¦æƒ…é¡µé¢ï¼ˆå¦‚è€ƒè¯•è¯¦æƒ…ï¼‰
- è¾…åŠ©é¡µé¢ï¼ˆå¦‚è®¢å•ç¡®è®¤ï¼‰
- è°ƒè¯•é¡µé¢ï¼ˆå¦‚æ•°æ®è°ƒè¯•ï¼‰
- æ³•å¾‹é¡µé¢ï¼ˆå¦‚ç”¨æˆ·æ¡æ¬¾ã€éšç§åè®®ï¼‰

---

## è·¯ç”±å®ˆå«æœºåˆ¶

### RouteGuard ç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `src/components/common/RouteGuard.tsx`

**æ ¸å¿ƒé€»è¾‘**:

```typescript
export function RouteGuard({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  const location = useLocation();
  const navigate = useNavigate();

  useEffect(() => {
    // 1. ç­‰å¾…è®¤è¯çŠ¶æ€åŠ è½½å®Œæˆ
    if (loading) return;

    const isPublicRoute = PUBLIC_ROUTES.includes(location.pathname);
    const isAuthRoute = AUTH_ROUTES.includes(location.pathname);

    // 2. æœªç™»å½•ä¸”è®¿é—®å—ä¿æŠ¤è·¯ç”± â†’ é‡å®šå‘åˆ°ç™»å½•é¡µ
    if (!user && !isPublicRoute) {
      navigate('/login', { state: { from: location.pathname } });
    }

    // 3. å·²ç™»å½•ä¸”è®¿é—®è®¤è¯è·¯ç”± â†’ é‡å®šå‘åˆ°é¦–é¡µ
    if (user && isAuthRoute) {
      navigate('/dashboard');
    }
  }, [user, loading, location.pathname, navigate]);

  // 4. åŠ è½½ä¸­æ˜¾ç¤ºç©ºç™½
  if (loading) {
    return null;
  }

  return <>{children}</>;
}
```

**å·¥ä½œæµç¨‹**:

```
ç”¨æˆ·è®¿é—®è·¯ç”±
    â†“
æ£€æŸ¥è®¤è¯çŠ¶æ€æ˜¯å¦åŠ è½½å®Œæˆ
    â†“
    â”œâ”€ åŠ è½½ä¸­ â†’ æ˜¾ç¤ºç©ºç™½é¡µé¢
    â””â”€ åŠ è½½å®Œæˆ
        â†“
        â”œâ”€ æœªç™»å½•
        â”‚   â†“
        â”‚   â”œâ”€ è®¿é—®å…¬å¼€è·¯ç”± â†’ å…è®¸è®¿é—®
        â”‚   â””â”€ è®¿é—®å—ä¿æŠ¤è·¯ç”± â†’ é‡å®šå‘åˆ° /loginï¼ˆè®°å½•åŸå§‹è·¯å¾„ï¼‰
        â”‚
        â””â”€ å·²ç™»å½•
            â†“
            â”œâ”€ è®¿é—®è®¤è¯è·¯ç”± (/login, /register) â†’ é‡å®šå‘åˆ° /dashboard
            â””â”€ è®¿é—®å…¶ä»–è·¯ç”± â†’ å…è®¸è®¿é—®
```

### ä¾§è¾¹æ ç‚¹å‡»æ‹¦æˆª

**æ–‡ä»¶ä½ç½®**: `src/components/common/Sidebar.tsx`

**æ ¸å¿ƒé€»è¾‘**:

```typescript
/**
 * å¤„ç†èœå•ç‚¹å‡»
 * å¦‚æœæ˜¯å—ä¿æŠ¤è·¯ç”±ä¸”ç”¨æˆ·æœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µ
 */
const handleMenuClick = (e: React.MouseEvent, path: string) => {
  const isPublicRoute = PUBLIC_ROUTES.includes(path);
  
  // å¦‚æœæ˜¯å—ä¿æŠ¤è·¯ç”±ä¸”ç”¨æˆ·æœªç™»å½•
  if (!isPublicRoute && !user) {
    e.preventDefault();                              // é˜»æ­¢é»˜è®¤è·³è½¬
    message.info('è¯·å…ˆç™»å½•');                         // æ˜¾ç¤ºæç¤º
    navigate('/login', { state: { from: path } });   // è·³è½¬åˆ°ç™»å½•é¡µ
    setIsOpen(false);                                // å…³é—­ç§»åŠ¨ç«¯èœå•
    return;
  }
  
  // å…³é—­ç§»åŠ¨ç«¯èœå•
  setIsOpen(false);
};
```

**å·¥ä½œæµç¨‹**:

```
ç”¨æˆ·ç‚¹å‡»ä¾§è¾¹æ èœå•
    â†“
æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å¼€è·¯ç”±
    â†“
    â”œâ”€ æ˜¯å…¬å¼€è·¯ç”± â†’ å…è®¸è·³è½¬
    â””â”€ ä¸æ˜¯å…¬å¼€è·¯ç”±
        â†“
        â”œâ”€ å·²ç™»å½• â†’ å…è®¸è·³è½¬
        â””â”€ æœªç™»å½•
            â†“
            â”œâ”€ é˜»æ­¢é»˜è®¤è·³è½¬
            â”œâ”€ æ˜¾ç¤ºæç¤ºï¼š"è¯·å…ˆç™»å½•"
            â”œâ”€ è·³è½¬åˆ°ç™»å½•é¡µï¼ˆè®°å½•åŸå§‹è·¯å¾„ï¼‰
            â””â”€ å…³é—­ç§»åŠ¨ç«¯èœå•
```

### SmartRedirect ç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `src/components/common/SmartRedirect.tsx`

**æ ¸å¿ƒé€»è¾‘**:

```typescript
export function SmartRedirect() {
  const { user, loading } = useAuth();

  // ç­‰å¾…åŠ è½½å®Œæˆ
  if (loading) {
    return null;
  }

  // æ ¹æ®ç™»å½•çŠ¶æ€é‡å®šå‘
  return <Navigate to={user ? "/dashboard" : "/tools"} replace />;
}
```

**ä½¿ç”¨åœºæ™¯**:
- æ ¹è·¯å¾„ `/` çš„é‡å®šå‘
- æœªåŒ¹é…è·¯å¾„ `*` çš„é‡å®šå‘

**å·¥ä½œæµç¨‹**:

```
ç”¨æˆ·è®¿é—® / æˆ–æœªåŒ¹é…è·¯å¾„
    â†“
æ£€æŸ¥è®¤è¯çŠ¶æ€
    â†“
    â”œâ”€ å·²ç™»å½• â†’ é‡å®šå‘åˆ° /dashboard
    â””â”€ æœªç™»å½• â†’ é‡å®šå‘åˆ° /tools
```

---

## è·¯ç”±é…ç½®è¯¦è§£

### routes.tsx é…ç½®

**æ–‡ä»¶ä½ç½®**: `src/routes.tsx`

**é…ç½®ç»“æ„**:

```typescript
interface RouteConfig {
  name: string;        // è·¯ç”±åç§°ï¼ˆæ˜¾ç¤ºåœ¨ä¾§è¾¹æ ï¼‰
  path: string;        // è·¯ç”±è·¯å¾„
  element: ReactNode;  // è·¯ç”±ç»„ä»¶
  visible?: boolean;   // æ˜¯å¦åœ¨ä¾§è¾¹æ æ˜¾ç¤ºï¼ˆé»˜è®¤ trueï¼‰
}
```

**å®Œæ•´é…ç½®**:

```typescript
const routes: RouteConfig[] = [
  // ==================== è®¤è¯è·¯ç”± ====================
  {
    name: 'ç™»å½•',
    path: '/login',
    element: <Login />,
    visible: false,  // ä¸åœ¨ä¾§è¾¹æ æ˜¾ç¤º
  },
  {
    name: 'æ³¨å†Œ',
    path: '/register',
    element: <Register />,
    visible: false,
  },

  // ==================== æ³•å¾‹é¡µé¢ ====================
  {
    name: 'ç”¨æˆ·æ¡æ¬¾',
    path: '/terms',
    element: <Terms />,
    visible: false,
  },
  {
    name: 'éšç§åè®®',
    path: '/privacy',
    element: <Privacy />,
    visible: false,
  },

  // ==================== ä¸»è¦åŠŸèƒ½é¡µé¢ ====================
  {
    name: 'æ•°æ®æ€»è§ˆ',
    path: '/dashboard',
    element: <Dashboard />,
    visible: true,  // åœ¨ä¾§è¾¹æ æ˜¾ç¤º
  },
  {
    name: 'å„æ¨¡å—åˆ†æ',
    path: '/module-analysis',
    element: <ModuleAnalysis />,
    visible: true,
  },
  {
    name: 'ä¸Šä¼ æˆç»©',
    path: '/upload',
    element: <Upload />,
    visible: true,
  },
  {
    name: 'è€ƒè¯•è®°å½•',
    path: '/exams',
    element: <ExamList />,
    visible: true,
  },
  {
    name: 'å°å·¥å…·',
    path: '/tools',
    element: <Tools />,
    visible: true,
  },
  {
    name: 'è®¾ç½®',
    path: '/settings',
    element: <Settings />,
    visible: true,
  },
  {
    name: 'ä¸ªäººä¸­å¿ƒ',
    path: '/profile',
    element: <Profile />,
    visible: true,
  },

  // ==================== è¯¦æƒ…é¡µé¢ ====================
  {
    name: 'è€ƒè¯•è¯¦æƒ…',
    path: '/exam/:id',
    element: <ExamDetail />,
    visible: false,
  },

  // ==================== è®¢å•é¡µé¢ ====================
  {
    name: 'è®¢å•ç¡®è®¤',
    path: '/order-confirm',
    element: <OrderConfirm />,
    visible: false,
  },
  {
    name: 'è®¢å•è¯¦æƒ…',
    path: '/order-detail/:orderNo',
    element: <OrderDetail />,
    visible: false,
  },

  // ==================== è°ƒè¯•é¡µé¢ ====================
  {
    name: 'æ•°æ®è°ƒè¯•',
    path: '/debug',
    element: <DebugData />,
    visible: false,
  },
  {
    name: 'å­¦ä¹ å†ç¨‹æµ‹è¯•',
    path: '/test-learning-journey',
    element: <TestLearningJourney />,
    visible: false,
  },
];
```

### App.tsx è·¯ç”±æ¸²æŸ“

**æ–‡ä»¶ä½ç½®**: `src/App.tsx`

**æ ¸å¿ƒä»£ç **:

```tsx
<AuthProvider>
  <ErrorBoundary>
    <RouteGuard>
      <div className="flex h-screen overflow-hidden bg-gray-50">
        <Sidebar />
        
        <div className="flex-1 flex flex-col overflow-hidden">
          <main className="flex-1 overflow-auto pb-8 lg:pb-0">
            <Routes>
              {/* æ¸²æŸ“æ‰€æœ‰è·¯ç”± */}
              {routes.map((route, index) => (
                <Route
                  key={index}
                  path={route.path}
                  element={route.element}
                />
              ))}
              
              {/* æ ¹è·¯å¾„å’ŒæœªåŒ¹é…è·¯å¾„æ™ºèƒ½é‡å®šå‘ */}
              <Route path="/" element={<SmartRedirect />} />
              <Route path="*" element={<SmartRedirect />} />
            </Routes>
          </main>
        </div>
      </div>
    </RouteGuard>
  </ErrorBoundary>
</AuthProvider>
```

**å±‚çº§è¯´æ˜**:
1. **AuthProvider**: æä¾›è®¤è¯ä¸Šä¸‹æ–‡ï¼Œç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€
2. **ErrorBoundary**: æ•è·é”™è¯¯ï¼Œé˜²æ­¢åº”ç”¨å´©æºƒ
3. **RouteGuard**: è·¯ç”±å®ˆå«ï¼Œæ§åˆ¶è·¯ç”±è®¿é—®æƒé™
4. **Sidebar**: ä¾§è¾¹æ å¯¼èˆªï¼Œæä¾›èœå•å’Œç‚¹å‡»æ‹¦æˆª
5. **Routes**: è·¯ç”±é…ç½®ï¼Œæ¸²æŸ“å¯¹åº”çš„é¡µé¢ç»„ä»¶

---

## å®‰å…¨ç­–ç•¥

### 1. å¤šå±‚é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€å±‚ï¼šä¾§è¾¹æ ç‚¹å‡»æ‹¦æˆª                    â”‚
â”‚  - ç”¨æˆ·ä½“éªŒå±‚                            â”‚
â”‚  - å‹å¥½æç¤º                              â”‚
â”‚  - å¿«é€Ÿåé¦ˆ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒå±‚ï¼šRouteGuard è·¯ç”±å®ˆå«              â”‚
â”‚  - è·¯ç”±å±‚                                â”‚
â”‚  - å¼ºåˆ¶é‡å®šå‘                            â”‚
â”‚  - è®°å½•åŸå§‹è·¯å¾„                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰å±‚ï¼šåç«¯ API æƒé™éªŒè¯                â”‚
â”‚  - æ•°æ®å±‚                                â”‚
â”‚  - Token éªŒè¯                            â”‚
â”‚  - æƒé™æ£€æŸ¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è®¤è¯çŠ¶æ€ç®¡ç†

**AuthContext æä¾›**:
- `user`: å½“å‰ç”¨æˆ·ä¿¡æ¯
- `loading`: è®¤è¯çŠ¶æ€åŠ è½½ä¸­
- `profile`: ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
- `signIn()`: ç™»å½•æ–¹æ³•
- `signOut()`: é€€å‡ºç™»å½•æ–¹æ³•
- `signUp()`: æ³¨å†Œæ–¹æ³•

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
import { useAuth } from '@/contexts/AuthContext';

function MyComponent() {
  const { user, loading, signOut } = useAuth();

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!user) {
    return <div>è¯·å…ˆç™»å½•</div>;
  }

  return (
    <div>
      <p>æ¬¢è¿ï¼Œ{user.email}</p>
      <button onClick={signOut}>é€€å‡ºç™»å½•</button>
    </div>
  );
}
```

### 3. Token ç®¡ç†

**å­˜å‚¨ä½ç½®**: Supabase è‡ªåŠ¨ç®¡ç†ï¼ˆlocalStorageï¼‰

**è‡ªåŠ¨åˆ·æ–°**: Supabase è‡ªåŠ¨å¤„ç† token åˆ·æ–°

**å®‰å…¨æªæ–½**:
- âœ… HttpOnly Cookieï¼ˆSupabase é»˜è®¤ï¼‰
- âœ… è‡ªåŠ¨è¿‡æœŸå¤„ç†
- âœ… å®‰å…¨çš„ token å­˜å‚¨
- âœ… CSRF ä¿æŠ¤

### 4. è·¯å¾„è®°å½•ä¸æ¢å¤

**ç™»å½•å‰è®°å½•**:
```typescript
// åœ¨ RouteGuard æˆ– Sidebar ä¸­
navigate('/login', { state: { from: location.pathname } });
```

**ç™»å½•åæ¢å¤**:
```typescript
// åœ¨ Login é¡µé¢
const location = useLocation();
const from = location.state?.from || '/dashboard';

// ç™»å½•æˆåŠŸå
navigate(from, { replace: true });
```

**å·¥ä½œæµç¨‹**:

```
ç”¨æˆ·è®¿é—® /module-analysisï¼ˆæœªç™»å½•ï¼‰
    â†“
RouteGuard æ‹¦æˆª
    â†“
é‡å®šå‘åˆ° /login?from=/module-analysis
    â†“
ç”¨æˆ·ç™»å½•æˆåŠŸ
    â†“
è‡ªåŠ¨è·³è½¬åˆ° /module-analysis
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå·²ç™»å½•ç”¨æˆ·è®¿é—®å°å·¥å…·ä¼šè¢«é‡å®šå‘åˆ° dashboardï¼Ÿ

**åŸå› **: ä¹‹å‰çš„ RouteGuard é€»è¾‘ä¸­ï¼Œæ‰€æœ‰å…¬å¼€è·¯ç”±ï¼ˆåŒ…æ‹¬ `/tools`ï¼‰åœ¨å·²ç™»å½•æ—¶éƒ½ä¼šè¢«é‡å®šå‘åˆ° `/dashboard`ã€‚

**è§£å†³æ–¹æ¡ˆ**: åŒºåˆ†"å…¬å¼€è·¯ç”±"å’Œ"è®¤è¯è·¯ç”±"ï¼š

```typescript
// ä¿®æ”¹å‰
if (user && isPublicRoute) {
  navigate('/dashboard');
}

// ä¿®æ”¹å
const isAuthRoute = AUTH_ROUTES.includes(location.pathname);
if (user && isAuthRoute) {
  navigate('/dashboard');
}
```

**ç»“æœ**:
- âœ… å·²ç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®å°å·¥å…·
- âœ… å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•/æ³¨å†Œé¡µä¼šè¢«é‡å®šå‘
- âœ… æœªç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®å°å·¥å…·

### Q2: å¦‚ä½•æ·»åŠ æ–°çš„å…¬å¼€è·¯ç”±ï¼Ÿ

**æ­¥éª¤**:

1. åœ¨ `RouteGuard.tsx` ä¸­æ·»åŠ åˆ° `PUBLIC_ROUTES`ï¼š
```typescript
const PUBLIC_ROUTES = ['/login', '/register', '/tools', '/new-public-page'];
```

2. åœ¨ `Sidebar.tsx` ä¸­æ·»åŠ åˆ° `PUBLIC_ROUTES`ï¼ˆå¦‚æœéœ€è¦åœ¨ä¾§è¾¹æ æ˜¾ç¤ºï¼‰ï¼š
```typescript
const PUBLIC_ROUTES = ['/login', '/register', '/tools', '/new-public-page'];
```

3. åœ¨ `routes.tsx` ä¸­æ·»åŠ è·¯ç”±é…ç½®ï¼š
```typescript
{
  name: 'æ–°å…¬å¼€é¡µé¢',
  path: '/new-public-page',
  element: <NewPublicPage />,
  visible: true,  // å¦‚æœéœ€è¦åœ¨ä¾§è¾¹æ æ˜¾ç¤º
}
```

### Q3: å¦‚ä½•æ·»åŠ æ–°çš„å—ä¿æŠ¤è·¯ç”±ï¼Ÿ

**æ­¥éª¤**:

1. åœ¨ `routes.tsx` ä¸­æ·»åŠ è·¯ç”±é…ç½®ï¼š
```typescript
{
  name: 'æ–°åŠŸèƒ½',
  path: '/new-feature',
  element: <NewFeature />,
  visible: true,  // å¦‚æœéœ€è¦åœ¨ä¾§è¾¹æ æ˜¾ç¤º
}
```

2. **ä¸éœ€è¦**åœ¨ `RouteGuard.tsx` ä¸­æ·»åŠ ä»»ä½•é…ç½®ï¼ˆé»˜è®¤å°±æ˜¯å—ä¿æŠ¤è·¯ç”±ï¼‰

3. ç¡®ä¿åç«¯ API æœ‰ç›¸åº”çš„æƒé™éªŒè¯

### Q4: å¦‚ä½•å¤„ç†åŠ¨æ€è·¯ç”±å‚æ•°ï¼Ÿ

**ç¤ºä¾‹**: è€ƒè¯•è¯¦æƒ…é¡µ `/exam/:id`

**è·¯ç”±é…ç½®**:
```typescript
{
  name: 'è€ƒè¯•è¯¦æƒ…',
  path: '/exam/:id',
  element: <ExamDetail />,
  visible: false,
}
```

**è®¿é—®æ–¹å¼**:
```typescript
// ç¼–ç¨‹å¼å¯¼èˆª
navigate(`/exam/${examId}`);

// Link ç»„ä»¶
<Link to={`/exam/${examId}`}>æŸ¥çœ‹è¯¦æƒ…</Link>
```

**è·å–å‚æ•°**:
```typescript
import { useParams } from 'react-router-dom';

function ExamDetail() {
  const { id } = useParams();
  // ä½¿ç”¨ id è·å–è€ƒè¯•è¯¦æƒ…
}
```

### Q5: å¦‚ä½•å®ç°æƒé™åˆ†çº§ï¼ˆå¦‚ VIP åŠŸèƒ½ï¼‰ï¼Ÿ

**æ–¹æ¡ˆ**: åœ¨é¡µé¢ç»„ä»¶å†…éƒ¨è¿›è¡Œæƒé™æ£€æŸ¥

**ç¤ºä¾‹**:
```typescript
import { useVipStatus } from '@/hooks/useVipStatus';

function VipFeature() {
  const { isVip, loading } = useVipStatus();

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!isVip) {
    return (
      <div>
        <p>æ­¤åŠŸèƒ½éœ€è¦ VIP æƒé™</p>
        <button>å‡çº§ VIP</button>
      </div>
    );
  }

  return <div>VIP åŠŸèƒ½å†…å®¹</div>;
}
```

**ä¼˜åŠ¿**:
- âœ… çµæ´»çš„æƒé™æ§åˆ¶
- âœ… å¯ä»¥æ˜¾ç¤ºå‡çº§æç¤º
- âœ… ä¸å½±å“è·¯ç”±ç»“æ„

### Q6: å¦‚ä½•å¤„ç† 404 é¡µé¢ï¼Ÿ

**å½“å‰æ–¹æ¡ˆ**: ä½¿ç”¨ `SmartRedirect` æ™ºèƒ½é‡å®šå‘

```typescript
<Route path="*" element={<SmartRedirect />} />
```

**è‡ªå®šä¹‰ 404 é¡µé¢**:

1. åˆ›å»º `NotFound.tsx` ç»„ä»¶ï¼š
```typescript
export default function NotFound() {
  return (
    <div>
      <h1>404 - é¡µé¢æœªæ‰¾åˆ°</h1>
      <Link to="/">è¿”å›é¦–é¡µ</Link>
    </div>
  );
}
```

2. ä¿®æ”¹ `App.tsx`ï¼š
```typescript
<Route path="*" element={<NotFound />} />
```

---

## æœ€ä½³å®è·µ

### 1. è·¯ç”±å‘½åè§„èŒƒ

**æ¨è**:
- âœ… ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦ï¼š`/module-analysis`
- âœ… ä½¿ç”¨å¤æ•°å½¢å¼è¡¨ç¤ºåˆ—è¡¨ï¼š`/exams`
- âœ… ä½¿ç”¨å•æ•°å½¢å¼è¡¨ç¤ºè¯¦æƒ…ï¼š`/exam/:id`
- âœ… ä½¿ç”¨åŠ¨è¯è¡¨ç¤ºæ“ä½œï¼š`/order-confirm`

**ä¸æ¨è**:
- âŒ ä½¿ç”¨å¤§å†™å­—æ¯ï¼š`/ModuleAnalysis`
- âŒ ä½¿ç”¨ä¸‹åˆ’çº¿ï¼š`/module_analysis`
- âŒ ä½¿ç”¨ä¸­æ–‡ï¼š`/æ¨¡å—åˆ†æ`

### 2. è·¯ç”±ç»„ç»‡

**æŒ‰åŠŸèƒ½åˆ†ç»„**:
```typescript
// è®¤è¯ç›¸å…³
'/login', '/register'

// æ•°æ®åˆ†æç›¸å…³
'/dashboard', '/module-analysis', '/exams', '/exam/:id'

// å·¥å…·ç›¸å…³
'/tools', '/upload'

// ç”¨æˆ·ç›¸å…³
'/profile', '/settings'

// è®¢å•ç›¸å…³
'/order-confirm', '/order-detail/:orderNo'
```

### 3. æƒé™æ£€æŸ¥

**å¤šå±‚æ£€æŸ¥**:
```typescript
// 1. è·¯ç”±å±‚ï¼ˆRouteGuardï¼‰
if (!user && !isPublicRoute) {
  navigate('/login');
}

// 2. ç»„ä»¶å±‚ï¼ˆé¡µé¢ç»„ä»¶ï¼‰
if (!user) {
  return <div>è¯·å…ˆç™»å½•</div>;
}

// 3. åŠŸèƒ½å±‚ï¼ˆVIP åŠŸèƒ½ï¼‰
if (!isVip) {
  return <div>éœ€è¦ VIP æƒé™</div>;
}

// 4. API å±‚ï¼ˆåç«¯éªŒè¯ï¼‰
// åç«¯å¿…é¡»éªŒè¯ token å’Œæƒé™
```

### 4. é”™è¯¯å¤„ç†

**è·¯ç”±é”™è¯¯**:
```typescript
<ErrorBoundary>
  <RouteGuard>
    <Routes>
      {/* è·¯ç”±é…ç½® */}
    </Routes>
  </RouteGuard>
</ErrorBoundary>
```

**è®¤è¯é”™è¯¯**:
```typescript
try {
  await signIn(email, password);
  navigate(from);
} catch (error) {
  message.error('ç™»å½•å¤±è´¥ï¼š' + error.message);
}
```

### 5. æ€§èƒ½ä¼˜åŒ–

**æ‡’åŠ è½½è·¯ç”±**:
```typescript
import { lazy, Suspense } from 'react';

const Dashboard = lazy(() => import('./pages/Dashboard'));

// ä½¿ç”¨
<Suspense fallback={<div>åŠ è½½ä¸­...</div>}>
  <Dashboard />
</Suspense>
```

**é¢„åŠ è½½å…³é”®è·¯ç”±**:
```typescript
// åœ¨ç”¨æˆ·ç™»å½•åé¢„åŠ è½½ Dashboard
import('./pages/Dashboard');
```

### 6. æµ‹è¯•å»ºè®®

**è·¯ç”±æµ‹è¯•**:
```typescript
describe('RouteGuard', () => {
  it('æœªç™»å½•ç”¨æˆ·è®¿é—®å—ä¿æŠ¤è·¯ç”±åº”é‡å®šå‘åˆ°ç™»å½•é¡µ', () => {
    // æµ‹è¯•ä»£ç 
  });

  it('å·²ç™»å½•ç”¨æˆ·è®¿é—®è®¤è¯è·¯ç”±åº”é‡å®šå‘åˆ°é¦–é¡µ', () => {
    // æµ‹è¯•ä»£ç 
  });

  it('å·²ç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®å°å·¥å…·', () => {
    // æµ‹è¯•ä»£ç 
  });
});
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ

- [ ] æ‰€æœ‰å—ä¿æŠ¤è·¯ç”±éƒ½æœ‰ RouteGuard ä¿æŠ¤
- [ ] æ‰€æœ‰å…¬å¼€è·¯ç”±éƒ½åœ¨ PUBLIC_ROUTES åˆ—è¡¨ä¸­
- [ ] æ‰€æœ‰è®¤è¯è·¯ç”±éƒ½åœ¨ AUTH_ROUTES åˆ—è¡¨ä¸­
- [ ] ä¾§è¾¹æ ç‚¹å‡»æ‹¦æˆªé€»è¾‘æ­£ç¡®
- [ ] SmartRedirect é€»è¾‘æ­£ç¡®
- [ ] è·¯ç”±é…ç½®å®Œæ•´ä¸”æ­£ç¡®
- [ ] åŠ¨æ€è·¯ç”±å‚æ•°å¤„ç†æ­£ç¡®
- [ ] 404 é¡µé¢å¤„ç†æ­£ç¡®

### æµ‹è¯•é˜¶æ®µ

- [ ] æœªç™»å½•ç”¨æˆ·è®¿é—®å…¬å¼€è·¯ç”±æ­£å¸¸
- [ ] æœªç™»å½•ç”¨æˆ·è®¿é—®å—ä¿æŠ¤è·¯ç”±è¢«é‡å®šå‘
- [ ] å·²ç™»å½•ç”¨æˆ·è®¿é—®æ‰€æœ‰è·¯ç”±æ­£å¸¸
- [ ] å·²ç™»å½•ç”¨æˆ·è®¿é—®è®¤è¯è·¯ç”±è¢«é‡å®šå‘
- [ ] ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°åŸå§‹ç›®æ ‡è·¯å¾„
- [ ] ä¾§è¾¹æ ç‚¹å‡»æ‹¦æˆªæ­£å¸¸å·¥ä½œ
- [ ] ç§»åŠ¨ç«¯èœå•æ­£å¸¸å·¥ä½œ
- [ ] è·¯ç”±å‚æ•°ä¼ é€’æ­£ç¡®

### ä¸Šçº¿å‰

- [ ] æ‰€æœ‰è·¯ç”±éƒ½ç»è¿‡å®‰å…¨å®¡æŸ¥
- [ ] åç«¯ API æƒé™éªŒè¯å®Œæ•´
- [ ] Token ç®¡ç†æœºåˆ¶æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ€§èƒ½ä¼˜åŒ–å®Œæˆ
- [ ] ç”¨æˆ·ä½“éªŒæµç•…
- [ ] æ–‡æ¡£æ›´æ–°å®Œæ•´

---

## æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

1. **å¤šå±‚é˜²æŠ¤**: å‰ç«¯è·¯ç”±å®ˆå« + åç«¯ API éªŒè¯
2. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„æç¤º + è‡ªåŠ¨è·³è½¬
3. **å®‰å…¨ç¬¬ä¸€**: ä¸¥æ ¼çš„æƒé™æ§åˆ¶ + Token ç®¡ç†
4. **çµæ´»æ‰©å±•**: æ˜“äºæ·»åŠ æ–°è·¯ç”±å’Œæƒé™

### å…³é”®ç»„ä»¶

- **RouteGuard**: è·¯ç”±å®ˆå«ï¼Œæ§åˆ¶è·¯ç”±è®¿é—®æƒé™
- **Sidebar**: ä¾§è¾¹æ å¯¼èˆªï¼Œæä¾›ç‚¹å‡»æ‹¦æˆª
- **SmartRedirect**: æ™ºèƒ½é‡å®šå‘ï¼Œæ ¹æ®ç™»å½•çŠ¶æ€è·³è½¬
- **AuthContext**: è®¤è¯ä¸Šä¸‹æ–‡ï¼Œç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€

### è·¯ç”±åˆ†ç±»

- **å…¬å¼€è·¯ç”±**: `/login`, `/register`, `/tools`
- **è®¤è¯è·¯ç”±**: `/login`, `/register`
- **å—ä¿æŠ¤è·¯ç”±**: å…¶ä»–æ‰€æœ‰è·¯ç”±

### å®‰å…¨ç­–ç•¥

- **å‰ç«¯**: è·¯ç”±å®ˆå« + ç‚¹å‡»æ‹¦æˆª
- **åç«¯**: Token éªŒè¯ + æƒé™æ£€æŸ¥
- **ç”¨æˆ·ä½“éªŒ**: å‹å¥½æç¤º + è‡ªåŠ¨è·³è½¬
