# 数据总览页面优化说明

## 概述

本次优化主要解决了三个问题：
1. 安卓手机横屏表格无法滑动的问题
2. 模块平均正确率图表添加目标正确率折线（每个模块独立的目标值）
3. 总分趋势图添加最大值和最小值标记点（使用markPoint而不是markLine）

## 详细说明

### 1. 修复安卓手机横屏表格滑动问题

#### 问题描述
- 在安卓手机上使用横屏查看表格时，虽然有滚动条，但无法滑动查看数据
- iOS设备上没有这个问题

#### 原因分析
- 横屏弹窗使用了CSS transform旋转，导致滚动事件处理异常
- 表格容器的滚动属性配置不当
- 缺少移动端滚动优化属性

#### 解决方案

##### 1.1 优化外层容器滚动
```tsx
<div 
  className="w-full h-full p-4"
  style={{
    overflow: 'auto',
    WebkitOverflowScrolling: 'touch', // iOS平滑滚动
    overscrollBehavior: 'contain', // 防止滚动穿透
  }}
>
```

**关键属性说明：**
- `overflow: 'auto'` - 启用滚动
- `WebkitOverflowScrolling: 'touch'` - iOS惯性滚动，提供原生般的滚动体验
- `overscrollBehavior: 'contain'` - 防止滚动链，避免滚动穿透到父容器

##### 1.2 优化表格容器滚动
```tsx
<div 
  className="h-[calc(100%-60px)]"
  style={{
    overflow: 'auto',
    WebkitOverflowScrolling: 'touch',
    overscrollBehavior: 'contain',
  }}
>
  <Table
    scroll={{ 
      x: 'max-content',
      y: undefined, // 移除y轴滚动，使用外层容器滚动
    }}
  />
</div>
```

**关键改进：**
- 移除Table组件的y轴滚动配置
- 使用外层div控制滚动
- 添加移动端滚动优化属性

#### 效果
- ✅ 安卓手机横屏表格可以正常滑动
- ✅ iOS手机横屏表格保持平滑滚动
- ✅ 滚动体验流畅，无卡顿
- ✅ 防止滚动穿透，不会影响其他元素

---

### 2. 模块平均正确率图表添加目标正确率折线

#### 需求描述
在模块平均正确率柱状图中，添加用户设置的目标正确率作为参考线，使用折线图展示。**每个模块可以有不同的目标正确率**。

#### 实现方案

##### 2.1 获取目标正确率设置（按模块映射）
```tsx
// 从用户设置中获取目标正确率，按模块映射
const targetAccuracyMap = useMemo(() => {
  const map = new Map<string, number>();
  userSettings.forEach(setting => {
    if (setting.module_name && setting.target_accuracy) {
      map.set(setting.module_name, setting.target_accuracy);
    }
  });
  return map;
}, [userSettings]);

// 检查是否有任何模块设置了目标正确率
const hasTargetAccuracy = targetAccuracyMap.size > 0;
```

**说明：**
- 使用useMemo优化性能，避免重复计算
- 创建Map结构，按模块名映射目标正确率
- **每个模块可以有不同的目标正确率**
- 如果没有任何模块设置目标，hasTargetAccuracy为false

##### 2.2 配置图表series（每个模块独立的目标值）
```tsx
series: [
  {
    name: '实际正确率',
    type: 'bar',
    data: filteredModuleAvgScores.map(m => m.avg_accuracy),
    itemStyle: {
      color: (params: any) => {
        const value = params.value;
        if (value >= 80) return '#52C41A'; // 绿色
        if (value >= 60) return '#1890FF'; // 蓝色
        return '#FF7A45'; // 橙色
      },
    },
  },
  // 添加目标正确率折线（如果设置了目标正确率）
  ...(hasTargetAccuracy ? [{
    name: '目标正确率',
    type: 'line',
    data: filteredModuleAvgScores.map(m => {
      // 获取该模块的目标正确率，如果没有设置则返回null
      return targetAccuracyMap.get(m.module_name) || null;
    }),
    smooth: true,
    connectNulls: false, // 不连接null值，未设置目标的模块不显示
    itemStyle: {
      color: '#FF4D4F', // 红色
    },
    lineStyle: {
      type: 'dashed', // 虚线
      width: 2,
      color: '#FF4D4F',
    },
    symbol: 'circle',
    symbolSize: 6,
  }] : []),
]
```

**样式说明：**
- **实际正确率**：柱状图，根据分数显示不同颜色
  - ≥80分：绿色(#52C41A)
  - 60-79分：蓝色(#1890FF)
  - <60分：橙色(#FF7A45)
- **目标正确率**：折线图，红色虚线
  - 颜色：红色(#FF4D4F)
  - 线型：虚线(dashed)
  - 线宽：2px
  - 标记：圆形，大小6px
  - **重要**：每个模块显示自己的目标值，不是统一的值
  - **重要**：未设置目标的模块返回null，不显示标记点
  - **重要**：connectNulls: false，不连接null值，折线会断开

##### 2.3 更新图例和提示框
```tsx
legend: {
  data: hasTargetAccuracy ? ['实际正确率', '目标正确率'] : ['实际正确率'],
  top: 30,
  textStyle: {
    fontSize: isMobile ? 10 : 12,
  },
},
tooltip: {
  trigger: 'axis',
  axisPointer: {
    type: 'cross', // 十字准星
  },
  formatter: (params: any) => {
    if (!params || params.length === 0) return '';
    let result = `${params[0].axisValue}<br/>`;
    params.forEach((param: any) => {
      if (param.value !== null && param.value !== undefined) {
        result += `${param.marker}${param.seriesName}: ${param.value.toFixed(2)}%<br/>`;
      }
    });
    return result;
  },
}
```

**改进说明：**
- 图例根据是否设置目标正确率动态显示
- 提示框使用十字准星，更容易对比数据
- 提示框同时显示实际正确率和目标正确率
- 只显示非null的数据值

#### 效果展示

**未设置目标正确率：**
- 只显示柱状图
- 图例只显示"实际正确率"

**设置了目标正确率：**
- 柱状图 + 折线图
- 图例显示"实际正确率"和"目标正确率"
- 红色虚线清晰标识目标值
- **每个模块的目标值可以不同**，折线会有起伏
- 未设置目标的模块不显示标记点，折线会断开
- 可以直观对比实际表现与目标的差距

#### 使用场景
- 用户在设置页面为每个模块设置不同的目标正确率
  - 例如：政治理论80%、常识判断60%、言语理解80%、数量关系40%等
- 在数据总览页面查看各模块的实际正确率
- 红色虚线显示各模块的目标正确率
- **折线会根据各模块目标值变化，不是一条直线**
- 快速识别哪些模块达到目标，哪些需要加强

---

### 3. 总分趋势图添加最大值和最小值标记

#### 需求描述
在总分趋势图中添加最高分和最低分的标记点（不是横线），方便快速了解成绩波动范围。

#### 实现方案

##### 3.1 添加markPoint配置
```tsx
{
  name: '我的成绩',
  type: 'line',
  data: filteredExamRecords.map(r => r.total_score),
  // ... 其他配置
  
  // 添加最大值和最小值标记点
  markPoint: {
    data: [
      {
        type: 'max', // 自动找到最大值数据点
        name: '最高分',
        label: {
          formatter: (params: any) => `最高\n${params.value.toFixed(2)}`,
          fontSize: isMobile ? 10 : 12,
          color: '#fff', // 白色文字
        },
        itemStyle: {
          color: '#52C41A', // 绿色标记点
        },
      },
      {
        type: 'min', // 自动找到最小值数据点
        name: '最低分',
        label: {
          formatter: (params: any) => `最低\n${params.value.toFixed(2)}`,
          fontSize: isMobile ? 10 : 12,
          color: '#fff', // 白色文字
        },
        itemStyle: {
          color: '#FF4D4F', // 红色标记点
        },
      },
    ],
    symbolSize: isMobile ? 50 : 60, // 响应式大小
  },
}
```

##### 3.2 配置说明

**markPoint属性：**
- `type: 'max'` - ECharts自动找到数据中的最大值点
- `type: 'min'` - ECharts自动找到数据中的最小值点
- `label.formatter` - 自定义标签格式，使用`\n`换行显示"最高"和分数
- `label.color: '#fff'` - 白色文字，在彩色标记点上清晰可见
- `itemStyle.color` - 标记点的背景颜色
- `symbolSize` - 标记点大小，响应式设计

**与markLine的区别：**
- **markLine**：显示横线，标记某个y轴值（不符合需求）
- **markPoint**：显示标记点，标记某个数据点（符合需求）
- 本需求使用markPoint，在最高分和最低分的数据点上显示圆形标记

**标签格式：**
- 使用`\n`换行符分隔文字和数值
- 第一行：最高/最低
- 第二行：具体分数（保留2位小数）
- 白色文字在彩色背景上清晰可见

**颜色方案：**
- 最高分：绿色(#52C41A) - 表示成功、优秀
- 最低分：红色(#FF4D4F) - 表示警示、需要改进

**响应式设计：**
- 移动端：标记点50px，字体10px
- 桌面端：标记点60px，字体12px
- 确保在不同设备上都清晰可读

#### 效果展示

**图表显示：**
- 蓝色折线：我的成绩趋势，带渐变填充
- 绿色虚线：平均分趋势
- 绿色圆形标记点：最高分，显示在最高分的数据点上
- 红色圆形标记点：最低分，显示在最低分的数据点上

**标签显示：**
- 最高分标签：绿色圆形标记点，白色文字，显示"最高"和分数
- 最低分标签：红色圆形标记点，白色文字，显示"最低"和分数
- 标签位置在标记点中心，清晰可见

**参考示例：**
- ECharts官方示例：Temperature Change in the Coming Week
- 使用markPoint在数据点上显示标记
- 不是使用markLine显示横线

#### 使用场景
- 快速了解成绩的波动范围
- 识别最好和最差的考试表现
- 评估进步空间和稳定性
- 设定合理的目标分数

---

## 技术要点

### 1. 移动端滚动优化

#### WebkitOverflowScrolling
```css
-webkit-overflow-scrolling: touch;
```
- iOS特有属性
- 启用硬件加速
- 提供原生般的惯性滚动
- 提升滚动流畅度

#### overscrollBehavior
```css
overscroll-behavior: contain;
```
- CSS标准属性
- 防止滚动链（scroll chaining）
- 避免滚动穿透到父容器
- 提升用户体验

### 2. ECharts配置技巧

#### markPoint自动计算
```javascript
markPoint: {
  data: [
    { type: 'max' }, // 自动找到最大值数据点
    { type: 'min' }, // 自动找到最小值数据点
  ]
}
```

**优势：**
- 不需要手动计算最大值和最小值
- ECharts会自动找到对应的数据点
- 数据更新时自动重新计算
- 代码简洁，易于维护

**自定义样式：**
```javascript
{
  type: 'max',
  itemStyle: { color: '#52C41A' }, // 标记点颜色
  label: { 
    color: '#fff', // 标签文字颜色
    formatter: (params) => `最高\n${params.value.toFixed(2)}` // 标签格式
  },
}
```

#### 按模块映射目标正确率
```javascript
const targetAccuracyMap = useMemo(() => {
  const map = new Map<string, number>();
  userSettings.forEach(setting => {
    if (setting.module_name && setting.target_accuracy) {
      map.set(setting.module_name, setting.target_accuracy);
    }
  });
  return map;
}, [userSettings]);

// 使用时
data: filteredModuleAvgScores.map(m => {
  return targetAccuracyMap.get(m.module_name) || null;
})
```

**优势：**
- 每个模块有独立的目标正确率
- 使用Map结构快速查找
- 未设置目标的模块返回null
- 折线会根据各模块目标值变化

### 3. 条件渲染series

**语法：**
```javascript
series: [
  // 基础series
  { ... },
  // 条件series
  ...(condition ? [{ ... }] : []),
]
```

**优势：**
- 根据数据动态显示图表元素
- 代码简洁，逻辑清晰
- 易于扩展和维护

### 4. 性能优化

**useMemo缓存：**
```javascript
const targetAccuracyMap = useMemo(() => {
  // 计算逻辑
}, [userSettings]);
```

**优势：**
- 避免重复计算
- 只在依赖项变化时重新计算
- 提升组件性能

---

## 测试建议

### 1. 横屏表格滑动测试

#### 测试设备
- ✅ 安卓手机（多个品牌和型号）
- ✅ iOS手机（iPhone多个型号）
- ✅ 平板设备

#### 测试步骤
1. 打开数据总览页面
2. 滚动到底部的详细数据表格
3. 点击"横屏查看"按钮
4. 尝试上下滑动表格
5. 尝试左右滑动表格
6. 检查滚动是否流畅
7. 检查是否有滚动穿透

#### 预期结果
- 表格可以正常上下滑动
- 表格可以正常左右滑动
- 滚动流畅，无卡顿
- 无滚动穿透现象
- 滚动条正常显示

### 2. 目标正确率折线测试

#### 测试场景

**场景1：未设置目标正确率**
1. 确保用户设置中没有目标正确率
2. 查看模块平均正确率图表
3. 预期：只显示柱状图，无折线

**场景2：所有模块设置相同的目标正确率**
1. 在设置页面为所有模块设置相同的目标正确率（如80%）
2. 查看模块平均正确率图表
3. 预期：
   - 显示柱状图和红色虚线
   - 折线是一条直线（因为所有模块目标相同）
   - 图例显示"实际正确率"和"目标正确率"

**场景3：不同模块设置不同的目标正确率**
1. 在设置页面为不同模块设置不同的目标正确率
   - 例如：政治理论80%、常识判断60%、言语理解80%、数量关系40%
2. 查看模块平均正确率图表
3. 预期：
   - 显示柱状图和红色虚线
   - **折线会有起伏**，根据各模块目标值变化
   - 鼠标悬停显示两种数据
   - 红色虚线清晰可见

**场景4：部分模块设置目标正确率**
1. 只为部分模块设置目标正确率
2. 查看模块平均正确率图表
3. 预期：
   - 设置了目标的模块显示标记点
   - 未设置目标的模块不显示标记点
   - 折线会断开（connectNulls: false）

#### 测试数据
- 目标正确率：40%, 60%, 70%, 80%, 90%
- 实际正确率：各种分布情况
- 模块数量：1个、5个、10个

### 3. 最大值最小值标记测试

#### 测试场景

**场景1：正常数据**
- 考试次数：5次以上
- 分数分布：有明显的高低差异
- 预期：
  - 绿色圆形标记点在最高分数据点上
  - 红色圆形标记点在最低分数据点上
  - 标签显示准确的分数
  - 标记点清晰可见

**场景2：相同分数**
- 所有考试分数相同
- 预期：
  - 最高分和最低分标记点重叠
  - 标签可能重叠，但不影响阅读

**场景3：只有一次考试**
- 只有1次考试记录
- 预期：
  - 最高分和最低分是同一个点
  - 标记点正常显示

**场景4：多次考试，分数波动大**
- 考试次数：10次以上
- 分数波动：最高90分，最低50分
- 预期：
  - 标记点位置准确
  - 标签清晰可读
  - 不遮挡其他数据点

#### 测试数据
- 分数范围：0-100分
- 考试次数：1次、5次、10次、20次
- 分数分布：递增、递减、波动、稳定

### 4. 移动端和桌面端测试

#### 移动端
- 屏幕尺寸：小屏(320px)、中屏(375px)、大屏(414px)
- 方向：竖屏、横屏
- 浏览器：Chrome、Safari、Firefox

#### 桌面端
- 屏幕尺寸：1366px、1920px、2560px
- 浏览器：Chrome、Firefox、Safari、Edge

#### 测试要点
- 字体大小是否合适
- 图表是否完整显示
- 标签是否清晰可读
- 交互是否流畅
- 标记点大小是否合适

---

## 常见问题

### Q1: 为什么安卓手机横屏表格无法滑动？

**A:** 这是因为横屏弹窗使用了CSS transform旋转，导致滚动事件处理异常。解决方案是：
1. 使用外层容器控制滚动
2. 添加移动端滚动优化属性
3. 移除Table组件的y轴滚动配置

### Q2: 目标正确率折线为什么是一条直线？

**A:** 这是因为所有模块设置了相同的目标正确率。解决方案：
1. 在设置页面为不同模块设置不同的目标正确率
2. 例如：政治理论80%、常识判断60%、言语理解80%、数量关系40%
3. 折线会根据各模块目标值变化，不再是直线

### Q3: 为什么有些模块没有显示目标正确率标记点？

**A:** 这是正常现象，因为这些模块没有设置目标正确率。解决方案：
1. 在设置页面为这些模块设置目标正确率
2. 设置后刷新页面，标记点会显示
3. 如果不想设置，可以保持现状，不影响其他模块

### Q4: 最大值最小值标记重叠怎么办？

**A:** 这是正常现象，当所有分数相同或只有一次考试时会出现。可以通过以下方式优化：
1. 调整标签位置
2. 使用不同的标签方向
3. 添加标签背景色
4. 当数据相同时只显示一个标记

### Q5: 移动端字体太小看不清怎么办？

**A:** 代码已经做了响应式处理：
- 移动端：标记点50px，字体10px
- 桌面端：标记点60px，字体12px

如果还是觉得小，可以调整isMobile判断条件或增加字体大小和标记点大小。

### Q6: 为什么使用markPoint而不是markLine？

**A:** 根据需求和参考示例：
- **需求**：在最高分和最低分的数据点上显示标记
- **markLine**：显示横线，标记某个y轴值
- **markPoint**：显示标记点，标记某个数据点
- **参考**：ECharts官方示例"Temperature Change in the Coming Week"使用markPoint
- **结论**：使用markPoint符合需求

---

## 后续优化建议

### 1. 表格滚动
- 添加滚动位置记忆功能
- 支持快速跳转到指定考试
- 添加滚动到顶部/底部按钮

### 2. 目标正确率
- 支持批量设置目标正确率
- 添加目标达成率统计
- 提供目标设置建议（基于历史数据）
- 支持目标正确率的趋势分析

### 3. 最大值最小值
- 添加平均值标记点
- 支持自定义标记点
- 添加趋势分析
- 支持标记点点击查看详情

### 4. 性能优化
- 使用虚拟滚动处理大量数据
- 优化图表渲染性能
- 减少不必要的重新渲染
- 使用Web Worker处理数据计算

### 5. 用户体验
- 添加图表导出功能
- 支持图表放大查看
- 添加数据对比功能
- 支持自定义图表配置

---

## 总结

本次优化主要解决了三个核心问题：

1. **移动端体验** - 修复了安卓手机横屏表格滑动问题，提升了移动端用户体验
2. **数据对比** - 添加了目标正确率折线，**每个模块可以有不同的目标值**，方便用户对比实际表现与目标
3. **数据洞察** - 添加了最大值最小值标记点（使用markPoint），帮助用户快速了解成绩波动

所有改进都考虑了：
- ✅ 移动端和桌面端兼容性
- ✅ 响应式设计
- ✅ 性能优化
- ✅ 用户体验
- ✅ 代码可维护性

**重要改进：**
- ✅ 目标正确率折线不再是一条直线，会根据各模块目标值变化
- ✅ 最大值最小值使用标记点而不是横线，符合需求
- ✅ 安卓手机横屏表格可以正常滑动

这些优化让数据总览页面更加实用和友好，帮助用户更好地分析和理解自己的学习情况。
